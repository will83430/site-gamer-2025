<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©ploiement - Site Gamer 2025</title>
    <link rel="stylesheet" href="wiki-styles.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f1e; color: #e0e0e0; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 50px 20px; text-align: center; box-shadow: 0 5px 30px rgba(102, 126, 234, 0.4); }
        .header h1 { font-size: 3em; color: white; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .nav { background: rgba(102, 126, 234, 0.1); padding: 15px 20px; border-bottom: 1px solid #667eea; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .nav a { color: #667eea; text-decoration: none; margin-right: 25px; transition: all 0.3s; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
        .nav a:hover { color: #764ba2; transform: translateY(-2px); }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .section { margin-bottom: 50px; background: linear-gradient(145deg, #2a2a40, #1f1f35); border: 2px solid #667eea; border-radius: 15px; padding: 30px; }
        .section h2 { color: #667eea; margin-bottom: 20px; font-size: 2em; }
        .section h3 { color: #2ecc71; margin: 25px 0 15px; font-size: 1.4em; }
        .step { background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .step-number { display: inline-block; background: #667eea; color: white; width: 35px; height: 35px; border-radius: 50%; text-align: center; line-height: 35px; font-weight: 700; margin-right: 10px; }
        code { background: rgba(102, 126, 234, 0.2); padding: 3px 8px; border-radius: 4px; font-family: 'Courier New', monospace; color: #ffd700; }
        pre { background: #1a1a2e; padding: 20px; border-radius: 10px; overflow-x: auto; margin: 15px 0; border: 1px solid #667eea; }
        pre code { background: none; padding: 0; color: #2ecc71; }
        .warning { background: rgba(243, 156, 18, 0.1); border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .info { background: rgba(52, 152, 219, 0.1); border-left: 4px solid #3498db; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .success { background: rgba(46, 204, 113, 0.1); border-left: 4px solid #2ecc71; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .back-link { display: inline-block; margin-top: 30px; padding: 12px 25px; background: #667eea; color: white; border-radius: 8px; text-decoration: none; transition: all 0.3s; }
        .back-link:hover { background: #764ba2; transform: translateY(-2px); }
        .footer { text-align: center; margin-top: 60px; padding: 30px; border-top: 1px solid rgba(102, 126, 234, 0.3); opacity: 0.7; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ D√©ploiement</h1>
        <p>Guide de d√©ploiement en production du Site Gamer 2025</p>
    </div>

    <nav class="nav">
        <a href="wiki.html">üè† Accueil Wiki</a>
        <a href="api-reference.html">üìÅ API</a>
        <a href="database.html">üóÑÔ∏è Base de donn√©es</a>
        <a href="scripts.html">‚öôÔ∏è Scripts</a>
        <a href="troubleshooting.html">üîß D√©pannage</a>
        <a href="changelog.html">üìù Changelog</a>
    </nav>

    <div class="container">
        <div class="section">
            <h2>üìã Pr√©requis production</h2>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>Serveur Linux (recommand√©)</strong>
                <ul style="margin: 10px 0 0 45px;">
                    <li>Ubuntu 22.04 LTS ou Debian 11+</li>
                    <li>2 Go RAM minimum (4 Go recommand√©s)</li>
                    <li>20 Go espace disque</li>
                    <li>Acc√®s SSH avec sudo</li>
                </ul>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                <strong>Nom de domaine</strong>
                <p style="margin: 10px 0 0 45px;">Configur√© avec enregistrements DNS pointant vers votre serveur</p>
            </div>

            <div class="step">
                <span class="step-number">3</span>
                <strong>Certificat SSL</strong>
                <p style="margin: 10px 0 0 45px;">Let's Encrypt (gratuit) ou certificat commercial</p>
            </div>
        </div>

        <div class="section">
            <h2>üîß Configuration serveur</h2>

            <h3>1. Mise √† jour syst√®me</h3>
            <pre><code>sudo apt update && sudo apt upgrade -y
sudo apt install -y curl git build-essential</code></pre>

            <h3>2. Installation Node.js 18+</h3>
            <pre><code># Via NodeSource
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# V√©rifier
node --version  # v18.x.x ou sup√©rieur
npm --version</code></pre>

            <h3>3. Installation PostgreSQL</h3>
            <pre><code>sudo apt install -y postgresql postgresql-contrib

# D√©marrer et activer
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Cr√©er utilisateur et base
sudo -u postgres psql
CREATE USER gamer_prod WITH PASSWORD 'mot_de_passe_fort';
CREATE DATABASE gamer_2025 OWNER gamer_prod;
GRANT ALL PRIVILEGES ON DATABASE gamer_2025 TO gamer_prod;
\q</code></pre>

            <div class="warning">
                <strong>‚ö†Ô∏è S√©curit√© :</strong>
                <p style="margin-top: 10px;">Utilisez un mot de passe fort et diff√©rent de celui en d√©veloppement!</p>
            </div>

            <h3>4. Configuration PostgreSQL</h3>
            <p>√âditez <code>/etc/postgresql/14/main/postgresql.conf</code> :</p>
            <pre><code># Performance
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB

# Connexions
max_connections = 100

# Logs
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_min_duration_statement = 1000</code></pre>

            <p>Red√©marrer PostgreSQL :</p>
            <pre><code>sudo systemctl restart postgresql</code></pre>
        </div>

        <div class="section">
            <h2>üì¶ D√©ploiement application</h2>

            <h3>1. Cr√©er utilisateur d√©di√©</h3>
            <pre><code>sudo useradd -m -s /bin/bash gamer
sudo usermod -aG sudo gamer</code></pre>

            <h3>2. Cloner le projet</h3>
            <pre><code>sudo su - gamer
cd ~
git clone https://github.com/votre-repo/site-gamer-2025.git
cd site-gamer-2025</code></pre>

            <h3>3. Installer d√©pendances</h3>
            <pre><code>npm install --production</code></pre>

            <h3>4. Configuration environnement</h3>
            <p>Cr√©er <code>.env</code> :</p>
            <pre><code>NODE_ENV=production
PORT=3000

# Database
DB_USER=gamer_prod
DB_HOST=localhost
DB_NAME=gamer_2025
DB_PASSWORD=votre_mot_de_passe_fort
DB_PORT=XXXX

# LLM
OPENAI_MODEL=gpt-5
GPT5_ENABLED=false
GPT5_ROLLOUT=0</code></pre>

            <div class="warning">
                <strong>‚ö†Ô∏è S√©curit√© :</strong>
                <pre><code>chmod 600 .env  # Permissions strictes
chown gamer:gamer .env</code></pre>
            </div>

            <h3>5. Importer donn√©es</h3>
            <pre><code>psql -U gamer_prod -h localhost gamer_2025 < backend/gestion_produits.sql</code></pre>

            <h3>6. Build assets</h3>
            <pre><code>npm run build:css
npm run build:js</code></pre>

            <h3>7. G√©n√©rer toutes les fiches</h3>
            <pre><code>node scripts/regenerate-all-fiches.js</code></pre>
        </div>

        <div class="section">
            <h2>‚ö° Process Manager (PM2)</h2>

            <h3>1. Installation</h3>
            <pre><code>sudo npm install -g pm2</code></pre>

            <h3>2. Configuration</h3>
            <p>Cr√©er <code>ecosystem.config.js</code> :</p>
            <pre><code>module.exports = {
  apps: [{
    name: 'site-gamer',
    script: './server.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '500M'
  }]
};</code></pre>

            <h3>3. D√©marrer l'application</h3>
            <pre><code># Cr√©er dossier logs
mkdir -p logs

# D√©marrer
pm2 start ecosystem.config.js

# Auto-start au d√©marrage
pm2 startup
pm2 save</code></pre>

            <h3>4. Commandes utiles</h3>
            <pre><code>pm2 status          # Voir statut
pm2 logs            # Voir logs en temps r√©el
pm2 restart all     # Red√©marrer
pm2 stop all        # Arr√™ter
pm2 monit           # Monitoring en temps r√©el</code></pre>
        </div>

        <div class="section">
            <h2>üîí Nginx (Reverse Proxy)</h2>

            <h3>1. Installation</h3>
            <pre><code>sudo apt install -y nginx</code></pre>

            <h3>2. Configuration</h3>
            <p>Cr√©er <code>/etc/nginx/sites-available/site-gamer</code> :</p>
            <pre><code>server {
    listen 80;
    server_name votredomaine.com www.votredomaine.com;
    
    # Redirection vers HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name votredomaine.com www.votredomaine.com;

    # SSL
    ssl_certificate /etc/letsencrypt/live/votredomaine.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/votredomaine.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Logs
    access_log /var/log/nginx/site-gamer-access.log;
    error_log /var/log/nginx/site-gamer-error.log;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

    # Proxy vers Node.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Cache statique
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}</code></pre>

            <h3>3. Activer la configuration</h3>
            <pre><code>sudo ln -s /etc/nginx/sites-available/site-gamer /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx</code></pre>

            <h3>4. SSL avec Let's Encrypt</h3>
            <pre><code># Installer Certbot
sudo apt install -y certbot python3-certbot-nginx

# Obtenir certificat
sudo certbot --nginx -d votredomaine.com -d www.votredomaine.com

# Auto-renouvellement
sudo systemctl enable certbot.timer</code></pre>
        </div>

        <div class="section">
            <h2>üîê S√©curit√©</h2>

            <h3>Firewall (UFW)</h3>
            <pre><code>sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
sudo ufw status</code></pre>

            <h3>Fail2Ban (protection SSH)</h3>
            <pre><code>sudo apt install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban</code></pre>

            <h3>S√©curiser PostgreSQL</h3>
            <p>√âditez <code>/etc/postgresql/14/main/pg_hba.conf</code> :</p>
            <pre><code># Autoriser seulement local
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5</code></pre>

            <h3>Limiter acc√®s SSH</h3>
            <p>√âditez <code>/etc/ssh/sshd_config</code> :</p>
            <pre><code>PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers gamer</code></pre>
        </div>

        <div class="section">
            <h2>üìä Monitoring</h2>

            <h3>Logs syst√®me</h3>
            <pre><code># Logs Node.js (PM2)
pm2 logs

# Logs Nginx
sudo tail -f /var/log/nginx/site-gamer-access.log
sudo tail -f /var/log/nginx/site-gamer-error.log

# Logs PostgreSQL
sudo tail -f /var/log/postgresql/postgresql-14-main.log</code></pre>

            <h3>Surveillance ressources</h3>
            <pre><code># Utilisation CPU/RAM
htop

# Espace disque
df -h

# Connexions DB
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity;"</code></pre>

            <h3>PM2 Monitoring (optionnel)</h3>
            <pre><code># Cr√©er compte sur pm2.io puis:
pm2 link [secret] [public]</code></pre>
        </div>

        <div class="section">
            <h2>üîÑ Mises √† jour</h2>

            <h3>D√©ploiement nouvelle version</h3>
            <pre><code># 1. Backup DB
pg_dump -U gamer_prod gamer_2025 > backup_$(date +%Y%m%d).sql

# 2. Pull derni√®res modifications
cd ~/site-gamer-2025
git pull origin main

# 3. Installer nouvelles d√©pendances
npm install --production

# 4. Build assets
npm run build:css
npm run build:js

# 5. Migrations DB (si n√©cessaire)
psql -U gamer_prod gamer_2025 < migrations/xxx.sql

# 6. Red√©marrer application
pm2 restart all

# 7. V√©rifier
pm2 status
curl -I https://votredomaine.com</code></pre>

            <div class="warning">
                <strong>‚ö†Ô∏è Zero-downtime deployment :</strong>
                <p style="margin-top: 10px;">PM2 en mode cluster assure le zero-downtime lors du <code>pm2 reload</code></p>
            </div>
        </div>

        <div class="section">
            <h2>üíæ Sauvegardes automatiques</h2>

            <h3>Script de backup</h3>
            <p>Cr√©er <code>~/backup-db.sh</code> :</p>
            <pre><code>#!/bin/bash
BACKUP_DIR="/home/gamer/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Backup DB
pg_dump -U gamer_prod gamer_2025 > $BACKUP_DIR/backup_$DATE.sql

# Compresser
gzip $BACKUP_DIR/backup_$DATE.sql

# Garder 30 derniers jours
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +30 -delete

echo "Backup completed: backup_$DATE.sql.gz"</code></pre>

            <h3>Cron quotidien</h3>
            <pre><code>chmod +x ~/backup-db.sh

# Ajouter au cron (3h du matin)
crontab -e
0 3 * * * /home/gamer/backup-db.sh >> /home/gamer/logs/backup.log 2>&1</code></pre>
        </div>

        <div class="section">
            <h2>‚úÖ Checklist post-d√©ploiement</h2>

            <div class="success">
                <ul style="margin-left: 20px;">
                    <li>‚úì HTTPS actif et certificat valide</li>
                    <li>‚úì PM2 d√©marre automatiquement au boot</li>
                    <li>‚úì Firewall configur√©</li>
                    <li>‚úì Backups DB automatiques</li>
                    <li>‚úì Logs accessibles et rotatifs</li>
                    <li>‚úì Variables d'environnement en place</li>
                    <li>‚úì Monitoring actif</li>
                    <li>‚úì Tests endpoints API OK</li>
                    <li>‚úì G√©n√©ration fiches fonctionne</li>
                    <li>‚úì Assets minifi√©s servis correctement</li>
                </ul>
            </div>
        </div>

        <a href="wiki.html" class="back-link">‚Üê Retour au Wiki</a>
    </div>

    <div class="footer">
        <p>üöÄ D√©ploiement - Site Gamer 2025</p>
        <p>Derni√®re mise √† jour : 26 d√©cembre 2025</p>
    </div>
</body>
</html>
