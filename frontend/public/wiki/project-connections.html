<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Site Gamer 2025 - Vue Interactive Am√©lior√©e</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="architecture-flow-modular.css">
    <style>
        /* Am√©liorations visuelles pour les connexions */
        .connection-line {
            stroke: #cbd5e0;
            stroke-width: 2px;
            fill: none;
            transition: all 0.3s ease;
            opacity: 0.4;
        }
        
        .connection-line.dimmed {
            opacity: 0.05;
        }
        
        .connection-line.active {
            stroke: #667eea;
            stroke-width: 4px;
            opacity: 1 !important;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
        }
        
        .connection-line.incoming {
            stroke: #48bb78;
            stroke-width: 4px;
            opacity: 1 !important;
            filter: drop-shadow(0 0 8px rgba(72, 187, 120, 0.6));
        }
        
        .connection-arrow {
            fill: #cbd5e0;
            transition: all 0.3s ease;
            opacity: 0.4;
        }
        
        .connection-arrow.dimmed {
            opacity: 0.05;
        }
        
        .connection-arrow.active {
            fill: #667eea;
            opacity: 1 !important;
            filter: drop-shadow(0 0 4px rgba(102, 126, 234, 0.8));
        }
        
        .connection-arrow.incoming {
            fill: #48bb78;
            opacity: 1 !important;
            filter: drop-shadow(0 0 4px rgba(72, 187, 120, 0.8));
        }
        
        /* Am√©lioration des n≈ìuds au survol */
        .node {
            transition: all 0.3s ease;
            position: relative;
            opacity: 1;
        }
        
        .node.dimmed {
            opacity: 0.15;
            filter: grayscale(50%);
            transform: scale(0.95);
        }
        
        .node.active {
            transform: scale(1.08);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
            border-color: #d4ff00 !important;
            z-index: 100;
            opacity: 1 !important;
        }
        
        .node.connected-target {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.35);
            border-color: #d4ff00 !important;
            border-width: 3px;
            opacity: 1 !important;
        }
        
        .node.connected-source {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(72, 187, 120, 0.35);
            border-color: #48bb78 !important;
            border-width: 3px;
            opacity: 1 !important;
        }
        
        .node.locked {
            border: 3px solid #f59e0b !important;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }
        
        /* Badge indicateur de connexions */
        .connection-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: inline-block; min-width: max-content;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .node:hover .connection-badge {
            opacity: 1;
        }
        
        /* Tooltip pour afficher les connexions */
        .node-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(0, 0, 0, 0.9);
            display: inline-block; min-width: max-content;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .node:hover .node-tooltip {
            opacity: 1;
        }
        
        .node-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        
        /* L√©gende des connexions */
        .connection-legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
        }
        
        .connection-legend.show {
            display: block;
        }
        
        .connection-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .connection-legend-line {
            width: 30px;
            height: 3px;
            border-radius: 2px;
        }
        
        /* Pulse animation pour le n≈ìud actif */
        @keyframes pulse-node {
            0%, 100% {
                box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 8px 40px rgba(102, 126, 234, 0.7);
            }
        }
        
        .node.active {
            animation: pulse-node 1.5s infinite;
        }
        
        /* Indicateur de direction des connexions */
        .flow-direction {
            position: absolute;
            font-size: 12px;
            color: #d4ff00;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .node.active ~ .flow-direction,
        .node:hover ~ .flow-direction {
            opacity: 1;
        }
        
        /* Compteur de connexions */
        .connections-count {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: inline-block; min-width: max-content;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        .connections-count.show {
            opacity: 1;
        }
        
        .count-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .count-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Highlight des colonnes enti√®res */
        .flow-column.highlight {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 10px;
            margin: -10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Architecture Site Gamer 2025</h1>
            <p>Architecture Modulaire Refactoris√©e - Vue Interactive Am√©lior√©e</p>
            <div class="metrics">
                <div class="metric">üì¶ <strong>8</strong> modules routes</div>
                <div class="metric">üìâ <strong>-59%</strong> code server.js</div>
                <div class="metric">üìú <strong>51</strong> scripts migr√©s</div>
                <div class="metric">üìÅ <strong>4</strong> dossiers organis√©s</div>
                <div class="metric">‚úÖ <strong>15/15</strong> tests passants</div>
            </div>
        </header>
        
        <div class="controls">
            <button class="btn btn-all active" onclick="filterLayer('all')">Tout afficher</button>
            <button class="btn btn-frontend" onclick="filterLayer('frontend')">Frontend</button>
            <button class="btn btn-config" onclick="filterLayer('config')">Config</button>
            <button class="btn btn-routes" onclick="filterLayer('routes')">Routes</button>
            <button class="btn btn-database" onclick="filterLayer('database')">Database</button>
            <button class="btn btn-scripts" onclick="filterLayer('scripts')">Scripts</button>
            <button class="btn btn-tests" onclick="filterLayer('tests')">Tests</button>
        </div>
        
        <!-- Compteur de connexions -->
        <div class="connections-count" id="connectionsCount">
            <div class="count-label">Connexions actives</div>
            <div class="count-value">
                <span id="outgoingCount">0</span> ‚Üí | ‚Üê <span id="incomingCount">0</span>
            </div>
            <div style="font-size: 11px; margin-top: 8px; opacity: 0.8; text-align: center;">
                üîí Cliquez pour verrouiller
            </div>
        </div>
        
        <!-- L√©gende des connexions -->
        <div class="connection-legend" id="connectionLegend">
            <h4 style="margin-bottom: 10px; color: #d4ff00;">L√©gende des connexions</h4>
            <div class="connection-legend-item">
                <div class="connection-legend-line" style="background: #667eea;"></div>
                <span>Connexions sortantes (‚Üí)</span>
            </div>
            <div class="connection-legend-item">
                <div class="connection-legend-line" style="background: #48bb78;"></div>
                <span>Connexions entrantes (‚Üê)</span>
            </div>
            <div class="connection-legend-item">
                <div class="connection-legend-line" style="background: #cbd5e0;"></div>
                <span>Connexions inactives</span>
            </div>
        </div>
        
        <div class="flow-container">
            <svg class="connections-svg" id="connectionsSvg"></svg>
            
            <div class="flow-column layer-frontend layer-all">
                <div class="column-title frontend-title">üé® Frontend</div>
                
                <div class="node node-html" id="indexHTML" data-connects="fichesJS">
                    <div class="node-tooltip">Charge les produits via API</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üìÑ index.html</div>
                    <div class="node-desc">Page d'accueil</div>
                </div>
                
                <div class="node node-html" id="topHTML" data-connects="fichesJS">
                    <div class="node-tooltip">Affiche les tops du mois</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üìÑ top-du-mois.html</div>
                    <div class="node-desc">Top produits</div>
                </div>
                
                <div class="node node-html" id="tendancesHTML" data-connects="tendancesJS">
                    <div class="node-tooltip">Affiche les actualit√©s tech</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üìÑ tendances.html</div>
                    <div class="node-desc">Actualit√©s tech</div>
                </div>
                
                <div class="node node-js" id="fichesJS" data-connects="serverNode">
                    <div class="node-tooltip">API produits ‚Üí Server Express</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">‚ö° fiches.js</div>
                    <div class="node-desc">Fetch produits API</div>
                </div>
                
                <div class="node node-js" id="tendancesJS" data-connects="serverNode">
                    <div class="node-tooltip">API tendances ‚Üí Server Express</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">‚ö° tendances.js</div>
                    <div class="node-desc">Fetch actualit√©s</div>
                </div>
            </div>
            
            <!-- Server Column -->
            <div class="flow-column layer-config layer-routes layer-all">
                <div class="column-title" style="background: linear-gradient(135deg, #34495e, #2c3e50); display: inline-block; min-width: max-content;">
                    ‚öôÔ∏è server.js
                </div>
                
                <div class="node" id="serverNode" data-connects="configNode,routesProduits,routesFiches,routesTendances,routesContent,routesTech,routesMarche,routesInsights,routesPred" style="background: linear-gradient(135deg, #FFE0B2, #FFB74D); color: #333; border: 3px solid #F57C00;">
                    <div class="node-tooltip">Connecte 9 modules + config</div>
                    <div class="connection-badge">9</div>
                    <div class="node-title">üöÄ Express App</div>
                    <div class="node-desc">260 lignes (-59%)</div>
                    <div class="node-badge">Refactoris√©</div>
                </div>
            </div>
            
            <!-- Config Column -->
            <div class="flow-column layer-config layer-all">
                <div class="column-title config-title">‚ö° Configuration</div>
                
                <div class="node node-config" id="configNode" data-connects="envNode,dbNode">
                    <div class="node-tooltip">Pool PostgreSQL centralis√©</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üîß database.js</div>
                    <div class="node-desc">Pool PostgreSQL centralis√©</div>
                    <div class="node-badge">NEW</div>
                </div>
                
                <div class="node node-env" id="envNode">
                    <div class="node-tooltip">Variables d'environnement</div>
                    <div class="node-title">üîê .env</div>
                    <div class="node-desc">Credentials (gitignored)</div>
                    <div class="node-badge">NEW</div>
                </div>
            </div>
            
            <!-- Routes Column -->
            <div class="flow-column layer-routes layer-all">
                <div class="column-title routes-title">üõ£Ô∏è Routes Modules</div>
                
                <div class="node node-module" id="routesProduits" data-connects="configNode,tableProduits">
                    <div class="node-tooltip">CRUD produits ‚Üí DB</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üì¶ produits.js</div>
                    <div class="node-desc">CRUD produits (5 routes)</div>
                </div>
                
                <div class="node node-module" id="routesFiches" data-connects="configNode,utilsNode,tableProduits">
                    <div class="node-tooltip">G√©n√©ration fiches HTML</div>
                    <div class="connection-badge">3</div>
                    <div class="node-title">üìù fiches.js</div>
                    <div class="node-desc">G√©n√©ration HTML (3 routes)</div>
                </div>
                
                <div class="node node-module" id="routesTendances" data-connects="configNode,tableActualites">
                    <div class="node-tooltip">CRUD actualit√©s + alias</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üì∞ tendances.js</div>
                    <div class="node-desc">CRUD actualit√©s</div>
                    <div class="node-badge">+alias</div>
                </div>
                
                <div class="node node-module" id="routesContent" data-connects="configNode,tableActualites,tableTech,tableMarche,tableInsights,tablePred">
                    <div class="node-tooltip">Contenu multi-tables</div>
                    <div class="connection-badge">6</div>
                    <div class="node-title">üîÄ content.js</div>
                    <div class="node-desc">Contenu par cat√©gorie</div>
                </div>
                
                <div class="node node-module" id="routesTech" data-connects="configNode,tableTech">
                    <div class="node-tooltip">CRUD technologies</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üíª technologies.js</div>
                    <div class="node-desc">CRUD technologies</div>
                </div>
                
                <div class="node node-module" id="routesMarche" data-connects="configNode,tableMarche">
                    <div class="node-tooltip">CRUD donn√©es march√©</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üìä marche.js</div>
                    <div class="node-desc">CRUD march√©</div>
                </div>
                
                <div class="node node-module" id="routesInsights" data-connects="configNode,tableInsights">
                    <div class="node-tooltip">CRUD analyses</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üí° insights.js</div>
                    <div class="node-desc">CRUD insights</div>
                </div>
                
                <div class="node node-module" id="routesPred" data-connects="configNode,tablePred">
                    <div class="node-tooltip">CRUD pr√©visions</div>
                    <div class="connection-badge">2</div>
                    <div class="node-title">üîÆ predictions.js</div>
                    <div class="node-desc">CRUD pr√©dictions</div>
                </div>
                
                <div class="column-title" style="background: linear-gradient(135deg, #7E57C2, #5E35B1); display: inline-block; min-width: max-content; margin-top: 20px;">
                    üõ†Ô∏è Utilitaires
                </div>
                
                <div class="node node-utils" id="utilsNode">
                    <div class="node-tooltip">Fonctions g√©n√©ration fiches</div>
                    <div class="node-title">üîß ficheGenerator.js</div>
                    <div class="node-desc">generateFicheHTML()<br>createFiche()<br>deleteFiche()</div>
                </div>
            </div>
            
            <!-- Database Column -->
            <div class="flow-column layer-database layer-all">
                <div class="column-title database-title">üóÑÔ∏è PostgreSQL</div>
                
                <div class="node node-table" id="dbNode">
                    <div class="node-tooltip">Base de donn√©es principale</div>
                    <div class="node-title">üíæ gamer_2025</div>
                    <div class="node-desc">Base de donn√©es</div>
                </div>
                
                <div class="node node-table" id="tableProduits">
                    <div class="node-tooltip">Table des produits</div>
                    <div class="node-title">üì¶ produits</div>
                    <div class="node-desc">61 produits</div>
                </div>
                
                <div class="node node-table" id="tableActualites">
                    <div class="node-tooltip">Table des actualit√©s</div>
                    <div class="node-title">üì∞ actualites</div>
                    <div class="node-desc">Actualit√©s secteur</div>
                </div>
                
                <div class="node node-table" id="tableTech">
                    <div class="node-tooltip">Table des technologies</div>
                    <div class="node-title">üíª technologies</div>
                    <div class="node-desc">Tech √©mergentes</div>
                </div>
                
                <div class="node node-table" id="tableMarche">
                    <div class="node-tooltip">Table donn√©es march√©</div>
                    <div class="node-title">üìä marche</div>
                    <div class="node-desc">Donn√©es march√©</div>
                </div>
                
                <div class="node node-table" id="tableInsights">
                    <div class="node-tooltip">Table des analyses</div>
                    <div class="node-title">üí° insights</div>
                    <div class="node-desc">Analyses</div>
                </div>
                
                <div class="node node-table" id="tablePred">
                    <div class="node-tooltip">Table des pr√©visions</div>
                    <div class="node-title">üîÆ predictions</div>
                    <div class="node-desc">Pr√©visions</div>
                </div>
                
                <div class="node node-table" id="tableCategories">
                    <div class="node-tooltip">Table des cat√©gories</div>
                    <div class="node-title">üìÅ categories</div>
                    <div class="node-desc">Types produits</div>
                </div>
            </div>
            
            <!-- Scripts Column -->
            <div class="flow-column layer-scripts layer-all">
                <div class="column-title scripts-title">üìú Scripts Organis√©s</div>
                
                <div class="node node-script" data-connects="configNode">
                    <div class="node-tooltip">Scripts d'initialisation</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üîß setup/ (5)</div>
                    <div class="node-desc">reinit-db.js<br>restore-db.js</div>
                </div>
                
                <div class="node node-script" data-connects="configNode">
                    <div class="node-tooltip">Gestion produits</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üì¶ products/ (11)</div>
                    <div class="node-desc">add-new-products.js<br>update-top-decembre.js</div>
                </div>
                
                <div class="node node-script" data-connects="configNode">
                    <div class="node-tooltip">G√©n√©ration fiches</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üìù fiches/ (6)</div>
                    <div class="node-desc">regenerate-all-fiches.js<br>generate-new-products.js</div>
                </div>
                
                <div class="node node-script" data-connects="configNode">
                    <div class="node-tooltip">Scripts de maintenance</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üîß maintenance/ (35)</div>
                    <div class="node-desc">verify-database-state.js<br>normalize-*.js</div>
                </div>
                
                <div class="node" style="background: linear-gradient(135deg, #90CAF9, #42A5F5); display: inline-block; min-width: max-content;">
                    <div class="node-tooltip">Tous les scripts migr√©s</div>
                    <div class="node-title">üéØ 51 scripts migr√©s</div>
                    <div class="node-desc">Utilisent database.js centralis√©</div>
                    <div class="node-badge">‚úÖ Done</div>
                </div>
            </div>
            
            <!-- Tests Column -->
            <div class="flow-column layer-tests layer-all">
                <div class="column-title tests-title">‚úÖ Tests (Jest)</div>
                
                <div class="node node-test" data-connects="routesProduits,routesFiches,routesTendances">
                    <div class="node-tooltip">Tests des endpoints API</div>
                    <div class="connection-badge">3</div>
                    <div class="node-title">üß™ api.test.js</div>
                    <div class="node-desc">6 tests<br>Endpoints API</div>
                    <div class="node-badge">‚úÖ Pass</div>
                </div>
                
                <div class="node node-test" data-connects="configNode">
                    <div class="node-tooltip">Tests connexion DB</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üß™ database.test.js</div>
                    <div class="node-desc">3 tests<br>Connexion pool</div>
                    <div class="node-badge">‚úÖ Pass</div>
                </div>
                
                <div class="node node-test" data-connects="utilsNode">
                    <div class="node-tooltip">Tests g√©n√©ration HTML</div>
                    <div class="connection-badge">1</div>
                    <div class="node-title">üß™ generation.test.js</div>
                    <div class="node-desc">6 tests<br>G√©n√©ration HTML</div>
                    <div class="node-badge">‚úÖ Pass</div>
                </div>
                
                <div class="node" style="background: linear-gradient(135deg, #66BB6A, #43A047); display: inline-block; min-width: max-content; border: 3px solid #2E7D32;">
                    <div class="node-tooltip">Strat√©gie de tests compl√®te</div>
                    <div class="node-title">üéØ Tests Complets</div>
                    <div class="node-desc">üß™ 15 Jest (Backend)<br>üåê 23 Web (E2E)</div>
                    <div class="node-badge">‚úÖ 38 Tests</div>
                </div>
            </div>
        </div>
        
        <div class="legend">
            <h3>üé® L√©gende - Architecture Modulaire</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #4A90E2, #357ABD);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Frontend HTML/JS</div>
                        <div class="legend-desc">Interface utilisateur statique</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #80CBC4, #00897B);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Configuration</div>
                        <div class="legend-desc">database.js + dotenv (NEW)</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #F48FB1, #E91E63);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Modules Routes</div>
                        <div class="legend-desc">8 fichiers modulaires (NEW)</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #B39DDB, #7E57C2);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Utilitaires</div>
                        <div class="legend-desc">ficheGenerator.js (NEW)</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #FFF59D, #FBC02D);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Tables PostgreSQL</div>
                        <div class="legend-desc">Base de donn√©es gamer_2025</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #FFCC80, #E67E22);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Scripts Organis√©s</div>
                        <div class="legend-desc">4 dossiers th√©matiques (NEW)</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #AED581, #66BB6A);"></div>
                    <div class="legend-text">
                        <div class="legend-label">Tests Automatis√©s</div>
                        <div class="legend-desc">Jest + Supertest (NEW)</div>
                    </div>
                </div>
                
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #FFE0B2, #FFB74D);"></div>
                    <div class="legend-text">
                        <div class="legend-label">server.js Refactoris√©</div>
                        <div class="legend-desc">636 ‚Üí 260 lignes (-59%)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentFilter = 'all';
        let lockedNode = null;
        
        // Draw connections between nodes
        function drawConnections() {
            const svg = document.getElementById('connectionsSvg');
            svg.innerHTML = '';
            
            const container = document.querySelector('.flow-container');
            const containerRect = container.getBoundingClientRect();
            
            // Set SVG size to match container
            svg.setAttribute('width', container.scrollWidth);
            svg.setAttribute('height', container.scrollHeight);
            svg.style.width = container.scrollWidth + 'px';
            svg.style.height = container.scrollHeight + 'px';
            
            document.querySelectorAll('.node[data-connects]').forEach(node => {
                const connects = node.dataset.connects;
                if (!connects) return;
                
                // Skip if SOURCE node is not visible (filtered out)
                if (node.offsetParent === null) return;
                
                const nodeRect = node.getBoundingClientRect();
                // Add scroll offset
                const x1 = nodeRect.right - containerRect.left + container.scrollLeft;
                const y1 = nodeRect.top + nodeRect.height / 2 - containerRect.top + container.scrollTop;
                
                connects.split(',').forEach(targetId => {
                    const target = document.getElementById(targetId.trim());
                    
                    // Skip if TARGET node doesn't exist or is not visible
                    if (!target || target.offsetParent === null) return;
                    
                    const targetRect = target.getBoundingClientRect();
                    
                    // Calculer les positions avec scroll offset
                    const sourceRight = nodeRect.right - containerRect.left + container.scrollLeft;
                    const sourceLeft = nodeRect.left - containerRect.left + container.scrollLeft;
                    const sourceCenterY = nodeRect.top + nodeRect.height / 2 - containerRect.top + container.scrollTop;
                    
                    const targetLeft = targetRect.left - containerRect.left + container.scrollLeft;
                    const targetRight = targetRect.right - containerRect.left + container.scrollLeft;
                    const targetCenterY = targetRect.top + targetRect.height / 2 - containerRect.top + container.scrollTop;
                    
                    // D√©terminer les points de d√©part et d'arriv√©e selon la position relative
                    let startX, startY, endX, endY;
                    
                    if (targetLeft >= sourceRight) {
                        // La cible est √† DROITE de la source : partir de droite ‚Üí arriver √† gauche
                        startX = sourceRight;
                        startY = sourceCenterY;
                        endX = targetLeft;
                        endY = targetCenterY;
                    } else if (targetRight <= sourceLeft) {
                        // La cible est √† GAUCHE de la source : partir de gauche ‚Üí arriver √† droite
                        startX = sourceLeft;
                        startY = sourceCenterY;
                        endX = targetRight;
                        endY = targetCenterY;
                    } else {
                        // Chevauchement horizontal (rare mais possible) : connexion directe
                        startX = sourceRight;
                        startY = sourceCenterY;
                        endX = targetLeft;
                        endY = targetCenterY;
                    }
                    
                    // Calculer les distances horizontale et verticale
                    const horizontalDistance = Math.abs(endX - startX);
                    const verticalDistance = Math.abs(endY - startY);
                    
                    // Adapter l'offset des points de contr√¥le selon les deux dimensions
                    const horizontalOffset = Math.max(horizontalDistance * 0.5, 60); // 50% de la distance, min 60px
                    const verticalInfluence = Math.min(verticalDistance * 0.3, 150); // 30% de la distance verticale, max 150px
                    
                    // Cr√©er une courbe cubique de B√©zier √©l√©gante
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    
                    // Points de contr√¥le : courbe en S √©l√©gante
                    const direction = endX > startX ? 1 : -1;
                    const cp1x = startX + (horizontalOffset * direction);
                    const cp1y = startY + (verticalInfluence * (endY > startY ? 0.3 : -0.3)); // L√©g√®re courbure verticale
                    const cp2x = endX - (horizontalOffset * direction);
                    const cp2y = endY - (verticalInfluence * (endY > startY ? 0.3 : -0.3)); // L√©g√®re courbure verticale
                    
                    // Courbe cubique de B√©zier
                    const d = `M ${startX} ${startY} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${endX} ${endY}`;
                    
                    path.setAttribute('d', d);
                    path.setAttribute('class', 'connection-line');
                    path.setAttribute('data-from', node.id || 'unknown');
                    path.setAttribute('data-to', targetId.trim());
                    
                    svg.appendChild(path);
                    
                    // Ajouter une fl√®che pointant vers la destination
                    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    const angle = Math.atan2(endY - startY, endX - startX);
                    const arrowSize = 8;
                    const arrowX = endX - 10 * Math.cos(angle);
                    const arrowY = endY - 10 * Math.sin(angle);
                    
                    const points = [
                        [arrowX, arrowY],
                        [arrowX - arrowSize * Math.cos(angle - Math.PI / 6), arrowY - arrowSize * Math.sin(angle - Math.PI / 6)],
                        [arrowX - arrowSize * Math.cos(angle + Math.PI / 6), arrowY - arrowSize * Math.sin(angle + Math.PI / 6)]
                    ].map(p => p.join(',')).join(' ');
                    
                    arrow.setAttribute('points', points);
                    arrow.setAttribute('class', 'connection-arrow');
                    arrow.setAttribute('data-from', node.id || 'unknown');
                    arrow.setAttribute('data-to', targetId.trim());
                    
                    svg.appendChild(arrow);
                });
            });
        }
        
        function filterLayer(layer) {
            currentFilter = layer;
            
            // Remove active class from all buttons
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Show/hide columns based on layer
            const columns = document.querySelectorAll('.flow-column');
            columns.forEach(column => {
                if (layer === 'all' || column.classList.contains('layer-' + layer)) {
                    column.style.display = 'flex';
                } else {
                    column.style.display = 'none';
                }
            });
            
            // Redraw connections after filter change
            setTimeout(drawConnections, 100);
        }
        
        function initNodeInteractions() {
            // Add hover effects with enhanced visualization
            document.querySelectorAll('.node').forEach(node => {
                node.addEventListener('mouseenter', function() {
                    // Don't trigger hover if a node is locked
                    if (lockedNode && lockedNode !== this) return;
                    
                    highlightNode(this);
                });
                
                node.addEventListener('mouseleave', function() {
                    // Don't clear if a node is locked
                    if (lockedNode) return;
                    
                    clearHighlights();
                });
                
                // Add click to lock/unlock
                node.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (lockedNode === this) {
                        // Unlock
                        lockedNode = null;
                        this.classList.remove('locked');
                        clearHighlights();
                    } else {
                        // Lock this node
                        if (lockedNode) {
                            lockedNode.classList.remove('locked');
                        }
                        lockedNode = this;
                        this.classList.add('locked');
                        clearHighlights();
                        highlightNode(this);
                    }
                });
            });
            
            // Click anywhere else to unlock
            document.addEventListener('click', function(e) {
                if (lockedNode && !e.target.closest('.node')) {
                    lockedNode.classList.remove('locked');
                    lockedNode = null;
                    clearHighlights();
                }
            });
        }
        
        function highlightNode(node) {
            const nodeId = node.id;
            const connects = node.dataset.connects;
            const svg = document.getElementById('connectionsSvg');
            
            // Dim ALL nodes and connections first
            document.querySelectorAll('.node').forEach(n => {
                n.classList.add('dimmed');
            });
            document.querySelectorAll('.connection-line, .connection-arrow').forEach(conn => {
                conn.classList.add('dimmed');
            });
            
            // Highlight current node (remove dimmed)
            node.classList.remove('dimmed');
            node.classList.add('active');
            
            // Count connections
            let outgoingCount = 0;
            let incomingCount = 0;
            
            // Highlight outgoing connections and targets
            if (connects) {
                connects.split(',').forEach(id => {
                    const target = document.getElementById(id.trim());
                    
                    // V√©rifier que le n≈ìud cible existe ET est visible
                    if (target && target.offsetParent !== null) {
                        // V√©rifier que la connexion existe r√©ellement dans le SVG
                        const existingConn = svg.querySelector(`[data-from="${nodeId}"][data-to="${id.trim()}"]`);
                        if (existingConn) {
                            target.classList.remove('dimmed');
                            target.classList.add('connected-target');
                            outgoingCount++;
                            
                            // Highlight connection
                            existingConn.classList.remove('dimmed');
                            existingConn.classList.add('active');
                            // Highlight arrow aussi
                            svg.querySelectorAll(`[data-from="${nodeId}"][data-to="${id.trim()}"]`).forEach(conn => {
                                conn.classList.remove('dimmed');
                                conn.classList.add('active');
                            });
                        }
                    }
                });
            }
            
            // Highlight incoming connections and sources
            // Ne compter QUE les connexions qui sont actuellement dans le SVG
            // Compter seulement les path (lignes), pas les polygon (fl√®ches)
            svg.querySelectorAll(`.connection-line[data-to="${nodeId}"]`).forEach(conn => {
                const fromId = conn.getAttribute('data-from');
                const fromNode = document.getElementById(fromId);
                
                // Si le n≈ìud source existe et est visible
                if (fromNode && fromNode.offsetParent !== null) {
                    conn.classList.remove('dimmed');
                    conn.classList.add('incoming');
                    // Highlight arrow aussi
                    svg.querySelectorAll(`.connection-arrow[data-from="${fromId}"][data-to="${nodeId}"]`).forEach(arrow => {
                        arrow.classList.remove('dimmed');
                        arrow.classList.add('incoming');
                    });
                    fromNode.classList.remove('dimmed');
                    fromNode.classList.add('connected-source');
                    incomingCount++;
                }
            });
            
            // Update connections count
            document.getElementById('outgoingCount').textContent = outgoingCount;
            document.getElementById('incomingCount').textContent = incomingCount;
            document.getElementById('connectionsCount').classList.add('show');
            
            // Show connection legend
            document.getElementById('connectionLegend').classList.add('show');
        }
        
        function clearHighlights() {
            // Remove all highlights and dimming
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('active', 'connected-target', 'connected-source', 'dimmed');
            });
            document.querySelectorAll('.connection-line, .connection-arrow').forEach(conn => {
                conn.classList.remove('active', 'incoming', 'dimmed');
            });
            
            // Hide connections count
            document.getElementById('connectionsCount').classList.remove('show');
            
            // Hide connection legend
            document.getElementById('connectionLegend').classList.remove('show');
        }
        
        // Initial draw and redraw on window resize
        window.addEventListener('load', function() {
            drawConnections();
            initNodeInteractions();
        });
        window.addEventListener('resize', drawConnections);
        
        // Redraw on scroll (for dynamic positioning)
        let scrollTimeout;
        window.addEventListener('load', function() {
            document.querySelector('.flow-container').addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(drawConnections, 50);
            });
        });
    </script>
</body>
</html>
