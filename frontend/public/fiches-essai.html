<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administration - Gestion des Produits</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Manrope", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .admin-header {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .admin-content {
        padding: 40px;
      }

      .section {
        margin-bottom: 40px;
        padding: 30px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
      }

      .section h2 {
        color: #007bff;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(45deg, #0056b3, #004494);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      .btn-success {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
      }

      .btn-success:hover {
        background: linear-gradient(45deg, #20c997, #17a2b8);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
      }

      .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .back-link {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        border-radius: 6px;
        text-decoration: none;
        color: #007bff;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .back-link:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .admin-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-link">‚Üê Retour au site</a>

    <div class="admin-container">
      <div class="admin-header">
        <h1>üõ†Ô∏è Administration</h1>
        <p>Gestion des produits et g√©n√©ration automatique</p>
      </div>

      <div class="admin-content">
        <!-- Statistiques -->
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="total-products">0</div>
            <div class="stat-label">Produits totaux</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-categories">16</div>
            <div class="stat-label">Cat√©gories</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="featured-products">12</div>
            <div class="stat-label">Top du mois</div>
          </div>
        </div>
        <!-- Inclusion de ton script -->
        <script src="../public/assets/js/stats.js"></script>
        <script>
          // On appelle la fonction au chargement
          updateStats("data/equipements.json");
        </script>

        <!-- Section √âdition de Produit -->
        <div class="section">
          <h2>‚úèÔ∏è √âditer un Produit Existant</h2>
          <div class="alert alert-info">
            <strong>Info :</strong> S√©lectionnez un produit pour modifier ses
            donn√©es directement.
          </div>

          <div class="form-group">
            <label for="product-select">S√©lectionner un produit √† √©diter</label>
            <select id="product-select" onchange="loadProductForEdit()">
              <option value="">-- Choisir un produit --</option>
            </select>
          </div>

          <div id="edit-form" style="display: none">
            <form id="product-edit-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Nom du produit</label>
                  <input
                    type="text"
                    id="edit-nom"
                    readonly
                    style="background: #f0f0f0"
                  />
                </div>
                <div class="form-group">
                  <label>Cat√©gorie</label>
                  <input
                    type="text"
                    id="edit-categorie"
                    readonly
                    style="background: #f0f0f0"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Prix</label>
                  <input
                    type="text"
                    id="edit-prix"
                    placeholder="Ex: 499,99 ‚Ç¨"
                  />
                </div>
                <div class="form-group">
                  <label>Top du mois</label>
                  <select id="edit-top">
                    <option value="false">Non</option>
                    <option value="true">Oui</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Description courte</label>
                <input
                  type="text"
                  id="edit-description"
                  placeholder="Description courte du produit"
                />
              </div>

              <div class="form-group">
                <label>Chemin de l'image</label>
                <input
                  type="text"
                  id="edit-image"
                  placeholder="assets/images/nom-produit.png"
                />
              </div>

              <div class="form-group">
                <label>Fonctionnalit√©s avanc√©es (une par ligne)</label>
                <textarea
                  id="edit-fonctionnalites"
                  rows="3"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #dee2e6;
                    border-radius: 6px;
                    font-family: 'Manrope', sans-serif;
                  "
                ></textarea>
              </div>

              <h3 style="margin-top: 20px; color: #007bff">
                Donn√©es de la fiche
              </h3>
              <div id="donnees-fiche-container">
                <!-- Les champs seront g√©n√©r√©s dynamiquement selon la cat√©gorie -->
              </div>

              <div style="display: flex; gap: 10px; margin-top: 20px">
                <button type="submit" class="btn btn-success">
                  üíæ Sauvegarder les modifications
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  onclick="downloadEditedJSON()"
                >
                  üì• T√©l√©charger le JSON modifi√©
                </button>
              </div>
            </form>
          </div>

          <div id="edit-result" style="margin-top: 20px"></div>
        </div>

        <!-- Section G√©n√©ration de Produit -->
        <div class="section">
          <h2>üöÄ G√©n√©rer un Nouveau Produit</h2>
          <div class="alert alert-info">
            <strong>Info :</strong> Cette fonction g√©n√®re un template JSON et
            une fiche HTML pr√™te √† personnaliser avec vos donn√©es.
          </div>

          <form id="product-form">
            <div class="form-row">
              <div class="form-group">
                <label for="product-name">Nom du produit *</label>
                <input
                  type="text"
                  id="product-name"
                  placeholder="Ex: Nintendo Switch 2 Pro"
                  required
                />
              </div>
              <div class="form-group">
                <label for="product-category">Cat√©gorie *</label>
                <select id="product-category" required>
                  <option value="">S√©lectionner une cat√©gorie</option>
                  <option value="PC GAMING">PC Gaming</option>
                  <option value="CONSOLE">Console</option>
                  <option value="SMARTPHONE">Smartphone</option>
                  <option value="TABLETTE">Tablette</option>
                  <option value="CASQUE AUDIO">Casque Audio</option>
                  <option value="DRONE">Drone</option>
                  <option value="ECRAN TV">√âcran TV</option>
                  <option value="CAMERA">Cam√©ra</option>
                  <option value="MONTRE CONNECTE">Montre Connect√©e</option>
                  <option value="CASQUE VR">Casque VR</option>
                  <option value="IMPRIMANTE 3D">Imprimante 3D</option>
                  <option value="SERVEUR">Serveur</option>
                  <option value="PERIPHERIQUES">P√©riph√©riques</option>
                  <option value="VIDEO PROJECTEUR">Vid√©oprojecteur</option>
                  <option value="BOX INTERNET">Box Internet</option>
                  <option value="TABLEAU INTERACTIF">Tableau Interactif</option>
                </select>
              </div>
            </div>

            <button type="submit" class="btn btn-primary">
              üìÅ G√©n√©rer le Produit Complet
            </button>
          </form>

          <div id="generation-result" style="margin-top: 20px"></div>
        </div>

        <!-- Section Tests -->
        <div class="section">
          <h2>üß™ Tests et Utilitaires</h2>

          <button class="btn btn-success" onclick="testProductGeneration()">
            üéÆ Test avec Nintendo Switch 2 Pro
          </button>

          <button
            class="btn btn-success"
            onclick="testDroneGeneration()"
            style="margin-left: 10px"
          >
            üöÅ Test avec Nouveau Drone
          </button>

          <div id="test-result" style="margin-top: 20px"></div>
        </div>
      </div>
    </div>

    <script>
      // Fonction pour g√©n√©rer un ID unique
      function generateProductId() {
        // G√©n√©rer un ID entre 1 et 9999
        // En production, il faudrait v√©rifier que l'ID n'existe pas d√©j√†
        const randomId = Math.floor(Math.random() * 9999) + 1;
        return `prod_${randomId}`;
      }

      // Cr√©er le template JSON pour un nouveau produit
      function createProductTemplate(nom, categorie) {
        const fileName = nom.replace(/[^a-zA-Z0-9]/g, "-").toLowerCase();
        const folder = getCategoryFolder(categorie);

        // Sections de base communes √† tous les produits
        let donneesFiche = [
          "√Ä REMPLIR - Description d√©taill√©e du produit.",
          "üí∞ Prix : √Ä D√âFINIR ‚Ç¨",
          "üß© Sp√©cifications mat√©rielles\\n√Ä REMPLIR",
        ];

        // Ajouter les sections sp√©cifiques selon la cat√©gorie
        switch (categorie) {
          case "DRONE":
            donneesFiche.push("üé• Fonctions vid√©o\\n√Ä REMPLIR");
            break;
          case "CONSOLE":
            donneesFiche.push("üñ•Ô∏è √âcran et affichage\\n√Ä REMPLIR");
            donneesFiche.push("üïπÔ∏è Contr√¥leurs et interaction\\n√Ä REMPLIR");
            break;
          case "TABLETTE":
            donneesFiche.push("üñ•Ô∏è √âcran et affichage\\n√Ä REMPLIR");
            donneesFiche.push("üñäÔ∏è Accessoires et interaction\\n√Ä REMPLIR");
            break;
          case "SMARTPHONE":
            donneesFiche.push("üì∏ Appareil photo\\n√Ä REMPLIR");
            break;
          case "PC GAMING":
            donneesFiche.push("üéÆ Fonctions gaming\\n√Ä REMPLIR");
            break;
          case "SERVEUR":
            donneesFiche.push("üñ•Ô∏è Performances et virtualisation\\n√Ä REMPLIR");
            break;
          case "PERIPHERIQUES":
            donneesFiche.push("üñ•Ô∏è Ergonomie et design\\n√Ä REMPLIR");
            break;
          case "CASQUE AUDIO":
            donneesFiche.push("üéß Fonctions audio\\n√Ä REMPLIR");
            break;
          case "MONTRE CONNECTE":
            donneesFiche.push("‚åö Fonctions sport et sant√©\\n√Ä REMPLIR");
            break;
          case "ECRAN TV":
            donneesFiche.push("üñ•Ô∏è Qualit√© d'image\\n√Ä REMPLIR");
            donneesFiche.push("üéÆ Gaming et fluidit√©\\n√Ä REMPLIR");
            donneesFiche.push("üé¨ Exp√©rience cin√©ma\\n√Ä REMPLIR");
            break;
          case "CAMERA":
            donneesFiche.push("üé• Fonctions vid√©o\\n√Ä REMPLIR");
            break;
          case "VIDEO PROJECTEUR":
            donneesFiche.push("üñ•Ô∏è Qualit√© d'image\\n√Ä REMPLIR");
            donneesFiche.push("üéÆ Gaming et fluidit√©\\n√Ä REMPLIR");
            donneesFiche.push("üé¨ Exp√©rience cin√©ma\\n√Ä REMPLIR");
            break;
          case "BOX INTERNET":
            donneesFiche.push("üì∫ Services TV et multim√©dia\\n√Ä REMPLIR");
            break;
          case "TABLEAU INTERACTIF":
            donneesFiche.push("üñäÔ∏è Fonctions interactives\\n√Ä REMPLIR");
            break;
          case "CASQUE VR":
            donneesFiche.push("üéÆ Fonctions VR et MR\\n√Ä REMPLIR");
            break;
          case "IMPRIMANTE 3D":
            donneesFiche.push("üñ®Ô∏è Fonctions avanc√©es\\n√Ä REMPLIR");
            break;
        }

        // Ajouter les sections finales communes
        donneesFiche.push("üåê Fonctionnalit√©s connect√©es\\n√Ä REMPLIR");
        donneesFiche.push("üéÆ Exp√©rience utilisateur\\n√Ä REMPLIR");

        return {
          nom: nom,
          categorie: categorie,
          image: `assets/images/${fileName}.png`,
          lien: `fiches-produits/${folder}/${fileName}.html`,
          description: "√Ä REMPLIR - Description courte du produit",
          top_du_mois: false,
          prix: "√Ä D√âFINIR ‚Ç¨",
          fonctionnalites_avancees: ["√Ä REMPLIR - Fonctionnalit√© avanc√©e"],
          id: generateProductId(),
          donnees_fiche: donneesFiche,
        };
      }

      // Mapping cat√©gories ‚Üí dossiers
      function getCategoryFolder(categorie) {
        const categoryFolders = {
          "PC GAMING": "pc-gaming",
          SMARTPHONE: "smartphone",
          TABLETTE: "tablette",
          "CASQUE AUDIO": "casque-audio",
          DRONE: "drone",
          CONSOLE: "console",
          "ECRAN TV": "ecran-tv",
          CAMERA: "camera",
          "MONTRE CONNECTE": "montre-connecte",
          "CASQUE VR": "casque-vr",
          "IMPRIMANTE 3D": "imprimante-3d",
          SERVEUR: "serveur",
          PERIPHERIQUES: "peripheriques",
          "VIDEO PROJECTEUR": "video-projecteur",
          "BOX INTERNET": "box-internet",
          "TABLEAU INTERACTIF": "tableau-interactif",
        };
        return categoryFolders[categorie] || "autre";
      }

      // Ajouter le produit au JSON existant
      async function addProductToJSON(product) {
        try {
          // Simuler le chargement du JSON existant
          // En production, tu devras charger le vrai fichier
          const existingData = []; // ‚Üê Directement un tableau
          existingData.push(product);

          // Ajouter le nouveau produit
          existingData.equipements.push(product);

          // T√©l√©charger le JSON mis √† jour
          downloadJSON(existingData, "equipements.json");

          console.log("‚úÖ Produit ajout√© au JSON");
          return true;
        } catch (error) {
          console.error("‚ùå Erreur ajout JSON:", error);
          const newData = {
            equipements: [product],
          };
          downloadJSON(newData, "equipements-new.json");
          return true;
        }
      }

      // Templates sp√©cifiques par cat√©gorie
      function getCategoryTemplate(categorie) {
        const templates = {
          DRONE: `<p>üé• Fonctions vid√©o<br>
  √Ä REMPLIR
</p>`,
          CONSOLE: `<p>üñ•Ô∏è √âcran et affichage<br>
  √Ä REMPLIR
</p>

<p>üïπÔ∏è Contr√¥leurs et interaction<br>
  √Ä REMPLIR
</p>`,
          TABLETTE: `<p>üñ•Ô∏è √âcran et affichage<br>
  √Ä REMPLIR
</p>

<p>üñäÔ∏è Accessoires et interaction<br>
  √Ä REMPLIR
</p>`,
          SMARTPHONE: `<p>üì∏ Appareil photo<br>
  √Ä REMPLIR
</p>`,
          "PC GAMING": `<p>üéÆ Fonctions gaming<br>
  √Ä REMPLIR
</p>`,
          SERVEUR: `<p>üñ•Ô∏è Performances et virtualisation<br>
  √Ä REMPLIR
</p>`,
          PERIPHERIQUES: `<p>üñ•Ô∏è Ergonomie et design<br>
  √Ä REMPLIR
</p>`,
          "CASQUE AUDIO": `<p>üéß Fonctions audio<br>
  √Ä REMPLIR
</p>`,
          "MONTRE CONNECTE": `<p>‚åö Fonctions sport et sant√©<br>
  √Ä REMPLIR
</p>`,
          "ECRAN TV": `<p>üñ•Ô∏è Qualit√© d'image<br>
  √Ä REMPLIR
</p>

<p>üéÆ Gaming et fluidit√©<br>
  √Ä REMPLIR
</p>

<p>üé¨ Exp√©rience cin√©ma<br>
  √Ä REMPLIR
</p>`,
          CAMERA: `<p>üé• Fonctions vid√©o<br>
  √Ä REMPLIR
</p>`,
          "VIDEO PROJECTEUR": `<p>üñ•Ô∏è Qualit√© d'image<br>
  √Ä REMPLIR
</p>

<p>üéÆ Gaming et fluidit√©<br>
  √Ä REMPLIR
</p>

<p>üé¨ Exp√©rience cin√©ma<br>
  √Ä REMPLIR
</p>`,
          "BOX INTERNET": `<p>üì∫ Services TV et multim√©dia<br>
  √Ä REMPLIR
</p>`,
          "TABLEAU INTERACTIF": `<p>üñäÔ∏è Fonctions interactives<br>
  √Ä REMPLIR
</p>`,
          "CASQUE VR": `<p>üéÆ Fonctions VR et MR<br>
  √Ä REMPLIR
</p>`,
          "IMPRIMANTE 3D": `<p>üñ®Ô∏è Fonctions avanc√©es<br>
  √Ä REMPLIR
</p>`,
          DEFAULT: "",
        };

        return templates[categorie] || templates["DEFAULT"];
      }

      // G√©n√©rer la page HTML vide
      function generateEmptyHTMLPage(product) {
        const fileName = product.nom
          .replace(/[^a-zA-Z0-9]/g, "-")
          .toLowerCase();
        const categorySpecificTemplate = getCategoryTemplate(product.categorie);

        const htmlContent = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>${product.nom}</title>
  <link rel="stylesheet" href="../../assets/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Manrope&family=Montserrat&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

  <div class="entete">
    <img src="../../assets/images/gaming.png" alt="Gaming">
    <a href="../../top-du-mois.html">Retour √† la vitrine</a>
  </div>

  <h1>${product.nom}</h1>

  <div id="badge-top-mois"></div>
  
  <p class="description">√Ä REMPLIR - Description rapide du produit.</p>
  
  <div class="gallery">
    <img src="../../assets/images/placeholder.png" alt="${product.nom}" class="img-centree">
  </div>
  <div class="lightbox" id="lightbox">
    <img id="lightbox-img" src="" alt="Zoom" />
  </div>

  <!-- Les paragraphes seront remplis dynamiquement -->
  <div id="product-content">
    <!-- Le contenu sera inject√© ici par JavaScript -->
  </div>

  <script>
    const g = document.querySelector(".gallery img");
    const l = document.getElementById("lightbox");
    const z = document.getElementById("lightbox-img");
    if (g) {
      g.addEventListener("click", () => { l.style.display = "flex"; z.src = g.src; });
      l.addEventListener("click", () => l.style.display = "none");
    }

    const nomProduit = document.querySelector("h1").textContent.trim();

    // Charger et afficher TOUTES les donn√©es depuis le JSON
    fetch("../../data/equipements.json")
      .then(res => res.json())
      .then(data => {
    const produits = Array.isArray(data) ? data : (data.equipements || []);
    const produit = produits.find(p => p.nom === nomProduit);
          
        if (produit) {
          console.log("Produit trouv√©:", produit);
          
          // Badge top du mois
          if (produit.top_du_mois) {
            document.getElementById("badge-top-mois").innerHTML = \`
              <div style="background:#ffde59;padding:8px;margin-bottom:10px;text-align:center;border-radius:8px;">
                ‚≠ê Ce produit est en vedette ce mois-ci !
              </div>\`;
          }
          
          // Mettre √† jour la description
          const description = document.querySelector('.description');
          if (description && produit.description) {
            description.textContent = produit.description;
          }
          
          // Mettre √† jour l'image
          if (produit.image) {
            const img = document.querySelector('.gallery img');
            if (img) {
              img.src = '../../' + produit.image;
              img.alt = produit.nom;
            }
          }
          
          // IMPORTANT : Cr√©er dynamiquement tous les paragraphes depuis donnees_fiche
          const contentDiv = document.getElementById('product-content');
          if (contentDiv && produit.donnees_fiche && produit.donnees_fiche.length > 0) {
            // Vider le contenu existant
            contentDiv.innerHTML = '';
            
            // Cr√©er un paragraphe pour chaque donn√©e (sauf la premi√®re qui est la description)
            produit.donnees_fiche.forEach((donnee, index) => {
              if (index > 0) { // Skip la premi√®re ligne (description)
                const p = document.createElement('p');
                p.innerHTML = donnee.replace(/\\\\n/g, '<br>').replace(/\\n/g, '<br>');
                contentDiv.appendChild(p);
              }
            });
          } else {
            // Si pas de donn√©es, afficher le template par d√©faut
            const contentDiv = document.getElementById('product-content');
            contentDiv.innerHTML = \`
              <p>üí∞ Prix : √Ä D√âFINIR ‚Ç¨</p>
              <p>üß© Sp√©cifications mat√©rielles<br>√Ä REMPLIR</p>
              ${categorySpecificTemplate}
              <p>üåê Fonctionnalit√©s connect√©es<br>√Ä REMPLIR</p>
              <p>üéÆ Exp√©rience utilisateur<br>√Ä REMPLIR</p>
            \`;
          }
        } else {
          console.log("Produit non trouv√© dans le JSON");
          // Afficher le contenu par d√©faut si le produit n'est pas trouv√©
          const contentDiv = document.getElementById('product-content');
          contentDiv.innerHTML = \`
            <p>üí∞ Prix : √Ä D√âFINIR ‚Ç¨</p>
            <p>üß© Sp√©cifications mat√©rielles<br>√Ä REMPLIR</p>
            ${categorySpecificTemplate}
            <p>üåê Fonctionnalit√©s connect√©es<br>√Ä REMPLIR</p>
            <p>üéÆ Exp√©rience utilisateur<br>√Ä REMPLIR</p>
          \`;
        }
      })
      .catch(err => {
        console.error("Erreur chargement JSON :", err);
        // En cas d'erreur, afficher le contenu par d√©faut
        const contentDiv = document.getElementById('product-content');
        contentDiv.innerHTML = \`
          <p>üí∞ Prix : √Ä D√âFINIR ‚Ç¨</p>
          <p>üß© Sp√©cifications mat√©rielles<br>√Ä REMPLIR</p>
          ${categorySpecificTemplate}
          <p>üåê Fonctionnalit√©s connect√©es<br>√Ä REMPLIR</p>
          <p>üéÆ Exp√©rience utilisateur<br>√Ä REMPLIR</p>
        \`;
      });
  <\/script>
  
  <footer class="footer">
    <img src="../../assets/images/banniere-pied.png" alt="Banni√®re" class="footer-banner">
    <div class="footer-links">
      <div class="footer-item">
        <img src="../../assets/images/logo-blanc.png" alt="Accueil" class="footer-icon">
        <a href="../../index.html">Accueil</a>
      </div>
      <div class="footer-item">
        <img src="../../assets/images/logo-dokk-blanc.png" alt="Multibloc" class="footer-icon">
        <a href="equipements.html">√âquipements</a>
      </div>
    </div>
  </footer>

</body>
<script src="../../assets/js/utils.js"><\/script>
</html>`;

        // T√©l√©charger le fichier HTML
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${fileName}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        console.log("‚úÖ Page HTML g√©n√©r√©e:", `${fileName}.html`);
        return `${fileName}.html`;
      }

      // Fonction pour t√©l√©charger le JSON
      function downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log("‚úÖ JSON t√©l√©charg√©:", filename);
      }

      // FONCTION PRINCIPALE
      async function generateCompleteProduct(nom, categorie) {
        try {
          console.log(`üöÄ G√©n√©ration de ${nom} (${categorie})`);

          // 1. Cr√©er le template JSON
          const productTemplate = createProductTemplate(nom, categorie);
          console.log("‚úÖ Template JSON cr√©√©:", productTemplate);

          // 2. Ajouter au JSON existant
          await addProductToJSON(productTemplate);

          // 3. G√©n√©rer la page HTML vide
          const htmlFile = generateEmptyHTMLPage(productTemplate);

          return {
            success: true,
            htmlFile: htmlFile,
            product: nom,
          };
        } catch (error) {
          console.error("‚ùå Erreur g√©n√©ration compl√®te:", error);
          throw error;
        }
      }

      // Gestionnaire du formulaire
      document
        .getElementById("product-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const nom = document.getElementById("product-name").value.trim();
          const categorie = document.getElementById("product-category").value;
          const resultDiv = document.getElementById("generation-result");

          if (!nom || !categorie) {
            resultDiv.innerHTML =
              '<div class="alert alert-danger">‚ùå Veuillez remplir tous les champs obligatoires.</div>';
            return;
          }

          resultDiv.innerHTML =
            '<div class="alert alert-info">‚è≥ G√©n√©ration en cours...</div>';

          try {
            const result = await generateCompleteProduct(nom, categorie);
            resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ <strong>Produit g√©n√©r√© avec succ√®s !</strong><br>
                        üìÑ Fichier JSON mis √† jour : equipement.json<br>
                        üìÑ Page HTML cr√©√©e : ${result.htmlFile}<br>
                        ‚ÑπÔ∏è Les fichiers sont pr√™ts √† √™tre personnalis√©s
                    </div>
                `;

            // Reset form
            document.getElementById("product-form").reset();
          } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå <strong>Erreur:</strong> ${error.message}</div>`;
          }
        });

      // Tests
      async function testProductGeneration() {
        const resultDiv = document.getElementById("test-result");
        resultDiv.innerHTML =
          '<div class="alert alert-info">‚è≥ Test Nintendo Switch 2 Pro...</div>';

        try {
          const result = await generateCompleteProduct(
            "Nintendo Switch 2 Pro",
            "CONSOLE"
          );
          resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ <strong>Test r√©ussi !</strong> Nintendo Switch 2 Pro g√©n√©r√©<br>
                        üìÑ HTML: ${result.htmlFile}
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Test √©chou√©: ${error.message}</div>`;
        }
      }

      async function testDroneGeneration() {
        const resultDiv = document.getElementById("test-result");
        resultDiv.innerHTML =
          '<div class="alert alert-info">‚è≥ Test Drone X-Pro 2025...</div>';

        try {
          const result = await generateCompleteProduct(
            "Drone X-Pro 2025",
            "DRONE"
          );
          resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ <strong>Test r√©ussi !</strong> Drone X-Pro 2025 g√©n√©r√©<br>
                        üìÑ HTML: ${result.htmlFile}
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Test √©chou√©: ${error.message}</div>`;
        }
      }

      console.log("‚úÖ Interface d'administration charg√©e !");

      // Variables globales
      let currentProducts = [];
      let currentEditingProduct = null;

      // Charger la liste des produits au d√©marrage
      loadProductsList();

      // Fonction pour charger la liste des produits
      async function loadProductsList() {
        try {
          const select = document.getElementById("product-select");
          select.innerHTML =
            '<option value="">-- Choisir un produit --</option>';

          // Charger le vrai fichier JSON
          const response = await fetch("data/equipements.json");
          const data = await response.json();

          // Le JSON est directement un tableau, pas un objet avec "equipements"
          currentProducts = Array.isArray(data) ? data : data.equipements || [];

          // Afficher tous les produits dans la liste
          currentProducts.forEach((product) => {
            const option = document.createElement("option");
            option.value = product.id || product.nom;
            option.textContent = `${product.nom} (${product.categorie})`;
            select.appendChild(option);
          });

          console.log(`‚úÖ ${currentProducts.length} produits charg√©s`);
        } catch (error) {
          console.error("‚ùå Erreur chargement produits:", error);

          // Message d'erreur dans l'interface
          const resultDiv = document.getElementById("edit-result");
          if (resultDiv) {
            resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            ‚ùå Impossible de charger les produits. 
                            V√©rifiez que le fichier <strong>data/equipements.json</strong> est accessible.
                        </div>
                    `;
          }
        }
      }

      // Fonction pour charger un produit dans le formulaire d'√©dition
      function loadProductForEdit() {
        const select = document.getElementById("product-select");
        const productId = select.value;

        if (!productId) {
          document.getElementById("edit-form").style.display = "none";
          return;
        }

        // Trouver le produit dans la liste charg√©e
        const product = currentProducts.find(
          (p) => (p.id && p.id === productId) || p.nom === productId
        );

        if (!product) {
          console.error("Produit non trouv√©:", productId);
          return;
        }

        currentEditingProduct = product;

        // Remplir le formulaire avec les vraies donn√©es
        document.getElementById("edit-nom").value = product.nom || "";
        document.getElementById("edit-categorie").value =
          product.categorie || "";
        document.getElementById("edit-prix").value =
          product.prix || "√Ä D√âFINIR ‚Ç¨";
        document.getElementById("edit-description").value =
          product.description || "";
        document.getElementById("edit-image").value = product.image || "";
        document.getElementById("edit-top").value = product.top_du_mois
          ? "true"
          : "false";
        document.getElementById("edit-fonctionnalites").value = (
          product.fonctionnalites_avancees || []
        ).join("\n");

        // G√©n√©rer les champs pour donnees_fiche
        generateDonneesFicheFields(product);

        // Afficher le formulaire
        document.getElementById("edit-form").style.display = "block";

        console.log("‚úÖ Produit charg√© pour √©dition:", product.nom);
      }

      // G√©n√©rer les champs pour les donn√©es de la fiche
      function generateDonneesFicheFields(product) {
        const container = document.getElementById("donnees-fiche-container");
        container.innerHTML = "";

        const fields = [
          { label: "Description d√©taill√©e", id: "fiche-description" },
          { label: "Prix (avec emoji üí∞)", id: "fiche-prix" },
          { label: "Sp√©cifications mat√©rielles üß©", id: "fiche-specs" },
        ];

        // Ajouter les champs sp√©cifiques selon la cat√©gorie
        const categoryFields = getCategorySpecificFields(product.categorie);
        fields.push(...categoryFields);

        // Ajouter les champs finaux
        fields.push(
          { label: "Fonctionnalit√©s connect√©es üåê", id: "fiche-connectees" },
          { label: "Exp√©rience utilisateur üéÆ", id: "fiche-experience" }
        );

        // Cr√©er les textarea pour chaque champ
        fields.forEach((field, index) => {
          const div = document.createElement("div");
          div.className = "form-group";
          div.innerHTML = `
                    <label>${field.label}</label>
                    <textarea id="${
                      field.id
                    }" rows="3" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Manrope', sans-serif;">${
            product.donnees_fiche[index] || "√Ä REMPLIR"
          }</textarea>
                `;
          container.appendChild(div);
        });
      }

      // Obtenir les champs sp√©cifiques selon la cat√©gorie
      function getCategorySpecificFields(categorie) {
        const fields = {
          DRONE: [{ label: "Fonctions vid√©o üé•", id: "fiche-video" }],
          CONSOLE: [
            { label: "√âcran et affichage üñ•Ô∏è", id: "fiche-ecran" },
            { label: "Contr√¥leurs et interaction üïπÔ∏è", id: "fiche-controleurs" },
          ],
          TABLETTE: [
            { label: "√âcran et affichage üñ•Ô∏è", id: "fiche-ecran" },
            { label: "Accessoires et interaction üñäÔ∏è", id: "fiche-accessoires" },
          ],
          SMARTPHONE: [{ label: "Appareil photo üì∏", id: "fiche-photo" }],
          "PC GAMING": [{ label: "Fonctions gaming üéÆ", id: "fiche-gaming" }],
          SERVEUR: [
            { label: "Performances et virtualisation üñ•Ô∏è", id: "fiche-perf" },
          ],
          PERIPHERIQUES: [
            { label: "Ergonomie et design üñ•Ô∏è", id: "fiche-ergo" },
          ],
          "CASQUE AUDIO": [{ label: "Fonctions audio üéß", id: "fiche-audio" }],
          "MONTRE CONNECTE": [
            { label: "Fonctions sport et sant√© ‚åö", id: "fiche-sante" },
          ],
          "ECRAN TV": [
            { label: "Qualit√© d'image üñ•Ô∏è", id: "fiche-image" },
            { label: "Gaming et fluidit√© üéÆ", id: "fiche-gaming" },
            { label: "Exp√©rience cin√©ma üé¨", id: "fiche-cinema" },
          ],
          CAMERA: [{ label: "Fonctions vid√©o üé•", id: "fiche-video" }],
          "VIDEO PROJECTEUR": [
            { label: "Qualit√© d'image üñ•Ô∏è", id: "fiche-image" },
            { label: "Gaming et fluidit√© üéÆ", id: "fiche-gaming" },
            { label: "Exp√©rience cin√©ma üé¨", id: "fiche-cinema" },
          ],
          "BOX INTERNET": [
            { label: "Services TV et multim√©dia üì∫", id: "fiche-tv" },
          ],
          "TABLEAU INTERACTIF": [
            { label: "Fonctions interactives üñäÔ∏è", id: "fiche-interactif" },
          ],
          "CASQUE VR": [{ label: "Fonctions VR et MR üéÆ", id: "fiche-vr" }],
          "IMPRIMANTE 3D": [{ label: "Fonctions avanc√©es üñ®Ô∏è", id: "fiche-3d" }],
        };

        return fields[categorie] || [];
      }

      // Sauvegarder les modifications
      document
        .getElementById("product-edit-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          if (!currentEditingProduct) return;

          // R√©cup√©rer les valeurs du formulaire
          currentEditingProduct.prix =
            document.getElementById("edit-prix").value;
          currentEditingProduct.description =
            document.getElementById("edit-description").value;
          currentEditingProduct.image =
            document.getElementById("edit-image").value;
          currentEditingProduct.top_du_mois =
            document.getElementById("edit-top").value === "true";
          currentEditingProduct.fonctionnalites_avancees = document
            .getElementById("edit-fonctionnalites")
            .value.split("\n")
            .filter((f) => f.trim());

          // R√©cup√©rer les donn√©es de la fiche
          const donneesFiche = [];
          const textareas = document.querySelectorAll(
            "#donnees-fiche-container textarea"
          );
          textareas.forEach((textarea) => {
            donneesFiche.push(textarea.value);
          });
          currentEditingProduct.donnees_fiche = donneesFiche;

          // Afficher le r√©sultat
          document.getElementById("edit-result").innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>Produit modifi√© avec succ√®s !</strong><br>
                    üí° Utilisez le bouton "T√©l√©charger le JSON modifi√©" pour obtenir le fichier mis √† jour.<br>
                    ‚ö†Ô∏è N'oubliez pas de remplacer le fichier equipements.json sur votre serveur.
                </div>
            `;

          console.log("Produit modifi√©:", currentEditingProduct);
        });

      // T√©l√©charger le JSON modifi√©
      function downloadEditedJSON() {
        if (!currentEditingProduct) {
          alert("Aucun produit en cours d'√©dition");
          return;
        }

        // Mettre √† jour le produit dans la liste compl√®te
        const index = currentProducts.findIndex(
          (p) =>
            (p.id && p.id === currentEditingProduct.id) ||
            p.nom === currentEditingProduct.nom
        );

        if (index !== -1) {
          currentProducts[index] = currentEditingProduct;
        }

        // Cr√©er le JSON complet avec TOUS les produits
        const data = currentProducts; // ‚Üê Directement le tableau

        // T√©l√©charger
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "equipements.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        console.log("‚úÖ JSON complet t√©l√©charg√© avec tous les produits");
      }
    </script>
  </body>
</html>
