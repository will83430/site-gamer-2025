<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>Produits par Cat√©gorie</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Manrope', sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(135deg, #1f2039 0%, #2d2b69 50%, #1f2039 100%);
      min-height: 100vh;
      position: relative;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      color: white;
      margin-bottom: 10px;
    }

    .description {
      text-align: center;
      color: #ccc;
      margin-bottom: 30px;
    }

    .produits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 10px;
      padding: 20px;
      justify-content: center;
      justify-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .fiche-produit {
      background-color: lightblue;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      text-align: center;
      transition: transform 0.3s ease-in-out;
      cursor: pointer;
      display: grid;
      align-items: center;
      justify-content: center;
      padding: 15px;
      width: 300px;
      height: 300px;
      margin: 10px auto;
      font-size: 20px;
      font-weight: bold;
      position: relative;
    }

    .fiche-produit:hover {
      transform: translateY(-5px);
    }

    .fiche-produit img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .overlay-text, .overlay-text-produit {
      padding: 8px 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: #222;
      min-height: 48px;
    }

    .vedette-badge {
      background-color: transparent;
      color: #222;
      font-size: 0.85em;
      padding: 3px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }

    .message-erreur {
      text-align: center;
      color: #c0392b;
      grid-column: 1 / -1;
    }

    a, .category-link {
      text-decoration: none;
      color: #242424;
      cursor: pointer;
    }

    .info {
      font-size: 1rem;
      color: #555;
      margin-top: 8px;
      flex-grow: 1;
    }

    /* Zone de comparaison */
    #zone-comparaison {
      margin-top: 40px;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }

    #zone-comparaison h2 {
      color: white;
      font-size: 1.6rem;
      margin-bottom: 20px;
      text-align: center;
    }

    #comparaison-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      justify-content: center;
    }

    .fiche-comparaison {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      text-align: center;
    }

    .fiche-comparaison img {
      height: 150px;
      object-fit: cover;
      background-color: #eee;
      border-radius: 8px;
      margin-bottom: 10px;
      width: 100%;
    }

    /* Boutons */
    .btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-decoration: none;
      text-align: center;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    #btn-comparer {
      padding: 12px 25px;
      max-width: 300px;
      width: 100%;
      margin-top: 30px;
    }

    #btn-retour {
      max-width: 120px;
      width: 100%;
      margin-bottom: 20px;
    }

    .btn-details {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .btn-details:hover {
      background-color: #0056b3;
    }

    /* Checkbox personnalis√©e */
    input[type="checkbox"].produit-checkbox {
      transform: scale(1.4);
      accent-color: #007bff;
      margin-bottom: 12px;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }

    /* √âtats cach√©s */
    .hidden {
      display: none;
    }

    /* Mode cat√©gories sp√©cifique */
    .category-selector {
      background-color: lightblue;
      color: #242424;
    }

    .category-selector .overlay-text-produit {
      color: #242424;
      font-size: 20px;
      font-weight: bold;
      text-decoration: none;
    }

    /* Mode produits sp√©cifique */
    .fiche-produit:not(.category-selector) {
      background-color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 240px;
      min-height: 360px;
      height: auto;
    }

    /* Messages d'erreur stylis√©s */
    .error-message {
      text-align: center;
      color: #c0392b;
      background: #ffeaa7;
      padding: 20px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 600px;
      border: 1px solid #fdcb6e;
    }

    .loader {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2rem;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .product-link {
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .product-link:hover {
      transform: translateY(-2px);
    }

    .product-link:hover::after {
      content: "üîó Cliquer pour ouvrir";
      position: absolute;
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 123, 255, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Indicateur d'onglets ouverts */
    .tabs-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 123, 255, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }

    .tabs-indicator.show {
      display: flex;
    }

    .close-all-tabs {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 10px;
    }

    .close-all-tabs:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .fiche-produit {
        width: 100%;
        max-width: 280px;
      }

      h1 {
        font-size: 1.5rem;
      }
      
      .product-link:hover::after {
        display: none; /* Masquer les tooltips sur mobile */
      }
    }
  </style>
</head>

<body>
  <button id="btn-retour" class="btn">‚Üê Retour</button>
  <h1 id="titre-categorie">Chargement...</h1>
  <p class="description" id="desc-cat"></p>

  <div id="zone-fiches" class="produits-grid"></div>

  <!-- Indicateur d'onglets ouverts -->
  <div id="tabs-indicator" class="tabs-indicator">
    <span id="tabs-count">üìÑ 1 onglet ouvert</span>
    <button id="close-all-tabs" class="close-all-tabs">Fermer tout</button>
  </div>

  <button id="btn-comparer" class="btn">Comparer les produits s√©lectionn√©s</button>
  
  <div id="zone-comparaison" class="hidden">
    <h2>Produits Compar√©s</h2>
    <div id="comparaison-content"></div>
  </div>

  <script>
    // ====================================
    // CONFIGURATION ET VARIABLES GLOBALES
    // ====================================
    
    const CONFIG = {
      JSON_PATH: '../../frontend/public/data/equipements.json',
    
    };

    let currentCategory = '';
    let currentProducts = [];
    let cachedData = null;
    let tabManager = null;

    // √âl√©ments DOM avec v√©rification d'existence
    const elements = {
      get titre() { return document.getElementById("titre-categorie"); },
      get desc() { return document.getElementById("desc-cat"); },
      get zone() { return document.getElementById("zone-fiches"); },
      get btnComparer() { return document.getElementById("btn-comparer"); },
      get btnRetour() { return document.getElementById("btn-retour"); },
      get zoneComparaison() { return document.getElementById("zone-comparaison"); },
      get comparaisonContent() { return document.getElementById("comparaison-content"); }
    };

    // ====================================
    // GESTIONNAIRE D'ONGLETS POUR FERMETURE AUTOMATIQUE
    // ====================================
    
    class TabManager {
      constructor() {
        this.openTabs = new Set();
        this.setupMessageListener();
      }
      
      // Ouvrir un onglet produit et fermer les anciens
      openProductTab(productUrl, productName) {
        // Fermer les anciens onglets de produits
        this.closeAllProductTabs();
        
        // Ouvrir le nouveau
        const newTab = window.open(
          productUrl, 
          `product_${Date.now()}`,
          'width=1200,height=800,scrollbars=yes,resizable=yes'
        );
        
        if (newTab) {
          this.openTabs.add(newTab);
          
          // Envoyer des infos √† l'onglet ouvert apr√®s chargement
          setTimeout(() => {
            try {
              newTab.postMessage({
                type: 'PRODUCT_TAB_OPENED',
                productName: productName,
                parentOrigin: window.location.origin
              }, '*');
            } catch (error) {
              console.log('Message non envoy√© (onglet externe)');
            }
          }, 1000);
          
          // Nettoyer les r√©f√©rences ferm√©es
          const checkClosed = setInterval(() => {
            if (newTab.closed) {
              this.openTabs.delete(newTab);
              clearInterval(checkClosed);
            }
          }, 1000);
        }
        
        return newTab;
      }
      
      closeAllProductTabs() {
        this.openTabs.forEach(tab => {
          if (!tab.closed) {
            try {
              tab.close();
            } catch (error) {
              console.log('Impossible de fermer l\'onglet');
            }
          }
        });
        this.openTabs.clear();
      }
      
      setupMessageListener() {
        window.addEventListener('message', (event) => {
          if (event.data.type === 'CLOSE_PRODUCT_TAB') {
            // L'onglet produit demande √† se fermer
            this.openTabs.forEach(tab => {
              if (tab === event.source) {
                tab.close();
                this.openTabs.delete(tab);
              }
            });
          }
        });
        
        // Fermer tous les onglets quand la page principale se ferme
        window.addEventListener('beforeunload', () => {
          this.closeAllProductTabs();
        });
      }
      
      getOpenTabsCount() {
        // Nettoyer les onglets ferm√©s
        this.openTabs.forEach(tab => {
          if (tab.closed) {
            this.openTabs.delete(tab);
          }
        });
        return this.openTabs.size;
      }
    }

    // ====================================
    // UTILITAIRES
    // ====================================
    
    const utils = {
      normalizeCat: (str) => str ? str.toUpperCase().replace(/\s|_/g, "") : '',
      beautifyCat: (cat) => cat ? cat.charAt(0).toUpperCase() + cat.slice(1).toLowerCase() : '',
      getUrlParam: (param) => {
        try {
          return new URLSearchParams(window.location.search).get(param) || "";
        } catch (error) {
          console.error('Erreur getUrlParam:', error);
          return "";
        }
      },
      sanitizeId: (str) => str ? str.replace(/\s/g, '-').replace(/[^a-zA-Z0-9-]/g, '') : '',
      createPlaceholder: (text) => `${CONFIG.PLACEHOLDER_IMAGE}${encodeURIComponent(text)}${CONFIG.PLACEHOLDER_SUFFIX}`,
      handleImageError: (img, fallbackText) => {
        if (img.src.includes('data:image/svg+xml')) {
          img.style.display = 'none';
          return;
        }
        img.src = utils.createPlaceholder(fallbackText);
      }
    };

    // ====================================
    // GESTIONNAIRE DE DONN√âES
    // ====================================
    
    const dataManager = {
      async loadData() {
        if (cachedData) {
          return cachedData;
        }

        try {
          const response = await fetch(CONFIG.JSON_PATH);
          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }
          
          cachedData = await response.json();
          
          if (!Array.isArray(cachedData)) {
            throw new Error('Format de donn√©es invalide');
          }
          
          return cachedData;
        } catch (error) {
          console.error("Erreur lors du chargement des donn√©es :", error);
          throw new Error("Impossible de charger les donn√©es: " + error.message);
        }
      }
    };

    // ====================================
    // GESTION DES ERREURS ET CHARGEMENT
    // ====================================
    
    function showError(message) {
      const zone = elements.zone;
      if (zone) {
        zone.innerHTML = `
          <div class="error-message">
            <strong>‚ö†Ô∏è Erreur</strong><br>
            ${message}
          </div>
        `;
      }
    }

    function showLoader() {
      const zone = elements.zone;
      if (zone) {
        zone.innerHTML = `
          <div class="loader">
            <div class="spinner"></div>
            <br>Chargement en cours...
          </div>
        `;
      }
    }

    // ====================================
    // FILTRAGE ET NAVIGATION
    // ====================================
    
    function filterByCategory(data, category) {
      if (!data || !Array.isArray(data) || !category) return [];
      
      return data.filter(item => 
        item && item.categorie && 
        utils.normalizeCat(item.categorie) === utils.normalizeCat(category)
      );
    }

    function setupReturnButton() {
      const btnRetour = elements.btnRetour;
      if (btnRetour) {
        btnRetour.addEventListener("click", () => {
          if (document.referrer && document.referrer.includes(window.location.origin)) {
            window.history.back();
          } else {
            window.location.href = '/';
          }
        });
      }
    }

    function navigateToCategory(category) {
      try {
        const newUrl = `${window.location.pathname}?cat=${encodeURIComponent(category)}`;
        window.history.pushState({}, '', newUrl);
        initializePage();
      } catch (error) {
        console.error('Erreur navigateToCategory:', error);
        window.location.href = `?cat=${encodeURIComponent(category)}`;
      }
    }

    // ====================================
    // AFFICHAGE DES CAT√âGORIES
    // ====================================
    
    function displayAllCategories(data) {
      try {
        const categories = [...new Set(data.map(item => item.categorie))].filter(Boolean);
        
        if (elements.titre) elements.titre.textContent = "Choisis une cat√©gorie";
        if (elements.desc) elements.desc.textContent = "Clique sur une cat√©gorie pour d√©couvrir ses √©quipements.";
        
        if (elements.zone) {
          elements.zone.innerHTML = categories.map(category => `
            <div class="fiche-produit category-selector">
              <div class="category-link" data-category="${category}">
                <img src="${CONFIG.CATEGORY_IMAGE_PATH}${category.toLowerCase().replace(/\s/g, '-')}.jpg" 
                     alt="${category}" 
                     onerror="utils.handleImageError(this, '${category}')">
                <div class="overlay-text-produit">${category}</div>
              </div>
            </div>
          `).join("");
          
          setupCategoryNavigation();
        }
      } catch (error) {
        console.error('Erreur displayAllCategories:', error);
        showError('Erreur lors de l\'affichage des cat√©gories');
      }
    }

    function setupCategoryNavigation() {
      const links = document.querySelectorAll('.category-link');
      links.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const category = link.dataset.category;
          if (category) {
            navigateToCategory(category);
          }
        });
      });
    }

    // ====================================
    // AFFICHAGE DES PRODUITS
    // ====================================
    
    function displayCategoryProducts(category, products) {
      try {
        if (elements.titre) {
          elements.titre.textContent = `Cat√©gorie : ${utils.beautifyCat(category)}`;
        }
        if (elements.desc) {
          elements.desc.textContent = `${products.length} produit(s) disponible(s)`;
        }
        
        if (elements.zone) {
          elements.zone.innerHTML = products.map(product => {
            const productId = utils.sanitizeId(product.nom || 'produit');
            const productName = product.nom || 'Produit sans nom';
            const productPrice = product.prix || 'Non disponible';
            const productDesc = product.description || 'Aucune description';
            const productLink = product.lien || '#';
            const productImage = product.image || '';
            
            return `
              <div class="fiche-produit" data-product-id="${productId}">
                <input type="checkbox" 
                       class="produit-checkbox" 
                       id="produit-${productId}" 
                       data-id="${productName}">
                <a href="#" 
                   class="product-link"
                   data-url="${productLink}"
                   data-name="${productName}"
                   title="${productDesc}">
                  <img src="${productImage}" 
                       alt="${productName}"
                       loading="lazy"
                       onerror="utils.handleImageError(this, '${productName}');" />
                  <div class="overlay-text-produit">
                    ${productName}
                    ${product.top_du_mois ? `<span class="vedette-badge">‚≠ê</span>` : ""}
                  </div>
                </a>
                <p class="info">Prix : ${productPrice}</p>
                <p class="info">${productDesc}</p>
              </div>
            `;
          }).join("");
          
          // Ajouter les √©v√©nements pour les liens produits
          setupProductLinks();
        }
        
      } catch (error) {
        console.error('Erreur displayCategoryProducts:', error);
        showError('Erreur lors de l\'affichage des produits');
      }
    }

    function setupProductLinks() {
      document.querySelectorAll('.product-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const url = link.dataset.url;
          const name = link.dataset.name;
          
          if (url && url !== '#') {
            // Utiliser le gestionnaire d'onglets pour ouvrir le produit
            tabManager.openProductTab(url, name);
            
            // Ajouter un effet visuel
            link.style.transform = 'scale(0.95)';
            setTimeout(() => {
              link.style.transform = 'scale(1)';
            }, 150);
          }
        });
      });
    }

    function displayCategoryNotFound(category) {
      if (elements.titre) {
        elements.titre.textContent = "Cat√©gorie introuvable";
      }
      if (elements.desc) {
        elements.desc.textContent = "";
      }
      showError(`Aucun produit trouv√© pour la cat√©gorie "${category}".`);
    }

    // ====================================
    // SYST√àME DE COMPARAISON
    // ====================================
    
    function setupComparison() {
      const btnComparer = elements.btnComparer;
      if (!btnComparer) return;
      
      try {
        // Supprimer les anciens event listeners
        const newBtn = btnComparer.cloneNode(true);
        btnComparer.parentNode.replaceChild(newBtn, btnComparer);
        
        // Configurer le nouveau bouton
        newBtn.addEventListener('click', handleComparisonClick);
        
        // √âcouter les changements de checkbox
        if (elements.zone) {
          elements.zone.addEventListener('change', function(e) {
            if (e.target && e.target.classList.contains('produit-checkbox')) {
              updateComparisonCounter();
            }
          });
        }
        
        updateComparisonCounter();
        
      } catch (error) {
        console.error('Erreur setupComparison:', error);
      }
    }

    function updateComparisonCounter() {
      try {
        const btnComparer = document.getElementById("btn-comparer");
        if (!btnComparer) return;
        
        const checkedBoxes = document.querySelectorAll('.produit-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
          btnComparer.textContent = `Comparer ${count} produit${count > 1 ? 's' : ''} s√©lectionn√©${count > 1 ? 's' : ''}`;
          btnComparer.style.background = '#007bff';
          btnComparer.disabled = false;
        } else {
          btnComparer.textContent = 'Comparer les produits s√©lectionn√©s';
          btnComparer.style.background = '#6c757d';
          btnComparer.disabled = true;
        }
      } catch (error) {
        console.error('Erreur updateComparisonCounter:', error);
      }
    }

    function handleComparisonClick() {
      try {
        const checkboxes = document.querySelectorAll('.produit-checkbox:checked');
        
        if (checkboxes.length === 0) {
          alert("Veuillez s√©lectionner au moins un produit √† comparer.");
          return;
        }
        
        const selectedProducts = Array.from(checkboxes)
          .map(checkbox => {
            const productName = checkbox.getAttribute('data-id');
            return currentProducts.find(item => item && item.nom === productName);
          })
          .filter(Boolean);
        
        if (selectedProducts.length > 0) {
          displayComparison(selectedProducts);
        }
        
      } catch (error) {
        console.error('Erreur handleComparisonClick:', error);
        alert('Erreur lors de la comparaison');
      }
    }

    // ====================================
    // AFFICHAGE DE LA COMPARAISON
    // ====================================
    
    function displayComparison(products) {
      try {
        const zoneComparaison = elements.zoneComparaison;
        const comparaisonContent = elements.comparaisonContent;
        
        if (!zoneComparaison || !comparaisonContent) return;
        
        zoneComparaison.classList.remove('hidden');
        zoneComparaison.querySelector('h2').classList.add('fade-in');
        
        comparaisonContent.innerHTML = products.map(product => {
          const features = [];
          
          if (product.prix) {
            features.push(`üí∞ Prix : ${product.prix}`);
          }
          
          if (product.description && product.description.includes("üß©")) {
            features.push(`üß© ${product.description}`);
          }
          
          if (Array.isArray(product.fonctionnalites_avancees) && product.fonctionnalites_avancees.length > 0) {
            const functionsHTML = product.fonctionnalites_avancees
              .map(f => `<li>${f}</li>`)
              .join("");
            features.push(`‚öôÔ∏è Fonctionnalit√©s avanc√©es :<ul style='text-align:left; padding-left:20px;'>${functionsHTML}</ul>`);
          }
          
          return `
            <div class="fiche-comparaison">
              <h3>${product.nom}</h3>
              <img src="${product.image}" 
                   alt="${product.nom}" 
                   onerror="utils.handleImageError(this, '${product.nom}');" />
              ${features.map(info => `<p class="info">${info}</p>`).join("")}
              <a href="${product.lien}" class="btn-details" target="_blank" rel="noopener noreferrer">Voir la fiche compl√®te</a>
            </div>
          `;
        }).join("");
        
        // Scroll vers la zone de comparaison
        zoneComparaison.scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Erreur displayComparison:', error);
        alert('Erreur lors de l\'affichage de la comparaison');
      }
    }

    // ====================================
    // INDICATEUR D'ONGLETS
    // ====================================
    
    function setupTabsIndicator() {
      const indicator = document.getElementById('tabs-indicator');
      const countSpan = document.getElementById('tabs-count');
      const closeAllBtn = document.getElementById('close-all-tabs');
      
      if (!indicator || !countSpan || !closeAllBtn) return;
      
      // Bouton pour fermer tous les onglets
      closeAllBtn.addEventListener('click', () => {
        tabManager.closeAllProductTabs();
        updateTabsIndicator();
      });
      
      // Mettre √† jour l'indicateur p√©riodiquement
      setInterval(updateTabsIndicator, 2000);
      
      function updateTabsIndicator() {
        const count = tabManager.getOpenTabsCount();
        
        if (count > 0) {
          countSpan.textContent = `üìÑ ${count} onglet${count > 1 ? 's' : ''} ouvert${count > 1 ? 's' : ''}`;
          indicator.classList.add('show');
        } else {
          indicator.classList.remove('show');
        }
      }
    }

    // ====================================
    // INITIALISATION PRINCIPALE
    // ====================================
    
    async function initializePage() {
      try {
        showLoader();
        
        const data = await dataManager.loadData();
        if (!data || !Array.isArray(data)) {
          throw new Error('Donn√©es invalides ou vides');
        }

        const category = utils.getUrlParam("cat");
        
        if (!category) {
          displayAllCategories(data);
          return;
        }
        
        const filteredProducts = filterByCategory(data, category);
        
        if (filteredProducts.length === 0) {
          displayCategoryNotFound(category);
          return;
        }
        
        currentCategory = category;
        currentProducts = filteredProducts;
        displayCategoryProducts(category, filteredProducts);
        setupComparison();
        
      } catch (error) {
        console.error('Erreur initializePage:', error);
        showError('Erreur lors du chargement: ' + error.message);
      }
    }

    // ====================================
    // LANCEMENT DE L'APPLICATION
    // ====================================
    
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Initialisation de la page Fiches');
      
      try {
        if (!elements.zone || !elements.titre) {
          throw new Error('√âl√©ments DOM manquants');
        }

        // Initialiser le gestionnaire d'onglets
        tabManager = new TabManager();
        console.log('‚úÖ Gestionnaire d\'onglets initialis√©');
        
        // Configurer l'indicateur d'onglets
        setupTabsIndicator();

        setupReturnButton();
        await initializePage();
        
        console.log('‚úÖ Page Fiches initialis√©e avec succ√®s');
        
      } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        showError('Erreur lors du chargement de la page: ' + error.message);
      }
    });

    // Support pour la navigation avec les boutons navigateur
    window.addEventListener('popstate', () => {
      initializePage();
    });

    console.log('‚úÖ Script fiches.js charg√© avec gestion d\'erreurs renforc√©e');
  </script>
</body>

</html>