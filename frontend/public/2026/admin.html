<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - HIGH-TECH 2026</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           HIGH-TECH 2026 ADMIN DASHBOARD
           ======================================== */

        :root {
            --tech-yellow: #d4ff00;
            --tech-green: #6bff6b;
            --tech-blue: #4dd4ff;
            --tech-purple: #a78bfa;
            --tech-pink: #ff4da6;
            --tech-red: #ff6b6b;

            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a28;
            --bg-elevated: #222235;

            --text-primary: #f0f0f5;
            --text-secondary: #b8b8c8;
            --text-muted: #80808f;

            --gradient-yellow-green: linear-gradient(135deg, var(--tech-yellow) 0%, var(--tech-green) 100%);
            --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ========================================
           SIDEBAR
           ======================================== */

        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid rgba(212, 255, 0, 0.1);
            padding: 1.5rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            background: var(--gradient-yellow-green);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-logo span {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: block;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: rgba(212, 255, 0, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(212, 255, 0, 0.1);
            color: var(--tech-yellow);
        }

        .nav-item-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .nav-item-badge {
            margin-left: auto;
            background: var(--tech-yellow);
            color: var(--bg-primary);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
        }

        /* ========================================
           MAIN CONTENT
           ======================================== */

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-yellow-green);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 255, 0, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            border-color: var(--tech-yellow);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .btn-danger {
            background: rgba(255, 107, 107, 0.2);
            border-color: var(--tech-red);
            color: var(--tech-red);
        }

        .btn-danger:hover {
            background: var(--tech-red);
            color: white;
        }

        /* Bulk Actions Bar */
        .bulk-actions-bar {
            background: linear-gradient(135deg, rgba(212, 255, 0, 0.1) 0%, rgba(107, 255, 107, 0.1) 100%);
            border: 1px solid var(--tech-yellow);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .bulk-actions-bar span {
            font-weight: 600;
            color: var(--tech-yellow);
        }

        /* View Toggle */
        .view-btn {
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            opacity: 1;
            background: var(--tech-yellow);
            color: var(--bg-primary);
        }

        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-header h3 {
            margin: 0;
            color: var(--tech-yellow);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 0.5rem;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 0.3rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .calendar-day:hover {
            border: 1px solid var(--tech-yellow);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border: 2px solid var(--tech-yellow);
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .calendar-day-events {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
        }

        .calendar-event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .calendar-event-dot.type-info { background: var(--tech-blue); }
        .calendar-event-dot.type-nouveau { background: var(--tech-green); }
        .calendar-event-dot.type-promo { background: #ffd700; }
        .calendar-event-dot.type-urgent { background: var(--tech-red); }

        .calendar-legend {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .calendar-legend span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.type-info { background: var(--tech-blue); }
        .legend-dot.type-nouveau { background: var(--tech-green); }
        .legend-dot.type-promo { background: #ffd700; }
        .legend-dot.type-urgent { background: var(--tech-red); }

        /* Calendar Filter Buttons */
        .calendar-filter .filter-btn {
            opacity: 0.6;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-filter .filter-btn.active {
            opacity: 1;
            background: var(--tech-yellow);
            color: var(--bg-primary);
            border-color: var(--tech-yellow);
        }

        .calendar-day.has-events {
            cursor: pointer;
        }

        .calendar-day.has-events:hover {
            background: rgba(212, 255, 0, 0.1);
            transform: scale(1.05);
        }

        /* Calendar Popup */
        .calendar-popup {
            position: absolute;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--tech-yellow);
            border-radius: 12px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(212, 255, 0, 0.1);
        }

        .popup-close {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .popup-close:hover {
            color: var(--tech-red);
        }

        .popup-content {
            padding: 0.5rem;
        }

        .popup-event {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--bg-elevated);
        }

        .popup-event:last-child {
            margin-bottom: 0;
        }

        .popup-event-icon {
            font-size: 1.5rem;
        }

        .popup-event-info {
            flex: 1;
        }

        .popup-event-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .popup-event-meta {
            display: flex;
            gap: 0.3rem;
        }

        .popup-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .popup-badge.type-info { background: rgba(77, 212, 255, 0.2); color: var(--tech-blue); }
        .popup-badge.type-nouveau { background: rgba(107, 255, 107, 0.2); color: var(--tech-green); }
        .popup-badge.type-promo { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .popup-badge.type-urgent { background: rgba(255, 107, 107, 0.2); color: var(--tech-red); }
        .popup-badge.active { background: rgba(107, 255, 107, 0.2); color: var(--tech-green); }
        .popup-badge.inactive { background: rgba(255, 107, 107, 0.2); color: var(--tech-red); }

        .popup-edit-btn {
            background: none;
            border: 1px solid var(--tech-yellow);
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .popup-edit-btn:hover {
            background: var(--tech-yellow);
        }

        /* ========================================
           STATS CARDS
           ======================================== */

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: rgba(212, 255, 0, 0.2);
            transform: translateY(-3px);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-card-icon.yellow { background: rgba(212, 255, 0, 0.15); }
        .stat-card-icon.green { background: rgba(107, 255, 107, 0.15); }
        .stat-card-icon.blue { background: rgba(77, 212, 255, 0.15); }
        .stat-card-icon.purple { background: rgba(167, 139, 250, 0.15); }

        .stat-card-trend {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .stat-card-trend.up {
            background: rgba(107, 255, 107, 0.15);
            color: var(--tech-green);
        }

        .stat-card-trend.down {
            background: rgba(255, 107, 107, 0.15);
            color: var(--tech-red);
        }

        .stat-card-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-card-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* ========================================
           CONTENT SECTIONS
           ======================================== */

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .content-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .content-card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .content-card-body {
            padding: 1.5rem;
        }

        /* ========================================
           DATA TABLE
           ======================================== */

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: rgba(212, 255, 0, 0.02);
        }

        .data-table-img {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-elevated);
        }

        .data-table-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(107, 255, 107, 0.15); color: var(--tech-green); }
        .badge-warning { background: rgba(212, 255, 0, 0.15); color: var(--tech-yellow); }
        .badge-info { background: rgba(77, 212, 255, 0.15); color: var(--tech-blue); }
        .badge-danger { background: rgba(255, 107, 107, 0.15); color: var(--tech-red); }
        .badge-secondary { background: rgba(160, 160, 176, 0.15); color: var(--text-secondary); }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .action-btn.edit:hover { color: var(--tech-blue); }
        .action-btn.delete:hover { color: var(--tech-red); }

        /* Toggle Switch - Style am√©lior√© */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            cursor: pointer;
            display: inline-block;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            border-radius: 28px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 107, 107, 0.5);
        }

        .toggle-slider::before {
            content: '‚úï';
            position: absolute;
            width: 22px;
            height: 22px;
            left: 2px;
            bottom: 1px;
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #ff6b6b;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #6bff6b 0%, #4ade4a 100%);
            border-color: rgba(107, 255, 107, 0.5);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            content: '‚úì';
            transform: translateX(28px);
            color: #4ade4a;
        }

        .toggle-switch:hover .toggle-slider {
            box-shadow: 0 0 12px rgba(107, 255, 107, 0.5);
            transform: scale(1.05);
        }

        .toggle-switch:active .toggle-slider::before {
            width: 26px;
        }

        /* Drag & Drop */
        .draggable-row {
            cursor: grab;
        }

        .draggable-row:active {
            cursor: grabbing;
        }

        .draggable-row.dragging {
            opacity: 0.5;
            background: rgba(212, 255, 0, 0.1);
        }

        .draggable-row.drag-over {
            border-top: 2px solid var(--tech-yellow);
        }

        .drag-handle {
            cursor: grab;
            padding: 0.5rem;
            color: var(--text-muted);
            font-size: 1rem;
        }

        .drag-handle:hover {
            color: var(--tech-yellow);
        }

        /* Pr√©visualisation Annonce */
        .annonce-preview {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .preview-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(212, 255, 0, 0.08) 0%, rgba(107, 255, 107, 0.08) 100%);
            border: 1px solid rgba(212, 255, 0, 0.3);
        }

        .preview-card.type-promo {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-color: rgba(255, 107, 107, 0.4);
        }

        .preview-card.type-urgent {
            background: linear-gradient(135deg, rgba(255, 77, 166, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
            border-color: rgba(255, 77, 166, 0.5);
        }

        .preview-card.type-nouveau {
            background: linear-gradient(135deg, rgba(107, 255, 107, 0.1) 0%, rgba(212, 255, 0, 0.1) 100%);
            border-color: rgba(107, 255, 107, 0.4);
        }

        .preview-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .preview-text {
            flex: 1;
        }

        .preview-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--tech-yellow);
            margin-bottom: 0.2rem;
        }

        .preview-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .preview-btn {
            padding: 0.5rem 1rem;
            background: rgba(212, 255, 0, 0.1);
            border: 1px solid var(--tech-yellow);
            border-radius: 20px;
            color: var(--tech-yellow);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* ========================================
           FORMS
           ======================================== */

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--tech-yellow);
            box-shadow: 0 0 0 3px rgba(212, 255, 0, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* ========================================
           MODAL
           ======================================== */

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Upload Zone Drag & Drop */
        .upload-zone {
            border: 2px dashed rgba(212, 255, 0, 0.3);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(212, 255, 0, 0.02);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--tech-yellow);
            background: rgba(212, 255, 0, 0.08);
        }

        .upload-zone .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .upload-zone .upload-text {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .upload-zone .upload-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .image-preview-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-card img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .image-preview-card .image-info {
            flex: 1;
        }

        .image-preview-card .image-name {
            font-weight: 500;
            color: var(--tech-green);
        }

        .image-preview-card .image-size {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Champs cat√©gorie */
        .category-fields-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-fields-title {
            color: var(--tech-yellow);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--tech-red);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ========================================
           LOADING & EMPTY STATES
           ======================================== */

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(212, 255, 0, 0.1);
            border-top-color: var(--tech-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* ========================================
           SEARCH & FILTERS
           ======================================== */

        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: #f0f0f5;
            font-size: 0.95rem;
        }

        .search-input-wrapper input:focus {
            outline: none;
            border-color: var(--tech-yellow);
            box-shadow: 0 0 0 3px rgba(212, 255, 0, 0.1);
        }

        .search-input-wrapper input::placeholder {
            color: var(--text-muted);
        }

        .search-input-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
        }

        .filter-select {
            width: auto;
            min-width: 180px;
            max-width: 220px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: #f0f0f5;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--tech-yellow);
        }

        .filter-select option {
            background: var(--bg-card);
            color: #f0f0f5;
        }

        /* ========================================
           RESPONSIVE
           ======================================== */

        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 1rem 0.5rem;
            }

            .sidebar-logo h1,
            .sidebar-logo span,
            .nav-section-title,
            .nav-item span:not(.nav-item-icon) {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 1rem;
            }

            .nav-item-badge {
                display: none;
            }

            .main-content {
                margin-left: 80px;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
">
    <div style="
        background: var(--bg-card);
        padding: 3rem;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(212, 255, 0, 0.2);
        text-align: center;
        max-width: 400px;
        width: 90%;
    ">
        <h1 style="
            font-family: 'Orbitron', sans-serif;
            background: var(--gradient-yellow-green);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        ">HIGH-TECH 2026</h1>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">Administration</p>

        <div id="login-error" style="
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--tech-red);
            color: var(--tech-red);
            padding: 0.8rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            display: none;
        ">Mot de passe incorrect</div>

        <input type="password" id="admin-password" placeholder="Mot de passe" style="
            width: 100%;
            padding: 1rem;
            background: var(--bg-elevated);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1rem;
        " onkeypress="if(event.key==='Enter')adminLogin()">

        <button onclick="adminLogin()" style="
            width: 100%;
            padding: 1rem;
            background: var(--gradient-yellow-green);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--bg-primary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
        ">Connexion</button>

        <a href="/2026/" style="
            display: block;
            margin-top: 1.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
        ">Retour au site</a>
    </div>
</div>

<script>
// Check if already logged in
if (sessionStorage.getItem('adminAuth') === 'true') {
    document.getElementById('login-overlay').style.display = 'none';
}

async function adminLogin() {
    const password = document.getElementById('admin-password').value;
    const errorDiv = document.getElementById('login-error');

    try {
        const response = await fetch('/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (data.success) {
            sessionStorage.setItem('adminAuth', 'true');
            document.getElementById('login-overlay').style.display = 'none';
        } else {
            errorDiv.style.display = 'block';
            document.getElementById('admin-password').value = '';
        }
    } catch (error) {
        errorDiv.textContent = 'Erreur de connexion';
        errorDiv.style.display = 'block';
    }
}
</script>

<div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <div>
                <h1>HIGH-TECH 2026</h1>
                <span>Administration</span>
            </div>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a class="nav-item active" data-section="dashboard">
                    <span class="nav-item-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" data-section="produits">
                    <span class="nav-item-icon">üì¶</span>
                    <span>Produits</span>
                    <span class="nav-item-badge" id="count-produits">0</span>
                </a>
                <a class="nav-item" data-section="articles">
                    <span class="nav-item-icon">üì∞</span>
                    <span>Articles</span>
                    <span class="nav-item-badge" id="count-articles">0</span>
                </a>
                <a class="nav-item" data-section="annonces">
                    <span class="nav-item-icon">üì¢</span>
                    <span>Annonces</span>
                    <span class="nav-item-badge" id="count-annonces">0</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Contenu</div>
                <a class="nav-item" data-section="categories">
                    <span class="nav-item-icon">üè∑Ô∏è</span>
                    <span>Cat√©gories</span>
                </a>
                <a class="nav-item" data-section="technologies">
                    <span class="nav-item-icon">‚ö°</span>
                    <span>Technologies</span>
                </a>
                <a class="nav-item" data-section="marche">
                    <span class="nav-item-icon">üìà</span>
                    <span>March√©</span>
                </a>
                <a class="nav-item" data-section="predictions">
                    <span class="nav-item-icon">üîÆ</span>
                    <span>Pr√©dictions</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Syst√®me</div>
                <a class="nav-item" data-section="stats">
                    <span class="nav-item-icon">üìâ</span>
                    <span>Statistiques</span>
                </a>
                <a class="nav-item" data-section="logs">
                    <span class="nav-item-icon">üìã</span>
                    <span>Logs d'activit√©</span>
                </a>
                <a class="nav-item" data-section="wiki">
                    <span class="nav-item-icon">üìö</span>
                    <span>Wiki</span>
                </a>
                <a class="nav-item" href="/2026/">
                    <span class="nav-item-icon">üåê</span>
                    <span>Voir le site</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="section-dashboard" class="section active">
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshStats()">üîÑ Actualiser</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon yellow">üì¶</div>
                        <span class="stat-card-trend up">‚Üë Actif</span>
                    </div>
                    <div class="stat-card-value" id="stat-produits">--</div>
                    <div class="stat-card-label">Produits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon green">üì∞</div>
                        <span class="stat-card-trend up">‚Üë Actif</span>
                    </div>
                    <div class="stat-card-value" id="stat-articles">--</div>
                    <div class="stat-card-label">Articles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon blue">üëÅÔ∏è</div>
                        <span class="stat-card-trend up">‚Üë 12%</span>
                    </div>
                    <div class="stat-card-value" id="stat-visites">--</div>
                    <div class="stat-card-label">Visites (30j)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon purple">üè∑Ô∏è</div>
                    </div>
                    <div class="stat-card-value" id="stat-categories">--</div>
                    <div class="stat-card-label">Cat√©gories</div>
                </div>
            </div>

            <div class="content-card">
                <div class="content-card-header">
                    <h3 class="content-card-title">Activit√© r√©cente</h3>
                </div>
                <div class="content-card-body" id="recent-activity">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </section>

        <!-- Produits Section -->
        <section id="section-produits" class="section">
            <div class="page-header">
                <h1 class="page-title">Gestion des Produits</h1>
                <div class="header-actions">
                    <span id="featured-counter" style="padding: 0.5rem 1rem; background: var(--bg-elevated); border-radius: var(--radius-md); font-size: 0.9rem; margin-right: 1rem;">‚≠ê Vedettes: <strong>0/4</strong></span>
                    <button class="btn btn-secondary" onclick="exportCSV()" title="Exporter tous les produits">
                        <span style="margin-right: 5px;">üì•</span> Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('csv-import-input').click()" title="Importer des produits depuis un fichier CSV">
                        <span style="margin-right: 5px;">üì§</span> Import CSV
                    </button>
                    <input type="file" id="csv-import-input" accept=".csv" style="display: none;" onchange="importCSV(this)">
                    <button class="btn btn-primary" onclick="openModal('produit')">+ Nouveau Produit</button>
                </div>
            </div>

            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" placeholder="Rechercher un produit..." id="search-produits">
                </div>
                <select class="form-select filter-select" id="filter-categorie-produits">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>

            <div class="content-card">
                <div class="content-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Nom</th>
                                <th>Cat√©gorie</th>
                                <th>Prix</th>
                                <th style="width: 60px;" title="Badge vedette sur le produit">‚≠ê</th>
                                <th style="width: 60px;" title="Afficher sur l'accueil (max 4)">üè†</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-produits">
                            <tr><td colspan="7"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Articles Section -->
        <section id="section-articles" class="section">
            <div class="page-header">
                <h1 class="page-title">Gestion des Articles</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('article')">+ Nouvel Article</button>
                </div>
            </div>

            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" placeholder="Rechercher un article..." id="search-articles">
                </div>
                <select class="form-select filter-select" id="filter-categorie-articles">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>

            <div class="content-card">
                <div class="content-card-body">
                    <table class="data-table" id="articles-table">
                        <thead>
                            <tr id="articles-header">
                                <th id="th-ordre" style="display: none;">Ordre</th>
                                <th>Image</th>
                                <th>Titre</th>
                                <th>Cat√©gorie</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-articles">
                            <tr><td colspan="6"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Annonces Section -->
        <section id="section-annonces" class="section">
            <div class="page-header">
                <h1 class="page-title">Gestion des Annonces</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('annonce')">+ Nouvelle Annonce</button>
                </div>
            </div>

            <!-- Templates rapides -->
            <div class="templates-bar" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <span style="color: var(--text-muted); font-size: 0.85rem; align-self: center;">Templates :</span>
                <button class="btn btn-secondary btn-sm" onclick="createFromTemplate('nouveau')">üÜï Nouveau produit</button>
                <button class="btn btn-secondary btn-sm" onclick="createFromTemplate('promo')">üè∑Ô∏è Promo flash</button>
                <button class="btn btn-secondary btn-sm" onclick="createFromTemplate('urgent')">üö® Alerte stock</button>
                <button class="btn btn-secondary btn-sm" onclick="createFromTemplate('info')">‚ÑπÔ∏è Info g√©n√©rale</button>
            </div>

            <!-- Toggle Vue Liste / Calendrier -->
            <div class="view-toggle" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-sm view-btn active" id="view-list-btn" onclick="switchAnnonceView('list')">üìã Liste</button>
                <button class="btn btn-sm view-btn" id="view-calendar-btn" onclick="switchAnnonceView('calendar')">üìÖ Calendrier</button>
            </div>

            <!-- Barre d'actions group√©es -->
            <div id="bulk-actions-bar" class="bulk-actions-bar" style="display: none;">
                <span id="selected-count">0 s√©lectionn√©(s)</span>
                <button class="btn btn-sm" onclick="bulkToggleActive(true)">‚úÖ Activer</button>
                <button class="btn btn-sm" onclick="bulkToggleActive(false)">‚ùå D√©sactiver</button>
                <button class="btn btn-sm btn-danger" onclick="bulkDelete()">üóëÔ∏è Supprimer</button>
                <button class="btn btn-sm" onclick="clearSelection()">Annuler</button>
            </div>

            <!-- Vue Calendrier -->
            <div id="annonces-calendar-view" class="content-card" style="display: none;">
                <div class="content-card-body">
                    <div class="calendar-header">
                        <button class="btn btn-sm" onclick="changeCalendarMonth(-1)">‚óÄ Pr√©c.</button>
                        <h3 id="calendar-month-title">F√©vrier 2026</h3>
                        <button class="btn btn-sm" onclick="changeCalendarMonth(1)">Suiv. ‚ñ∂</button>
                    </div>
                    <!-- Filtre calendrier -->
                    <div class="calendar-filter" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: center;">
                        <button class="btn btn-sm filter-btn active" id="filter-all" onclick="setCalendarFilter('all')">üìã Toutes</button>
                        <button class="btn btn-sm filter-btn" id="filter-scheduled" onclick="setCalendarFilter('scheduled')">üìÖ Programm√©es</button>
                        <button class="btn btn-sm filter-btn" id="filter-permanent" onclick="setCalendarFilter('permanent')">‚ôæÔ∏è Permanentes</button>
                    </div>
                    <div id="annonces-calendar" class="calendar-grid"></div>
                    <div id="calendar-legend" class="calendar-legend">
                        <span><span class="legend-dot type-info"></span> Info</span>
                        <span><span class="legend-dot type-nouveau"></span> Nouveau</span>
                        <span><span class="legend-dot type-promo"></span> Promo</span>
                        <span><span class="legend-dot type-urgent"></span> Urgent</span>
                    </div>
                </div>
            </div>

            <!-- Vue Liste -->
            <div id="annonces-list-view" class="content-card">
                <div class="content-card-body">
                    <table class="data-table" id="annonces-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"><input type="checkbox" id="select-all-annonces" onchange="toggleSelectAll(this.checked)"></th>
                                <th style="width: 30px;"></th>
                                <th>Ic√¥ne</th>
                                <th>Titre</th>
                                <th>Type</th>
                                <th>Actif</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-annonces">
                            <tr><td colspan="7"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section id="section-stats" class="section">
            <div class="page-header">
                <h1 class="page-title">Statistiques</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadFullStats()">üîÑ Actualiser</button>
                </div>
            </div>

            <!-- Stats Overview Cards -->
            <div class="stats-grid-full" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="stat-card-large" style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--tech-cyan);" id="fs-produits">--</div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">üì¶ Produits</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;" id="fs-top-mois">-- en vedette</div>
                </div>
                <div class="stat-card-large" style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--tech-green);" id="fs-tendances">--</div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">üì∞ Articles Tendances</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;" id="fs-tendances-detail">--</div>
                </div>
                <div class="stat-card-large" style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--tech-purple);" id="fs-visites">--</div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">üëÅÔ∏è Visites Totales</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;" id="fs-derniere-visite">--</div>
                </div>
                <div class="stat-card-large" style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--tech-orange);" id="fs-prix-moyen">--</div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">üí∞ Prix Moyen</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;" id="fs-prix-range">--</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <!-- Category Distribution -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h2 class="content-card-title">üìä R√©partition par Cat√©gorie</h2>
                    </div>
                    <div class="content-card-body" id="fs-categories-chart" style="min-height: 300px;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <!-- Tendances Breakdown -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h2 class="content-card-title">üìà D√©tail Tendances</h2>
                    </div>
                    <div class="content-card-body" id="fs-tendances-chart" style="min-height: 300px;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Logs Section -->
        <section id="section-logs" class="section">
            <div class="page-header">
                <h1 class="page-title">Logs d'activit√©</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadActivityLogs()">üîÑ Actualiser</button>
                    <button class="btn btn-secondary" onclick="clearOldLogs()">üóëÔ∏è Nettoyer (+30j)</button>
                </div>
            </div>

            <!-- Stats rapides -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div class="stat-value" id="logs-total">0</div>
                    <div class="stat-label">Total logs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="logs-24h">0</div>
                    <div class="stat-label">Derni√®res 24h</div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="search-bar">
                <select class="form-select filter-select" id="filter-action-logs" onchange="loadActivityLogs()">
                    <option value="">Toutes les actions</option>
                    <option value="create">Cr√©ation</option>
                    <option value="update">Modification</option>
                    <option value="delete">Suppression</option>
                    <option value="feature">Mise en vedette</option>
                    <option value="unfeature">Retrait vedette</option>
                    <option value="export">Export</option>
                    <option value="import">Import</option>
                </select>
                <select class="form-select filter-select" id="filter-entity-logs" onchange="loadActivityLogs()">
                    <option value="">Tous les types</option>
                    <option value="produit">Produits</option>
                    <option value="article">Articles</option>
                    <option value="categorie">Cat√©gories</option>
                </select>
            </div>

            <div class="content-card">
                <div class="content-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 150px;">Date</th>
                                <th style="width: 100px;">Action</th>
                                <th style="width: 100px;">Type</th>
                                <th>√âl√©ment</th>
                                <th style="width: 120px;">D√©tails</th>
                            </tr>
                        </thead>
                        <tbody id="table-logs">
                            <tr><td colspan="5"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" id="logs-prev" onclick="logsPage > 0 && (logsPage--, loadActivityLogs())" disabled>‚Üê Pr√©c√©dent</button>
                <span id="logs-page-info" style="display: flex; align-items: center; color: var(--text-secondary);">Page 1</span>
                <button class="btn btn-secondary" id="logs-next" onclick="logsPage++; loadActivityLogs()">Suivant ‚Üí</button>
            </div>
        </section>

        <!-- Wiki Section -->
        <section id="section-wiki" class="section">
            <div class="page-header">
                <h1 class="page-title">Wiki</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('wiki')">+ Nouvelle Page</button>
                </div>
            </div>
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" class="search-input" id="search-wiki" placeholder="Rechercher une page...">
                </div>
                <select class="filter-select" id="filter-categorie-wiki">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>
            <div class="content-card">
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Ic√¥ne</th>
                                <th>Titre</th>
                                <th>Slug</th>
                                <th>Cat√©gorie</th>
                                <th>Statut</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-wiki">
                            <tr><td colspan="6"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Categories Section -->
        <section id="section-categories" class="section">
            <div class="page-header">
                <h1 class="page-title">Gestion des Cat√©gories</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('categorie')">+ Nouvelle Cat√©gorie</button>
                </div>
            </div>
            <div class="content-card">
                <div class="content-card-body" id="content-categories"><div class="loading-spinner"></div></div>
            </div>
        </section>

        <!-- Technologies Section -->
        <section id="section-technologies" class="section">
            <div class="page-header">
                <h1 class="page-title">Technologies</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('technologie')">+ Nouvelle Technologie</button>
                </div>
            </div>
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" placeholder="Rechercher une technologie..." id="search-technologies">
                </div>
                <select class="form-select filter-select" id="filter-categorie-technologies">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>
            <div class="content-card">
                <div class="content-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ic√¥ne</th>
                                <th>Titre</th>
                                <th>Cat√©gorie</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-technologies"><tr><td colspan="5"><div class="loading-spinner"></div></td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- March√© Section -->
        <section id="section-marche" class="section">
            <div class="page-header">
                <h1 class="page-title">Donn√©es March√©</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('marche')">+ Nouvelle Donn√©e</button>
                </div>
            </div>
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" placeholder="Rechercher..." id="search-marche">
                </div>
                <select class="form-select filter-select" id="filter-categorie-marche">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>
            <div class="content-card">
                <div class="content-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ic√¥ne</th>
                                <th>Valeur</th>
                                <th>Label</th>
                                <th>Cat√©gorie</th>
                                <th>Tendance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-marche"><tr><td colspan="6"><div class="loading-spinner"></div></td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Pr√©dictions Section -->
        <section id="section-predictions" class="section">
            <div class="page-header">
                <h1 class="page-title">Pr√©dictions</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('prediction')">+ Nouvelle Pr√©diction</button>
                </div>
            </div>
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" placeholder="Rechercher une pr√©diction..." id="search-predictions">
                </div>
                <select class="form-select filter-select" id="filter-categorie-predictions">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>
            <div class="content-card">
                <div class="content-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ic√¥ne</th>
                                <th>Ann√©e</th>
                                <th>Titre</th>
                                <th>Cat√©gorie</th>
                                <th>Probabilit√©</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-predictions"><tr><td colspan="6"><div class="loading-spinner"></div></td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Titre</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            <button class="btn btn-secondary" id="modal-preview" onclick="previewItem()" style="display: none;">üëÅÔ∏è Pr√©visualiser</button>
            <button class="btn btn-primary" id="modal-submit">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Preview Overlay -->
<div class="modal-overlay" id="preview-overlay" style="z-index: 10001;">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
        <div class="modal-header">
            <h3 class="modal-title">Pr√©visualisation</h3>
            <button class="modal-close" onclick="closePreview()">&times;</button>
        </div>
        <div class="modal-body" id="preview-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Preview content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePreview()">Fermer</button>
            <button class="btn btn-primary" onclick="closePreview(); document.getElementById('modal-submit').click();">Enregistrer</button>
        </div>
    </div>
</div>

<script>
    // ========================================
    // NAVIGATION
    // ========================================
    document.querySelectorAll('.nav-item[data-section]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.dataset.section;

            // Update active nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            item.classList.add('active');

            // Show section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${section}`).classList.add('active');

            // Load section data
            loadSectionData(section);
        });
    });

    // ========================================
    // DATA LOADING
    // ========================================
    async function loadSectionData(section) {
        switch(section) {
            case 'dashboard': loadDashboardStats(); break;
            case 'produits': loadProduits(); break;
            case 'articles': loadArticles(); break;
            case 'annonces': loadAnnonces(); break;
            case 'categories': loadCategories(); break;
            case 'technologies': loadTechnologies(); break;
            case 'marche': loadMarche(); break;
            case 'predictions': loadPredictions(); break;
            case 'wiki': loadWiki(); break;
            case 'stats': loadFullStats(); break;
            case 'logs': loadActivityLogs(); break;
        }
    }

    // Helper pour extraire les donn√©es des r√©ponses API
    function extractData(response) {
        if (Array.isArray(response)) return response;
        if (response?.data) return response.data;
        if (response?.success && response?.data) return response.data;
        return [];
    }

    // Convertir les noms d'ic√¥nes textuels en emojis
    function convertIconToEmoji(iconText) {
        const iconMap = {
            // TECHNOLOGIES
            'bluetooth': 'üì°', 'pen': '‚úçÔ∏è', 'hand': '‚úã', 'brain': 'üß†',
            'wifi': 'üì∂', 'cloud': '‚òÅÔ∏è', 'eye': 'üëÅÔ∏è', 'camera': 'üì∑',
            'microphone': 'üé§', 'speaker': 'üîä', 'display': 'üñ•Ô∏è', 'touch': 'üëÜ',
            'gesture': 'üëã', 'voice': 'üó£Ô∏è', 'ai': 'ü§ñ', 'chip': 'üîß',
            'battery': 'üîã', 'power': '‚ö°', 'security': 'üîí', 'network': 'üåê',
            'data': 'üíæ', 'processor': '‚öôÔ∏è', 'memory': 'üß©', 'sensor': 'üìä',
            'screen': 'üì±', 'keyboard': '‚å®Ô∏è', 'mouse': 'üñ±Ô∏è', 'vr': 'ü•Ω',
            'ar': 'üëì', 'game': 'üéÆ', 'video': 'üìπ', 'audio': 'üéß',
            'usb': 'üîå', 'wireless': 'üì°', 'laser': 'üî¶', 'scanner': 'üìÑ',
            'printer': 'üñ®Ô∏è', '3d': 'üìê', 'projection': 'üìΩÔ∏è', 'light': 'üí°',
            'sound': 'üîà', 'signal': 'üì°', 'satellite': 'üõ∞Ô∏è', 'robot': 'ü§ñ',
            'drone': 'üöÅ', 'rocket': 'üöÄ', 'globe': 'üåç', 'chart': 'üìà',
            'document': 'üìã', 'folder': 'üìÅ', 'image': 'üñºÔ∏è', 'code': 'üíª',
            'database': 'üóÑÔ∏è', 'server': 'üñ•Ô∏è', 'mobile': 'üì±', 'tablet': 'üì≤',
            'laptop': 'üíª', 'desktop': 'üñ•Ô∏è', 'watch': '‚åö', 'headphone': 'üéß',
            'earphone': 'üéß', 'controller': 'üéÆ', 'gamepad': 'üéÆ',
            'joystick': 'üïπÔ∏è', 'remote': 'üì±', 'dollar': 'üí≤', 'money': 'üí∞',
            'trophy': 'üèÜ', 'medal': 'ü•á', 'award': 'üèÖ', 'shield': 'üõ°Ô∏è',
            // TECH EXTRA
            'cpu': 'üñ•Ô∏è', 'cube': 'üé≤', 'droplet': 'üíß', 'file': 'üìÑ',
            'heartbeat': 'üíì', 'home': 'üè†', 'leaf': 'üçÉ', 'monitor': 'üñ•Ô∏è',
            'refresh': 'üîÑ', 'sound-wave': 'üì¢', 'tv': 'üì∫', 'zap': '‚ö°',
            // MARCHE
            'android': 'ü§ñ', 'apple': 'üçé', 'building': 'üè¢', 'creality': 'üñ®Ô∏è',
            'euro': 'üí∂', 'fold': 'üì±', 'france': 'üá´üá∑', 'lg': 'üì∫',
            'link': 'üîó', 'list': 'üìã', 'meta': 'üëÅÔ∏è', 'package': 'üì¶',
            'phone': 'üì±', 'school': 'üè´', 'vr-headset': 'ü•Ω', 'headphones': 'üéß',
            // PREDICTIONS
            '8k': 'üì∫', 'box': 'üì¶', 'fingerprint': 'üëÜ', 'hologram': '‚ú®',
            'metal': '‚öôÔ∏è', 'mic': 'üé§', 'quantum': '‚öõÔ∏è', 'recycle': '‚ôªÔ∏è',
            'sparkle': '‚ú®', 'translate': 'üåê', 'zoom': 'üîç',
        };
        if (!iconText) return 'üîß';
        const normalized = iconText.toLowerCase().trim();
        return iconMap[normalized] || iconText;
    }

    // Logos consoles officiels
    function getConsoleLogo(iconText) {
        if (!iconText) return null;
        const normalized = iconText.toLowerCase().trim();
        if (normalized === 'xbox') {
            return '<span class="console-logo" style="color:#107C10;">X</span>';
        }
        if (normalized === 'playstation' || normalized === 'ps5') {
            return '<span class="console-logo" style="color:#003791;">P</span>';
        }
        if (normalized === 'nintendo' || normalized === 'switch') {
            return '<span class="console-logo" style="color:#E60012;">N</span>';
        }
        return null;
    }

    async function loadDashboardStats() {
        try {
            // Charger les stats
            const [produitsRes, articlesRes, categoriesRes, statsRes] = await Promise.all([
                fetch('/api/produits'),
                fetch('/api/actualites'),
                fetch('/api/categories'),
                fetch('/api/stats/homepage').catch(() => ({ ok: false }))
            ]);

            const produitsData = await produitsRes.json();
            const articlesData = await articlesRes.json();
            const categoriesData = await categoriesRes.json();

            const produits = extractData(produitsData);
            const articles = extractData(articlesData);
            const categories = extractData(categoriesData);

            document.getElementById('stat-produits').textContent = produits.length || 0;
            document.getElementById('stat-articles').textContent = articles.length || 0;
            document.getElementById('stat-categories').textContent = categories.length || 0;

            document.getElementById('count-produits').textContent = produits.length || 0;
            document.getElementById('count-articles').textContent = articles.length || 0;

            if (statsRes.ok) {
                const statsData = await statsRes.json();
                const visites = statsData.stats?.visites || 0;
                document.getElementById('stat-visites').textContent = visites;
            } else {
                document.getElementById('stat-visites').textContent = '0';
            }

            // Annonces count
            const annoncesRes = await fetch('/api/announcements');
            const annoncesData = await annoncesRes.json();
            const annoncesCount = annoncesData.announcements?.length || 0;
            document.getElementById('count-annonces').textContent = annoncesCount;

            // Recent activity
            document.getElementById('recent-activity').innerHTML = `
                <p style="color: var(--text-secondary);">
                    üì¶ ${produits.length} produits en base<br>
                    üì∞ ${articles.length} articles publi√©s<br>
                    üì¢ ${annoncesCount} annonces actives<br>
                    üè∑Ô∏è ${categories.length} cat√©gories
                </p>
            `;
        } catch (error) {
            console.error('Erreur chargement stats:', error);
        }
    }

    // Statistiques compl√®tes pour la section Stats
    async function loadFullStats() {
        try {
            const response = await fetch('/api/stats/admin');
            const result = await response.json();

            if (!result.success || !result.stats) {
                throw new Error('Donn√©es invalides');
            }

            const { produits, tendances, visites, prix } = result.stats;

            // Update cards
            document.getElementById('fs-produits').textContent = produits.total;
            document.getElementById('fs-top-mois').textContent = `${produits.topDuMois} en vedette`;
            document.getElementById('fs-tendances').textContent = tendances.total;
            document.getElementById('fs-tendances-detail').textContent =
                `${tendances.actualites} actus ¬∑ ${tendances.technologies} tech`;
            document.getElementById('fs-visites').textContent = visites.total.toLocaleString('fr-FR');

            if (visites.derniereVisite) {
                const date = new Date(parseInt(visites.derniereVisite));
                document.getElementById('fs-derniere-visite').textContent =
                    `Derni√®re: ${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
            }

            document.getElementById('fs-prix-moyen').textContent = `${prix.avg_prix || 0}‚Ç¨`;
            document.getElementById('fs-prix-range').textContent =
                `${prix.min_prix || 0}‚Ç¨ - ${prix.max_prix || 0}‚Ç¨`;

            // Category chart
            const maxCount = Math.max(...produits.parCategorie.map(c => parseInt(c.count)));
            const catChartHtml = produits.parCategorie.map(cat => {
                const pct = Math.round((parseInt(cat.count) / maxCount) * 100);
                const colors = ['#00d4ff', '#d4ff00', '#bf7fff', '#ff9500', '#ff6b9d', '#00e5a0', '#ffcc00', '#ff5757', '#7c4dff', '#00bcd4'];
                const color = colors[produits.parCategorie.indexOf(cat) % colors.length];
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">${cat.categorie}</span>
                            <span style="color: var(--text-muted); font-size: 0.85rem;">${cat.count} produits</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${pct}%; background: ${color}; border-radius: 4px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('fs-categories-chart').innerHTML = catChartHtml || '<p class="empty-state">Aucune donn√©e</p>';

            // Tendances chart
            const tendanceItems = [
                { label: 'Actualit√©s', count: tendances.actualites, color: '#00d4ff', icon: 'üì∞' },
                { label: 'Technologies', count: tendances.technologies, color: '#d4ff00', icon: 'üíª' },
                { label: 'March√©', count: tendances.marche, color: '#bf7fff', icon: 'üìà' },
                { label: 'Pr√©dictions', count: tendances.predictions, color: '#ff9500', icon: 'üîÆ' }
            ];
            const maxTendance = Math.max(...tendanceItems.map(t => t.count));

            const tendChartHtml = tendanceItems.map(t => {
                const pct = maxTendance > 0 ? Math.round((t.count / maxTendance) * 100) : 0;
                return `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">${t.icon}</span>
                            <span style="color: var(--text-primary); font-weight: 500;">${t.label}</span>
                            <span style="margin-left: auto; color: ${t.color}; font-weight: 700; font-size: 1.1rem;">${t.count}</span>
                        </div>
                        <div style="height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden;">
                            <div style="height: 100%; width: ${pct}%; background: ${t.color}; border-radius: 6px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('fs-tendances-chart').innerHTML = tendChartHtml;

        } catch (error) {
            console.error('Erreur chargement stats compl√®tes:', error);
            document.getElementById('fs-categories-chart').innerHTML =
                '<p class="empty-state">Erreur de chargement</p>';
            document.getElementById('fs-tendances-chart').innerHTML =
                '<p class="empty-state">Erreur de chargement</p>';
        }
    }

    // Donn√©es globales pour recherche/filtre
    let allProduits = [];
    let allArticles = [];
    let allCategories = [];

    async function loadProduits() {
        try {
            const response = await fetch('/api/produits');
            const data = await response.json();
            allProduits = extractData(data);
            renderProduits(allProduits);
            populateFilters();
            updateHomepageCounter();
        } catch (error) {
            console.error('Erreur chargement produits:', error);
        }
    }

    function renderProduits(produits) {
        const tbody = document.getElementById('table-produits');
        if (produits.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Aucun produit trouv√©</td></tr>';
            return;
        }

        const homepageCount = countHomepageProducts();
        const maxHomepageReached = homepageCount >= MAX_HOMEPAGE_PRODUCTS;

        tbody.innerHTML = produits.slice(0, 100).map(p => {
            const imgSrc = p.image ? `/assets/images/${p.image}` : '';
            const imgHtml = imgSrc
                ? `<img src="${imgSrc}" class="data-table-img" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="data-table-img" style="display:none;background:var(--bg-elevated);align-items:center;justify-content:center;">üì¶</div>`
                : `<div class="data-table-img" style="background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;">üì¶</div>`;

            // Vedette (badge) - illimit√©
            const isFeatured = p.top_du_mois === true;
            const starIcon = isFeatured ? '‚≠ê' : '‚òÜ';
            const starTitle = isFeatured ? 'Retirer le badge vedette' : 'Ajouter le badge vedette';
            const starStyle = isFeatured ? 'color: #ffcc00;' : '';

            // Accueil (affichage homepage) - max 4
            const isOnHomepage = p.affiche_accueil === true;
            const cannotAddHomepage = !isOnHomepage && maxHomepageReached;
            const homeIcon = isOnHomepage ? 'üè†' : 'üèöÔ∏è';
            const homeTitle = isOnHomepage ? 'Retirer de l\'accueil' : (cannotAddHomepage ? 'Maximum 4 produits sur l\'accueil' : 'Afficher sur l\'accueil');
            const homeStyle = isOnHomepage ? 'color: #6bff6b;' : (cannotAddHomepage ? 'opacity: 0.3; cursor: not-allowed;' : '');

            return `
                <tr>
                    <td>${imgHtml}</td>
                    <td><strong>${p.nom || p.name || 'Sans nom'}</strong></td>
                    <td><span class="data-table-badge badge-info">${p.categorie || p.category || '-'}</span></td>
                    <td>${p.prix || '-'}</td>
                    <td>
                        <button class="action-btn" title="${starTitle}" onclick="toggleFeatured('${p.id}', ${!isFeatured})" style="${starStyle}">${starIcon}</button>
                    </td>
                    <td>
                        <button class="action-btn" title="${homeTitle}" onclick="toggleHomepage('${p.id}', ${!isOnHomepage})" style="${homeStyle}">${homeIcon}</button>
                    </td>
                    <td>
                        <button class="action-btn edit" title="Modifier" onclick="editProduit('${p.id}')">‚úèÔ∏è</button>
                        <button class="action-btn" title="Voir la fiche" onclick="window.open('/2026/fiche.html?produit=${encodeURIComponent(p.nom || '')}', '_blank')">üëÅÔ∏è</button>
                        <button class="action-btn delete" title="Supprimer" onclick="deleteProduit('${p.id}', '${(p.nom || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    const MAX_HOMEPAGE_PRODUCTS = 4;

    function countHomepageProducts() {
        return allProduits.filter(p => p.affiche_accueil === true).length;
    }

    // Toggle badge vedette (illimit√©)
    async function toggleFeatured(id, featured) {
        try {
            const response = await fetch(`/api/produits/${id}/featured`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ featured })
            });
            const data = await response.json();
            if (data.success) {
                // Mettre √† jour localement
                const product = allProduits.find(p => p.id == id);
                if (product) product.top_du_mois = featured;
                renderProduits(allProduits);
                showNotification(data.message, 'success');
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Erreur toggle featured:', error);
            showNotification('Erreur de connexion', 'error');
        }
    }

    // Toggle affichage sur l'accueil (max 4)
    async function toggleHomepage(id, display) {
        // V√©rifier la limite c√¥t√© client aussi
        if (display) {
            const currentCount = countHomepageProducts();
            if (currentCount >= MAX_HOMEPAGE_PRODUCTS) {
                showNotification(`‚ö†Ô∏è Maximum ${MAX_HOMEPAGE_PRODUCTS} produits sur l'accueil ! Retirez-en un d'abord.`, 'error');
                return;
            }
        }

        try {
            const response = await fetch(`/api/produits/${id}/homepage`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ display })
            });
            const data = await response.json();
            if (data.success) {
                // Mettre √† jour localement
                const product = allProduits.find(p => p.id == id);
                if (product) product.affiche_accueil = display;
                renderProduits(allProduits);
                updateHomepageCounter();
                showNotification(data.message, 'success');
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Erreur toggle homepage:', error);
            showNotification('Erreur de connexion', 'error');
        }
    }

    function updateHomepageCounter() {
        const count = countHomepageProducts();
        const counterEl = document.getElementById('featured-counter');
        if (counterEl) {
            counterEl.innerHTML = `üè† Accueil: <strong>${count}/${MAX_HOMEPAGE_PRODUCTS}</strong>`;
            counterEl.style.color = count >= MAX_HOMEPAGE_PRODUCTS ? '#ff6b6b' : '#6bff6b';
        }
    }

    // ==================== IMPORT/EXPORT CSV ====================

    function exportCSV() {
        showNotification('T√©l√©chargement du fichier CSV...', 'info');
        // Cr√©er un lien de t√©l√©chargement direct
        const link = document.createElement('a');
        link.href = '/api/produits/export/csv';
        link.download = `produits_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => {
            showNotification('Export CSV termin√©!', 'success');
        }, 500);
    }

    async function importCSV(input) {
        const file = input.files[0];
        if (!file) return;

        // V√©rifier l'extension
        if (!file.name.endsWith('.csv')) {
            showNotification('Erreur: Seuls les fichiers CSV sont accept√©s', 'error');
            input.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        showNotification('Import en cours...', 'info');

        try {
            const response = await fetch('/api/produits/import/csv', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                let message = `Import termin√©: ${data.results.created} cr√©√©s, ${data.results.updated} mis √† jour`;
                if (data.results.errors && data.results.errors.length > 0) {
                    message += ` (${data.results.errors.length} erreurs)`;
                    console.warn('Erreurs import CSV:', data.results.errors);
                }
                showNotification(message, 'success');
                // Recharger la liste des produits
                await loadProduits();
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Erreur import CSV:', error);
            showNotification('Erreur de connexion lors de l\'import', 'error');
        }

        // Reset le champ file
        input.value = '';
    }

    async function loadArticles() {
        try {
            const response = await fetch('/api/actualites');
            const data = await response.json();
            allArticles = extractData(data);
            renderArticles(allArticles);
            populateFilters();
        } catch (error) {
            console.error('Erreur chargement articles:', error);
        }
    }

    // Formater le nom de cat√©gorie (tirets -> espaces, majuscules)
    function formatCategorie(cat) {
        if (!cat) return '-';
        return cat.replace(/-/g, ' ').toUpperCase();
    }

    function renderArticles(articles) {
        const tbody = document.getElementById('table-articles');
        const thOrdre = document.getElementById('th-ordre');

        // V√©rifier si une cat√©gorie est s√©lectionn√©e (pour activer le r√©ordonnancement)
        const categorieFilter = document.getElementById('filter-categorie-articles')?.value || '';
        const canReorder = categorieFilter !== '';

        // Afficher/masquer la colonne Ordre dans le header
        if (thOrdre) thOrdre.style.display = canReorder ? '' : 'none';

        if (articles.length === 0) {
            const colspan = canReorder ? 7 : 6;
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="empty-state">Aucun article trouv√©</td></tr>`;
            return;
        }

        // Trier par ordre puis par date
        const sorted = [...articles].sort((a, b) => (a.ordre || 999) - (b.ordre || 999));

        tbody.innerHTML = sorted.slice(0, 100).map((a, index) => {
            const imgSrc = a.image ? `/assets/images/${a.image}` : '';
            const hasVideo = a.video_url || a.video;
            const imgHtml = imgSrc
                ? `<img src="${imgSrc}" class="data-table-img" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="data-table-img" style="display:none;background:var(--bg-elevated);align-items:center;justify-content:center;">${hasVideo ? 'üé¨' : 'üì∞'}</div>`
                : `<div class="data-table-img" style="background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;">${hasVideo ? 'üé¨' : 'üì∞'}</div>`;
            const catFormatted = formatCategorie(a.categorie);
            const isFirst = index === 0;
            const isLast = index === sorted.length - 1;

            // Colonne ordre : seulement si cat√©gorie s√©lectionn√©e
            const orderCell = canReorder
                ? `<td>
                       <div style="display: flex; flex-direction: column; gap: 2px;">
                           <button class="action-btn" title="Monter" onclick="moveArticle(${a.id}, 'up')" ${isFirst ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                           <button class="action-btn" title="Descendre" onclick="moveArticle(${a.id}, 'down')" ${isLast ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
                       </div>
                   </td>`
                : '';

            return `
                <tr data-id="${a.id}">
                    ${orderCell}
                    <td>${imgHtml}</td>
                    <td><strong>${a.titre || 'Sans titre'}</strong>${a.hot ? ' <span style="color:var(--tech-red);">üî•</span>' : ''}</td>
                    <td><span class="data-table-badge badge-info">${catFormatted}</span></td>
                    <td>${a.date_publication ? new Date(a.date_publication).toLocaleDateString('fr-FR') : '-'}</td>
                    <td><span class="data-table-badge badge-success">Publi√©</span></td>
                    <td>
                        <button class="action-btn edit" title="Modifier" onclick="editArticle(${a.id})">‚úèÔ∏è</button>
                        <button class="action-btn" title="Voir" onclick="window.open('/2026/article.html?id=${a.id}', '_blank')">üëÅÔ∏è</button>
                        <button class="action-btn delete" title="Supprimer" onclick="deleteArticle(${a.id}, '${(a.titre || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function populateFilters() {
        const filterProduits = document.getElementById('filter-categorie-produits');
        const filterArticles = document.getElementById('filter-categorie-articles');

        // Extraire les cat√©gories uniques des produits
        if (filterProduits && allProduits.length > 0) {
            const categoriesProduits = [...new Set(allProduits.map(p => p.categorie || p.category).filter(Boolean))].sort();
            const optionsProduits = categoriesProduits.map(c => `<option value="${c}">${c}</option>`).join('');
            filterProduits.innerHTML = '<option value="">Toutes cat√©gories</option>' + optionsProduits;
        }

        // Extraire les cat√©gories uniques des articles (format√©es)
        if (filterArticles && allArticles.length > 0) {
            const categoriesArticles = [...new Set(allArticles.map(a => a.categorie).filter(Boolean))];
            const categoriesFormatted = [...new Set(categoriesArticles.map(c => formatCategorie(c)))].sort();
            const optionsArticles = categoriesFormatted.map(c => `<option value="${c}">${c}</option>`).join('');
            filterArticles.innerHTML = '<option value="">Toutes cat√©gories</option>' + optionsArticles;
        }
    }

    // Recherche et filtres
    function filterProduits() {
        const search = document.getElementById('search-produits')?.value.toLowerCase() || '';
        const categorie = document.getElementById('filter-categorie-produits')?.value.toLowerCase() || '';

        const filtered = allProduits.filter(p => {
            const nom = (p.nom || p.name || '').toLowerCase();
            const cat = (p.categorie || p.category || '').toLowerCase();
            const matchSearch = !search || nom.includes(search);
            const matchCat = !categorie || cat.includes(categorie);
            return matchSearch && matchCat;
        });

        renderProduits(filtered);
    }

    function filterArticles() {
        const search = document.getElementById('search-articles')?.value.toLowerCase() || '';
        const categorie = document.getElementById('filter-categorie-articles')?.value || '';

        const filtered = allArticles.filter(a => {
            const titre = (a.titre || '').toLowerCase();
            const catFormatted = formatCategorie(a.categorie);
            const matchSearch = !search || titre.includes(search);
            const matchCat = !categorie || catFormatted === categorie;
            return matchSearch && matchCat;
        });

        renderArticles(filtered);
    }

    // D√©placer un article (monter/descendre) - par cat√©gorie
    async function moveArticle(id, direction) {
        // R√©cup√©rer la cat√©gorie filtr√©e
        const categorieFilter = document.getElementById('filter-categorie-articles')?.value || '';
        if (!categorieFilter) {
            showNotification('S√©lectionnez une cat√©gorie pour r√©ordonner', 'info');
            return;
        }

        // Filtrer les articles par cat√©gorie et trier par ordre
        const filtered = allArticles.filter(a => formatCategorie(a.categorie) === categorieFilter);
        const sorted = [...filtered].sort((a, b) => (a.ordre || 999) - (b.ordre || 999));
        const index = sorted.findIndex(a => a.id === id);

        if (index === -1) return;

        let targetIndex;
        if (direction === 'up' && index > 0) {
            targetIndex = index - 1;
        } else if (direction === 'down' && index < sorted.length - 1) {
            targetIndex = index + 1;
        } else {
            return; // D√©j√† en haut ou en bas
        }

        const currentArticle = sorted[index];
        const targetArticle = sorted[targetIndex];

        try {
            const response = await fetch('/api/actualites/swap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id1: currentArticle.id, id2: targetArticle.id })
            });

            const result = await response.json();
            if (result.success) {
                // √âchanger les ordres localement dans allArticles
                const curr = allArticles.find(a => a.id === currentArticle.id);
                const targ = allArticles.find(a => a.id === targetArticle.id);
                if (curr && targ) {
                    const tempOrdre = curr.ordre;
                    curr.ordre = targ.ordre;
                    targ.ordre = tempOrdre;
                }

                filterArticles(); // Re-filtrer et afficher
                showNotification('Ordre modifi√©', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur d√©placement article:', error);
            showNotification('Erreur lors du d√©placement', 'error');
        }
    }

    // Event listeners initialis√©s dans DOMContentLoaded

    async function loadAnnonces() {
        try {
            const response = await fetch('/api/announcements');
            const data = await response.json();
            const annonces = data.announcements || [];

            const tbody = document.getElementById('table-annonces');
            if (annonces.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Aucune annonce</td></tr>';
                return;
            }

            tbody.innerHTML = annonces.map((a, index) => {
                const iconDisplay = convertIconToEmoji(a.icone) || a.icone || 'üì¢';
                return `
                <tr data-id="${a.id}" data-ordre="${a.ordre || index}" class="draggable-row" draggable="true">
                    <td><input type="checkbox" class="annonce-checkbox" data-id="${a.id}" onchange="updateBulkSelection()"></td>
                    <td><span class="drag-handle" title="Glisser pour r√©ordonner">‚†ø</span></td>
                    <td style="font-size: 1.5rem;">${iconDisplay}</td>
                    <td><strong>${a.titre}</strong><br><small style="color: var(--text-muted);">${a.description || ''}</small></td>
                    <td><span class="data-table-badge badge-${a.type === 'urgent' ? 'danger' : a.type === 'promo' ? 'warning' : 'info'}">${a.type || 'info'}</span></td>
                    <td>
                        <label class="toggle-switch" title="Activer/D√©sactiver">
                            <input type="checkbox" ${a.actif !== false ? 'checked' : ''} onchange="toggleAnnonceActive(${a.id}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>
                        <button class="action-btn edit" title="Modifier" onclick="editAnnonce(${a.id})">‚úèÔ∏è</button>
                        <button class="action-btn" title="Dupliquer" onclick="duplicateAnnonce(${a.id})">üìã</button>
                        <button class="action-btn delete" title="Supprimer" onclick="deleteAnnonce(${a.id}, '${(a.titre || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `}).join('');

            // Initialiser le drag & drop
            initAnnoncesDragDrop();

            // Reset selection
            document.getElementById('select-all-annonces').checked = false;
            updateBulkSelection();
        } catch (error) {
            console.error('Erreur chargement annonces:', error);
        }
    }

    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const data = await response.json();
            const categories = extractData(data);

            document.getElementById('content-categories').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                    ${categories.map(c => `
                        <div style="background: var(--bg-elevated); padding: 1.25rem; border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-size: 1.3rem; margin-right: 0.5rem;">${c.icone || 'üìÅ'}</span>
                                <strong style="font-size: 1.1rem;">${c.nom}</strong>
                                <br><small style="color: var(--text-muted);">slug: ${c.slug || c.nom}</small>
                            </div>
                            <div>
                                <button class="action-btn edit" title="Modifier" onclick="editCategorie(${c.id})">‚úèÔ∏è</button>
                                <button class="action-btn delete" title="Supprimer" onclick="deleteCategorie(${c.id}, '${(c.nom || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            console.error('Erreur chargement cat√©gories:', error);
        }
    }

    // ========================================
    // CATEGORIES CRUD
    // ========================================
    function getCategorieFormHtml() {
        return `
            <input type="hidden" id="form-categorie-id">
            <div class="form-group">
                <label class="form-label">Nom de la cat√©gorie *</label>
                <input type="text" class="form-input" id="form-categorie-nom" placeholder="Ex: CASQUE AUDIO" required>
            </div>
            <div class="form-group">
                <label class="form-label">Slug (identifiant)</label>
                <input type="text" class="form-input" id="form-categorie-slug" placeholder="Ex: CASQUE_AUDIO (g√©n√©r√© auto si vide)">
                <small style="color: var(--text-muted);">Laissez vide pour g√©n√©rer automatiquement</small>
            </div>
            <div class="form-group">
                <label class="form-label">Ic√¥ne (emoji)</label>
                <input type="text" class="form-input" id="form-categorie-icone" placeholder="Ex: üéß">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="form-categorie-description" placeholder="Description de la cat√©gorie..." rows="3"></textarea>
            </div>
        `;
    }

    async function saveCategorie() {
        const id = document.getElementById('form-categorie-id').value;
        const nom = document.getElementById('form-categorie-nom').value.trim();
        const slug = document.getElementById('form-categorie-slug').value.trim();
        const icone = document.getElementById('form-categorie-icone').value.trim();
        const description = document.getElementById('form-categorie-description').value.trim();

        if (!nom) {
            showToast('Le nom est requis', 'error');
            return;
        }

        try {
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/categories/${id}` : '/api/categories';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nom, slug, icone, description })
            });

            const data = await response.json();

            if (data.success) {
                showToast(id ? 'Cat√©gorie mise √† jour' : 'Cat√©gorie cr√©√©e', 'success');
                closeModal();
                loadCategories();
            } else {
                showToast(data.error || 'Erreur', 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde cat√©gorie:', error);
            showToast('Erreur de sauvegarde', 'error');
        }
    }

    async function editCategorie(id) {
        try {
            const response = await fetch(`/api/categories/${id}`);
            const data = await response.json();

            if (!data.success) {
                showToast('Cat√©gorie non trouv√©e', 'error');
                return;
            }

            const cat = data.data;

            // Ouvrir le modal
            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier la Cat√©gorie';
            body.innerHTML = getCategorieFormHtml();

            // Remplir les champs
            document.getElementById('form-categorie-id').value = cat.id;
            document.getElementById('form-categorie-nom').value = cat.nom || '';
            document.getElementById('form-categorie-slug').value = cat.slug || '';
            document.getElementById('form-categorie-icone').value = cat.icone || '';
            document.getElementById('form-categorie-description').value = cat.description || '';

            document.getElementById('modal-submit').onclick = saveCategorie;
            document.getElementById('modal-preview').style.display = 'none';

            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement cat√©gorie:', error);
            showToast('Erreur de chargement', 'error');
        }
    }

    async function deleteCategorie(id, nom) {
        // Confirmation avant suppression
        if (!confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${nom}" ?\n\nCette action est irr√©versible.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/categories/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showToast('Cat√©gorie supprim√©e', 'success');
                loadCategories();
            } else {
                showToast(data.error || 'Erreur de suppression', 'error');
            }
        } catch (error) {
            console.error('Erreur suppression cat√©gorie:', error);
            showToast('Erreur de suppression', 'error');
        }
    }

    // Donn√©es globales pour Technologies, March√©, Pr√©dictions
    let allTechnologies = [];
    let allMarche = [];
    let allPredictions = [];

    async function loadTechnologies() {
        try {
            // Charger toutes les technologies de toutes les cat√©gories
            const catRes = await fetch('/api/categories');
            const catData = await catRes.json();
            const categories = extractData(catData);

            allTechnologies = [];
            for (const cat of categories) {
                try {
                    const res = await fetch(`/api/technologies/${cat.nom || cat.slug}`);
                    const techs = await res.json();
                    if (Array.isArray(techs)) {
                        techs.forEach(t => { t.categorie = cat.nom; });
                        allTechnologies.push(...techs);
                    }
                } catch (e) {}
            }

            populateFilterTechnologies(categories);
            renderTechnologies(allTechnologies);
        } catch (error) {
            console.error('Erreur chargement technologies:', error);
        }
    }

    function renderTechnologies(technologies) {
        const tbody = document.getElementById('table-technologies');
        if (technologies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Aucune technologie trouv√©e</td></tr>';
            return;
        }

        tbody.innerHTML = technologies.slice(0, 100).map(t => {
            const iconDisplay = convertIconToEmoji(t.icone) || '‚ö°';
            const tauxDisplay = t.taux_adoption ? `${t.taux_adoption}%` : '-';
            return `
            <tr>
                <td style="font-size: 1.5rem;">${iconDisplay}</td>
                <td><strong>${t.nom || t.titre || '-'}</strong></td>
                <td><span class="data-table-badge badge-info">${t.categorie || '-'}</span></td>
                <td><span class="data-table-badge badge-success">${tauxDisplay}</span></td>
                <td>
                    <button class="action-btn edit" title="Modifier" onclick="editTechnologie(${t.id}, '${t.categorie}')">‚úèÔ∏è</button>
                    <button class="action-btn delete" title="Supprimer" onclick="deleteTechnologie(${t.id}, '${(t.nom || '').replace(/'/g, "\\'")}', '${t.categorie}')">üóëÔ∏è</button>
                </td>
            </tr>
        `}).join('');
    }

    function populateFilterTechnologies(categories) {
        const filter = document.getElementById('filter-categorie-technologies');
        if (filter) {
            filter.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                categories.map(c => `<option value="${c.nom}">${c.nom}</option>`).join('');
        }
    }

    async function loadMarche() {
        try {
            const catRes = await fetch('/api/categories');
            const catData = await catRes.json();
            const categories = extractData(catData);

            allMarche = [];
            for (const cat of categories) {
                try {
                    const res = await fetch(`/api/marche/${cat.nom || cat.slug}`);
                    const items = await res.json();
                    if (Array.isArray(items)) {
                        items.forEach(m => { m.categorie = cat.nom; });
                        allMarche.push(...items);
                    }
                } catch (e) {}
            }

            populateFilterMarche(categories);
            renderMarche(allMarche);
        } catch (error) {
            console.error('Erreur chargement march√©:', error);
        }
    }

    function renderMarche(marche) {
        const tbody = document.getElementById('table-marche');
        if (marche.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucune donn√©e march√© trouv√©e</td></tr>';
            return;
        }

        tbody.innerHTML = marche.slice(0, 100).map(m => {
            const tendanceClass = m.tendance === 'up' ? 'badge-success' : m.tendance === 'down' ? 'badge-danger' : 'badge-warning';
            const tendanceIcon = m.tendance === 'up' ? '‚Üë' : m.tendance === 'down' ? '‚Üì' : '‚Üí';
            const consoleLogo = getConsoleLogo(m.icone);
            const iconDisplay = consoleLogo || convertIconToEmoji(m.icone) || 'üìà';
            return `
                <tr>
                    <td style="font-size: 1.5rem;">${iconDisplay}</td>
                    <td><strong>${m.valeur || '-'}</strong></td>
                    <td>${m.label || '-'}</td>
                    <td><span class="data-table-badge badge-info">${m.categorie || '-'}</span></td>
                    <td><span class="data-table-badge ${tendanceClass}">${tendanceIcon} ${m.tendance || '-'}</span></td>
                    <td>
                        <button class="action-btn edit" title="Modifier" onclick="editMarche(${m.id}, '${m.categorie}')">‚úèÔ∏è</button>
                        <button class="action-btn delete" title="Supprimer" onclick="deleteMarche(${m.id}, '${(m.label || '').replace(/'/g, "\\'")}', '${m.categorie}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function populateFilterMarche(categories) {
        const filter = document.getElementById('filter-categorie-marche');
        if (filter) {
            filter.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                categories.map(c => `<option value="${c.nom}">${c.nom}</option>`).join('');
        }
    }

    async function loadPredictions() {
        try {
            const catRes = await fetch('/api/categories');
            const catData = await catRes.json();
            const categories = extractData(catData);

            allPredictions = [];
            for (const cat of categories) {
                try {
                    const res = await fetch(`/api/predictions/${cat.nom || cat.slug}`);
                    const items = await res.json();
                    if (Array.isArray(items)) {
                        items.forEach(p => { p.categorie = cat.nom; });
                        allPredictions.push(...items);
                    }
                } catch (e) {}
            }

            populateFilterPredictions(categories);
            renderPredictions(allPredictions);
        } catch (error) {
            console.error('Erreur chargement pr√©dictions:', error);
        }
    }

    function renderPredictions(predictions) {
        const tbody = document.getElementById('table-predictions');
        if (predictions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucune pr√©diction trouv√©e</td></tr>';
            return;
        }

        tbody.innerHTML = predictions.slice(0, 100).map(p => {
            const prob = p.probabilite || 0;
            const probClass = prob >= 70 ? 'badge-success' : prob >= 40 ? 'badge-warning' : 'badge-danger';
            const consoleLogo = getConsoleLogo(p.icone);
            const iconDisplay = consoleLogo || convertIconToEmoji(p.icone) || 'üîÆ';
            return `
                <tr>
                    <td style="font-size: 1.5rem;">${iconDisplay}</td>
                    <td><strong>${p.annee || '-'}</strong></td>
                    <td>${p.titre || '-'}</td>
                    <td><span class="data-table-badge badge-info">${p.categorie || '-'}</span></td>
                    <td><span class="data-table-badge ${probClass}">${prob}%</span></td>
                    <td>
                        <button class="action-btn edit" title="Modifier" onclick="editPrediction(${p.id}, '${p.categorie}')">‚úèÔ∏è</button>
                        <button class="action-btn delete" title="Supprimer" onclick="deletePrediction(${p.id}, '${(p.titre || '').replace(/'/g, "\\'")}', '${p.categorie}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function populateFilterPredictions(categories) {
        const filter = document.getElementById('filter-categorie-predictions');
        if (filter) {
            filter.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                categories.map(c => `<option value="${c.nom}">${c.nom}</option>`).join('');
        }
    }

    // Filtres pour Technologies, March√©, Pr√©dictions
    function filterTechnologies() {
        const search = document.getElementById('search-technologies')?.value.toLowerCase() || '';
        const categorie = document.getElementById('filter-categorie-technologies')?.value.toLowerCase() || '';
        const filtered = allTechnologies.filter(t => {
            const titre = (t.titre || t.nom || '').toLowerCase();
            const cat = (t.categorie || '').toLowerCase();
            return (!search || titre.includes(search)) && (!categorie || cat.includes(categorie));
        });
        renderTechnologies(filtered);
    }

    function filterMarche() {
        const search = document.getElementById('search-marche')?.value.toLowerCase() || '';
        const categorie = document.getElementById('filter-categorie-marche')?.value.toLowerCase() || '';
        const filtered = allMarche.filter(m => {
            const label = (m.label || m.titre || m.valeur || '').toLowerCase();
            const cat = (m.categorie || '').toLowerCase();
            return (!search || label.includes(search)) && (!categorie || cat.includes(categorie));
        });
        renderMarche(filtered);
    }

    function filterPredictions() {
        const search = document.getElementById('search-predictions')?.value.toLowerCase() || '';
        const categorie = document.getElementById('filter-categorie-predictions')?.value.toLowerCase() || '';
        const filtered = allPredictions.filter(p => {
            const titre = (p.titre || '').toLowerCase();
            const cat = (p.categorie || '').toLowerCase();
            return (!search || titre.includes(search)) && (!categorie || cat.includes(categorie));
        });
        renderPredictions(filtered);
    }

    // ========================================
    // MODAL
    // ========================================
    async function openModal(type) {
        const overlay = document.getElementById('modal-overlay');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        currentEditId = null;

        switch(type) {
            case 'produit':
                title.textContent = 'Nouveau Produit';
                body.innerHTML = getProduitFormHtml();
                currentImageFile = null;
                setupImageUpload();
                document.getElementById('modal-submit').onclick = saveProduit;
                document.getElementById('modal-preview').style.display = 'inline-block';
                document.getElementById('modal-preview').dataset.type = 'produit';
                break;

            case 'article':
                title.textContent = 'Nouvel Article';
                body.innerHTML = getArticleFormHtml(true); // Afficher section container
                populateArticleCategories();
                currentArticleId = null;
                articleSections = [];
                renderSections([]);
                document.getElementById('modal-submit').onclick = saveArticle;
                document.getElementById('modal-preview').style.display = 'inline-block';
                document.getElementById('modal-preview').dataset.type = 'article';
                break;

            case 'annonce':
                title.textContent = 'Nouvelle Annonce';
                body.innerHTML = getAnnonceFormHtml();
                document.getElementById('modal-submit').onclick = saveAnnonce;
                document.getElementById('modal-preview').style.display = 'none';
                setTimeout(initAnnoncePreview, 50); // Initialiser apr√®s le rendu
                break;

            case 'technologie':
                title.textContent = 'Nouvelle Technologie';
                body.innerHTML = getTechnologieFormHtml();
                await populateFormCategories('form-tech-categorie');
                document.getElementById('modal-submit').onclick = saveTechnologie;
                document.getElementById('modal-preview').style.display = 'none';
                break;

            case 'marche':
                title.textContent = 'Nouvelle Donn√©e March√©';
                body.innerHTML = getMarcheFormHtml();
                await populateFormCategories('form-marche-categorie');
                document.getElementById('modal-submit').onclick = saveMarche;
                document.getElementById('modal-preview').style.display = 'none';
                break;

            case 'prediction':
                title.textContent = 'Nouvelle Pr√©diction';
                body.innerHTML = getPredictionFormHtml();
                await populateFormCategories('form-pred-categorie');
                document.getElementById('modal-submit').onclick = savePrediction;
                document.getElementById('modal-preview').style.display = 'none';
                break;

            case 'wiki':
                title.textContent = 'Nouvelle Page Wiki';
                body.innerHTML = getWikiFormHtml();
                document.getElementById('modal-submit').onclick = saveWiki;
                document.getElementById('modal-preview').style.display = 'none';
                break;

            case 'categorie':
                title.textContent = 'Nouvelle Cat√©gorie';
                body.innerHTML = getCategorieFormHtml();
                document.getElementById('modal-submit').onclick = saveCategorie;
                document.getElementById('modal-preview').style.display = 'none';
                break;
        }

        overlay.classList.add('active');
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.remove('active');
        currentEditId = null;
    }

    // ========================================
    // PRODUITS CRUD
    // ========================================
    let currentEditId = null;

    function getProduitFormHtml() {
        return `
            <input type="hidden" id="form-produit-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nom du produit *</label>
                    <input type="text" class="form-input" id="form-produit-nom" placeholder="Ex: iPhone 16 Pro" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <select class="form-select" id="form-produit-categorie" required onchange="updateCategoryFields()">
                        <option value="">-- Choisir --</option>
                        <option value="DRONE">DRONE</option>
                        <option value="CONSOLE">CONSOLE</option>
                        <option value="TABLETTE">TABLETTE</option>
                        <option value="SMARTPHONE">SMARTPHONE</option>
                        <option value="PC GAMING">PC GAMING</option>
                        <option value="SERVEUR">SERVEUR</option>
                        <option value="CASQUE AUDIO">CASQUE AUDIO</option>
                        <option value="MONTRE CONNECTEE">MONTRE CONNECTEE</option>
                        <option value="CASQUE VR">CASQUE VR</option>
                        <option value="IMPRIMANTE 3D">IMPRIMANTE 3D</option>
                        <option value="ECRAN TV">ECRAN TV</option>
                        <option value="CAMERA">CAMERA</option>
                        <option value="PERIPHERIQUES">PERIPHERIQUES</option>
                        <option value="VIDEO PROJECTEUR">VIDEO PROJECTEUR</option>
                        <option value="BOX INTERNET">BOX INTERNET</option>
                        <option value="TABLEAU INTERACTIF">TABLEAU INTERACTIF</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Prix</label>
                    <input type="text" class="form-input" id="form-produit-prix" placeholder="Ex: 1299‚Ç¨">
                </div>
                <div class="form-group">
                    <label class="form-label">Top du mois</label>
                    <select class="form-select" id="form-produit-top">
                        <option value="false">Non</option>
                        <option value="true">Oui ‚≠ê</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Description courte</label>
                <textarea class="form-textarea" id="form-produit-description" placeholder="Description du produit..." rows="3"></textarea>
            </div>

            <!-- Image avec Drag & Drop -->
            <div class="form-group">
                <label class="form-label">Image du produit</label>
                <div id="form-produit-image-preview" style="display: none;"></div>
                <div class="upload-zone" id="form-produit-upload-zone">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Glissez votre image ici</div>
                    <div class="upload-hint">ou cliquez pour parcourir (JPG, PNG, WebP - Max 5MB)</div>
                    <input type="file" id="form-produit-file" accept="image/*" style="display: none;">
                </div>
                <input type="hidden" id="form-produit-image">
            </div>

            <div class="form-group">
                <label class="form-label">Fiche produit</label>
                <button type="button" class="btn btn-secondary" onclick="previewFiche()" id="btn-preview-fiche">
                    üëÅÔ∏è Voir la fiche produit
                </button>
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Ouvre la fiche dynamique dans un nouvel onglet</small>
            </div>

            <div class="form-group">
                <label class="form-label">Fonctionnalit√©s avanc√©es</label>
                <textarea class="form-textarea" id="form-produit-fonctionnalites" placeholder="Une fonctionnalit√© par ligne..." rows="4"></textarea>
                <small style="color: var(--text-muted);">Entrez une fonctionnalit√© par ligne</small>
            </div>

            <div class="form-group">
                <label class="form-label">Titre affich√© (optionnel)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="form-input" id="form-produit-titre-affiche" placeholder="Ex: Asus ROG Strix G18" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="autoTitreAffiche()">üîÑ Auto</button>
                </div>
            </div>

            <!-- Champs sp√©cifiques par cat√©gorie -->
            <div id="form-produit-category-fields"></div>
        `;
    }

    function autoTitreAffiche() {
        const nom = document.getElementById('form-produit-nom').value;
        if (nom) {
            const keepUppercase = ['EOS', 'RAM', 'SSD', 'HDD', 'CPU', 'GPU', 'LED', 'LCD', 'HDR', 'USB', 'HD', 'UHD', 'FHD', '4K', '8K', 'PS5', 'PS4'];
            const titre = nom.replace(/-/g, ' ').trim().split(' ').map(word => {
                if (keepUppercase.includes(word.toUpperCase())) return word.toUpperCase();
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
            document.getElementById('form-produit-titre-affiche').value = titre;
        }
    }

    // ========================================
    // DRAG & DROP IMAGE
    // ========================================
    let currentImageFile = null;

    function setupImageUpload() {
        const uploadZone = document.getElementById('form-produit-upload-zone');
        const fileInput = document.getElementById('form-produit-file');
        if (!uploadZone || !fileInput) return;

        uploadZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            if (e.target.files[0]) handleImageFile(e.target.files[0]);
        };

        uploadZone.ondragover = (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        };

        uploadZone.ondragleave = (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        };

        uploadZone.ondrop = (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleImageFile(e.dataTransfer.files[0]);
        };
    }

    function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
            showNotification('Ce fichier n\'est pas une image', 'error');
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            showNotification('L\'image d√©passe 5MB', 'error');
            return;
        }

        currentImageFile = file;
        document.getElementById('form-produit-image').value = file.name;

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('form-produit-image-preview');
            const uploadZone = document.getElementById('form-produit-upload-zone');

            preview.innerHTML = `
                <div class="image-preview-card">
                    <img src="${e.target.result}" alt="Aper√ßu">
                    <div class="image-info">
                        <div class="image-name">‚úÖ ${file.name}</div>
                        <div class="image-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeImagePreview()">üóëÔ∏è</button>
                </div>
            `;
            preview.style.display = 'block';
            uploadZone.style.display = 'none';
        };
        reader.readAsDataURL(file);
        showNotification('Image s√©lectionn√©e: ' + file.name, 'success');
    }

    function removeImagePreview() {
        currentImageFile = null;
        document.getElementById('form-produit-image').value = '';
        document.getElementById('form-produit-image-preview').style.display = 'none';
        document.getElementById('form-produit-upload-zone').style.display = 'block';
        document.getElementById('form-produit-file').value = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function displayExistingImage(imageName) {
        if (!imageName) return;
        const preview = document.getElementById('form-produit-image-preview');
        const uploadZone = document.getElementById('form-produit-upload-zone');

        preview.innerHTML = `
            <div class="image-preview-card">
                <img src="/assets/images/${imageName}" alt="Image actuelle" onerror="this.src='/assets/images/placeholder.png'">
                <div class="image-info">
                    <div class="image-name">üì∑ ${imageName}</div>
                    <div class="image-size">Image existante</div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeImagePreview()">üóëÔ∏è</button>
            </div>
        `;
        preview.style.display = 'block';
        uploadZone.style.display = 'none';
    }

    // ========================================
    // CHAMPS SPECIFIQUES PAR CATEGORIE
    // ========================================
    function getCategorySpecificFields(category) {
        const baseFields = [
            { emoji: "üìù", label: "Description d√©taill√©e", placeholder: "Description compl√®te du produit" },
            { emoji: "üí∞", label: "Prix", placeholder: "Ex: 1299‚Ç¨ - Prix comp√©titif" },
            { emoji: "üß©", label: "Sp√©cifications mat√©rielles", placeholder: "Processeur, RAM, stockage..." }
        ];

        const categorySpecific = {
            'DRONE': [
                { emoji: "üé•", label: "Fonctions vid√©o et photo", placeholder: "R√©solution, stabilisation, modes photo..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Wi-Fi, Bluetooth, radio..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Pilotage, application mobile..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Accessoires inclus", placeholder: "Batteries, h√©lices, sacoche..." }
            ],
            'CONSOLE': [
                { emoji: "üñ•Ô∏è", label: "√âcran et affichage", placeholder: "R√©solution, taux de rafra√Æchissement..." },
                { emoji: "üïπÔ∏è", label: "Contr√¥leurs et interaction", placeholder: "Manettes, accessoires..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Wi-Fi, Ethernet, Bluetooth..." },
                { emoji: "üéÆ", label: "Exp√©rience de jeu", placeholder: "Interface, exclusivit√©s..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Contenu de la bo√Æte", placeholder: "Manettes, c√¢bles..." }
            ],
            'TABLETTE': [
                { emoji: "üñ•Ô∏è", label: "√âcran et affichage", placeholder: "Taille, r√©solution, technologie..." },
                { emoji: "üñäÔ∏è", label: "Accessoires et interaction", placeholder: "Stylet, clavier..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Wi-Fi, 4G/5G, Bluetooth..." },
                { emoji: "üéÆ", label: "Applications et usages", placeholder: "Productivit√©, jeux..." },
                { emoji: "üîã", label: "Autonomie", placeholder: "Batterie, recharge..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Contenu de la bo√Æte", placeholder: "Tablette, c√¢ble, chargeur..." }
            ],
            'SMARTPHONE': [
                { emoji: "üì∏", label: "Appareil photo", placeholder: "Nombre de capteurs, r√©solution..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "5G, Wi-Fi, Bluetooth..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Interface, OS..." },
                { emoji: "üîã", label: "Autonomie", placeholder: "Batterie, recharge..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Contenu de la bo√Æte", placeholder: "Chargeur, c√¢ble..." }
            ],
            'PC GAMING': [
                { emoji: "üéÆ", label: "Performances gaming", placeholder: "GPU, CPU, FPS..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Wi-Fi, Ethernet, Bluetooth..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Refroidissement, bruit..." },
                { emoji: "üîã", label: "Gestion thermique", placeholder: "Ventilation, watercooling..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Accessoires inclus", placeholder: "Souris, clavier..." }
            ],
            'SERVEUR': [
                { emoji: "üñ•Ô∏è", label: "Performances et virtualisation", placeholder: "CPU, RAM, hyperviseur..." },
                { emoji: "üåê", label: "Connectivit√© r√©seau", placeholder: "Ethernet, fibre..." },
                { emoji: "üéÆ", label: "Gestion et monitoring", placeholder: "Logiciels, alertes..." },
                { emoji: "üîí", label: "S√©curit√© et redondance", placeholder: "RAID, alimentation..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'CASQUE AUDIO': [
                { emoji: "üéß", label: "Fonctions audio", placeholder: "ANC, spatialisation..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Bluetooth, filaire..." },
                { emoji: "üéÆ", label: "Confort et utilisation", placeholder: "Poids, coussinets..." },
                { emoji: "üîã", label: "Autonomie", placeholder: "Batterie, recharge..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Contenu de la bo√Æte", placeholder: "Casque, c√¢bles, √©tui..." }
            ],
            'MONTRE CONNECTEE': [
                { emoji: "‚åö", label: "Fonctions sport et sant√©", placeholder: "Cardio, GPS, sommeil..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Bluetooth, Wi-Fi..." },
                { emoji: "üéÆ", label: "Applications et autonomie", placeholder: "App store, batterie..." },
                { emoji: "üîã", label: "Autonomie", placeholder: "Batterie, recharge..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'CAMERA': [
                { emoji: "üé•", label: "Fonctions vid√©o et photo", placeholder: "R√©solution, formats, modes..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Wi-Fi, Bluetooth..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Interface, ergonomie..." },
                { emoji: "üîã", label: "Autonomie", placeholder: "Batterie, recharge..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Accessoires inclus", placeholder: "Objectifs, c√¢bles..." }
            ],
            'PERIPHERIQUES': [
                { emoji: "üéõÔ∏è", label: "Fonctions avanc√©es", placeholder: "Macros, RGB, capteurs..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "USB, Bluetooth, sans fil..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Ergonomie, confort..." },
                { emoji: "üîã", label: "Autonomie", placeholder: "Batterie, recharge..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Contenu de la bo√Æte", placeholder: "Accessoires inclus..." }
            ],
            'CASQUE VR': [
                { emoji: "üïπÔ∏è", label: "Contr√¥leurs et interaction", placeholder: "Manettes, capteurs..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "USB, Bluetooth, Wi-Fi..." },
                { emoji: "üéÆ", label: "Exp√©rience immersive", placeholder: "Champ de vision, confort..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'IMPRIMANTE 3D': [
                { emoji: "üñ®Ô∏è", label: "Fonctions d'impression", placeholder: "Technologie, mat√©riaux..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "USB, Wi-Fi..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Logiciel, calibration..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'ECRAN TV': [
                { emoji: "üñ•Ô∏è", label: "√âcran et affichage", placeholder: "Taille, r√©solution, HDR..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "HDMI, Wi-Fi..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Interface, t√©l√©commande..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'VIDEO PROJECTEUR': [
                { emoji: "üé•", label: "Fonctions vid√©o", placeholder: "R√©solution, luminosit√©..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "HDMI, Wi-Fi..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Installation, r√©glages..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'BOX INTERNET': [
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Ethernet, Wi-Fi..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Interface, installation..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." }
            ],
            'TABLEAU INTERACTIF': [
                { emoji: "üñ•Ô∏è", label: "√âcran et affichage", placeholder: "Taille, r√©solution, tactile..." },
                { emoji: "üñäÔ∏è", label: "Accessoires et interaction", placeholder: "Stylet, support mural, cam√©ra..." },
                { emoji: "üåê", label: "Connectivit√©", placeholder: "Wi-Fi, HDMI, USB-C..." },
                { emoji: "üéÆ", label: "Exp√©rience utilisateur", placeholder: "Logiciel, collaboration..." },
                { emoji: "üîã", label: "Autonomie et consommation", placeholder: "Alimentation, consommation..." },
                { emoji: "üõ°Ô∏è", label: "Garantie et support", placeholder: "Dur√©e, SAV..." },
                { emoji: "üì¶", label: "Contenu de la bo√Æte", placeholder: "Stylets, c√¢bles, support..." }
            ]
        };

        return [...baseFields, ...(categorySpecific[category] || [])];
    }

    function updateCategoryFields(existingData = null) {
        const category = document.getElementById('form-produit-categorie')?.value;
        const container = document.getElementById('form-produit-category-fields');
        if (!container) return;

        if (!category) {
            container.innerHTML = '';
            return;
        }

        const fields = getCategorySpecificFields(category);

        container.innerHTML = `
            <div class="category-fields-section">
                <div class="category-fields-title">üìã Donn√©es fiche pour ${category}</div>
                ${fields.map((field, index) => {
                    let value = '';
                    if (existingData && existingData[index]) {
                        const contenu = existingData[index];
                        if (contenu.includes('\n') && /^[^\w\s]/.test(contenu)) {
                            value = contenu.split('\n').slice(1).join('\n');
                        } else {
                            value = contenu;
                        }
                    }
                    return `
                        <div class="form-group">
                            <label class="form-label">${field.emoji} ${field.label}</label>
                            <textarea class="form-textarea" id="form-produit-fiche-${index}" rows="2" placeholder="${field.placeholder}">${value}</textarea>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    function collectCategoryData() {
        const category = document.getElementById('form-produit-categorie')?.value;
        if (!category) return [];

        const fields = getCategorySpecificFields(category);
        const data = [];

        for (let i = 0; i < fields.length; i++) {
            const field = document.getElementById(`form-produit-fiche-${i}`);
            if (field) {
                data.push(`${fields[i].emoji} ${fields[i].label}\n${field.value.trim()}`);
            }
        }
        return data;
    }

    // Aper√ßu de la fiche produit dynamique
    function previewFiche() {
        const nom = document.getElementById('form-produit-nom')?.value;
        if (!nom) {
            showNotification('Entrez d\'abord le nom du produit', 'info');
            return;
        }
        const url = `/2026/fiche.html?produit=${encodeURIComponent(nom)}`;
        window.open(url, '_blank');
    }

    // ========================================
    async function populateProduitCategories() {
        // Charger les cat√©gories si pas encore fait
        if (allCategories.length === 0) {
            try {
                const catRes = await fetch('/api/categories');
                const catData = await catRes.json();
                allCategories = extractData(catData);
            } catch (e) {
                console.error('Erreur chargement cat√©gories:', e);
            }
        }
        const select = document.getElementById('form-produit-categorie');
        if (select && allCategories.length > 0) {
            select.innerHTML = '<option value="">S√©lectionner...</option>' +
                allCategories.map(c => `<option value="${c.nom}">${c.nom}</option>`).join('');
        }
    }

    async function editProduit(id) {
        try {
            const response = await fetch(`/api/produits/${id}`);
            const result = await response.json();
            const produit = result.data || result;

            currentEditId = id;
            currentImageFile = null;

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier le Produit';
            body.innerHTML = getProduitFormHtml();

            // Pr√©-remplir le formulaire
            document.getElementById('form-produit-id').value = id;
            document.getElementById('form-produit-nom').value = produit.nom || '';
            document.getElementById('form-produit-categorie').value = produit.categorie || '';
            document.getElementById('form-produit-prix').value = produit.prix || '';
            document.getElementById('form-produit-image').value = produit.image || '';
            document.getElementById('form-produit-description').value = produit.description || '';
            document.getElementById('form-produit-top').value = produit.top_du_mois ? 'true' : 'false';
            document.getElementById('form-produit-titre-affiche').value = produit.titre_affiche || '';

            // Fonctionnalit√©s avanc√©es (array -> texte)
            const fonctionnalites = produit.fonctionnalites_avancees || [];
            document.getElementById('form-produit-fonctionnalites').value = Array.isArray(fonctionnalites) ? fonctionnalites.join('\n') : '';

            // Setup drag & drop
            setupImageUpload();

            // Afficher l'image existante
            if (produit.image) {
                displayExistingImage(produit.image);
            }

            // Charger les champs cat√©gorie avec donn√©es existantes
            updateCategoryFields(produit.donnees_fiche);

            document.getElementById('modal-submit').onclick = saveProduit;
            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement produit:', error);
            showNotification('Erreur lors du chargement du produit', 'error');
        }
    }

    async function saveProduit() {
        const id = document.getElementById('form-produit-id')?.value;

        // Convertir les fonctionnalit√©s texte en array
        const fonctionnalitesText = document.getElementById('form-produit-fonctionnalites').value;
        const fonctionnalites = fonctionnalitesText
            .split('\n')
            .map(f => f.trim())
            .filter(f => f.length > 0);

        // Auto-g√©n√©rer titre affich√© si vide
        let titreAffiche = document.getElementById('form-produit-titre-affiche').value;
        if (!titreAffiche) {
            autoTitreAffiche();
            titreAffiche = document.getElementById('form-produit-titre-affiche').value;
        }

        const data = {
            nom: document.getElementById('form-produit-nom').value,
            categorie: document.getElementById('form-produit-categorie').value,
            prix: document.getElementById('form-produit-prix').value,
            image: document.getElementById('form-produit-image').value,
            description: document.getElementById('form-produit-description').value,
            top_du_mois: document.getElementById('form-produit-top').value === 'true',
            titre_affiche: titreAffiche,
            fonctionnalites_avancees: fonctionnalites,
            donnees_fiche: collectCategoryData()
        };

        if (!data.nom) {
            showNotification('Le nom du produit est obligatoire', 'error');
            return;
        }

        if (!data.categorie) {
            showNotification('La cat√©gorie est obligatoire', 'error');
            return;
        }

        try {
            const url = id ? `/api/produits/${id}` : '/api/produits';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                loadProduits();
                loadDashboardStats();
                showNotification(id ? 'Produit modifi√©!' : 'Produit cr√©√©!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    // ========================================
    // ARTICLES - FORMULAIRE ET CRUD
    // ========================================
    let currentArticleId = null;

    function getArticleFormHtml(isEdit = false) {
        const today = new Date().toISOString().split('T')[0];
        return `
            <input type="hidden" id="form-article-id">
            <div class="form-group">
                <label class="form-label">Titre *</label>
                <input type="text" class="form-input" id="form-article-titre" placeholder="Titre de l'article" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <select class="form-select" id="form-article-categorie" required>
                        <option value="">-- Choisir --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date de publication</label>
                    <input type="date" class="form-input" id="form-article-date" value="${today}">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Description courte *</label>
                <textarea class="form-textarea" id="form-article-description" placeholder="R√©sum√© de l'article (affich√© sur la card)..." rows="3" required></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Image</label>
                    <input type="text" class="form-input" id="form-article-image" placeholder="nom-image.jpg">
                    <small style="color: var(--text-muted);">Nom du fichier dans /assets/images/</small>
                </div>
                <div class="form-group">
                    <label class="form-label">URL Vid√©o (optionnel)</label>
                    <input type="text" class="form-input" id="form-article-video" placeholder="https://youtube.com/...">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-input" id="form-article-tags" placeholder="tag1, tag2, tag3">
                    <small style="color: var(--text-muted);">S√©par√©s par des virgules</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Article Hot üî•</label>
                    <select class="form-select" id="form-article-hot">
                        <option value="false">Non</option>
                        <option value="true">Oui üî•</option>
                    </select>
                </div>
            </div>

            <!-- Sections de l'article -->
            <div class="form-group" id="sections-container" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <label class="form-label" style="margin: 0; color: var(--tech-yellow);">üìù Sections de l'article (contenu d√©taill√©)</label>
                    <button type="button" class="btn btn-secondary" onclick="addSection()">+ Ajouter section</button>
                </div>
                <small style="color: var(--text-muted); display: block; margin-bottom: 1rem;">
                    Les sections constituent le contenu d√©taill√© affich√© sur la page article.html (apr√®s la description courte)
                </small>
                <div id="sections-list">
                    <!-- Sections charg√©es dynamiquement -->
                </div>
            </div>
        `;
    }

    function populateArticleCategories() {
        const select = document.getElementById('form-article-categorie');
        if (!select) return;

        // Extraire les cat√©gories uniques des articles existants
        const categories = [...new Set(allArticles.map(a => a.categorie).filter(Boolean))].sort();

        if (categories.length > 0) {
            select.innerHTML = '<option value="">-- Choisir --</option>' +
                categories.map(c => `<option value="${c}">${formatCategorie(c)}</option>`).join('');
        } else {
            // Fallback sur les cat√©gories g√©n√©rales
            select.innerHTML = `
                <option value="">-- Choisir --</option>
                <option value="drone">DRONE</option>
                <option value="console">CONSOLE</option>
                <option value="tablette">TABLETTE</option>
                <option value="smartphone">SMARTPHONE</option>
                <option value="pc-gaming">PC GAMING</option>
                <option value="serveur">SERVEUR</option>
                <option value="casque-audio">CASQUE AUDIO</option>
                <option value="montre-connectee">MONTRE CONNECTEE</option>
                <option value="casque-vr">CASQUE VR</option>
                <option value="imprimante-3d">IMPRIMANTE 3D</option>
                <option value="ecran-tv">ECRAN TV</option>
                <option value="camera">CAMERA</option>
                <option value="peripheriques">PERIPHERIQUES</option>
                <option value="video-projecteur">VIDEO PROJECTEUR</option>
                <option value="box-internet">BOX INTERNET</option>
                <option value="tableau-interactif">TABLEAU INTERACTIF</option>
            `;
        }
    }

    async function saveArticle() {
        const id = document.getElementById('form-article-id')?.value;
        const titre = document.getElementById('form-article-titre').value.trim();
        const categorie = document.getElementById('form-article-categorie').value;
        const description = document.getElementById('form-article-description').value.trim();
        const image = document.getElementById('form-article-image').value.trim();
        const video_url = document.getElementById('form-article-video').value.trim();
        const date_publication = document.getElementById('form-article-date').value;
        const tagsInput = document.getElementById('form-article-tags').value.trim();
        const hot = document.getElementById('form-article-hot').value === 'true';

        // Validation
        if (!titre) {
            showNotification('Le titre est obligatoire', 'error');
            return;
        }
        if (!categorie) {
            showNotification('La cat√©gorie est obligatoire', 'error');
            return;
        }
        if (!description) {
            showNotification('La description est obligatoire', 'error');
            return;
        }

        // Convertir les tags en array
        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

        const data = {
            titre,
            categorie,
            description,
            image: image || null,
            video_url: video_url || null,
            date_publication: date_publication || new Date().toISOString().split('T')[0],
            tags,
            hot
        };

        try {
            const url = id ? `/api/actualites/${id}` : '/api/actualites';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || result.tendance) {
                // R√©cup√©rer l'ID de l'article (nouveau ou existant)
                const articleId = id || result.tendance?.id;

                // Sauvegarder les sections si on a des sections et un ID
                if (articleId && articleSections.length > 0) {
                    await saveSections(articleId);
                }

                loadArticles();
                loadDashboardStats();
                showNotification(id ? 'Article modifi√©!' : 'Article cr√©√©!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde article:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function editArticle(id) {
        try {
            // Charger l'article avec ses sections
            const response = await fetch(`/api/fiche-tendance/data/${id}`);
            const result = await response.json();

            if (!result.success || !result.data) {
                showNotification('Article non trouv√©', 'error');
                return;
            }

            const article = result.data;
            currentArticleId = id;

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier l\'Article';
            body.innerHTML = getArticleFormHtml(true); // true = mode √©dition, afficher sections
            populateArticleCategories();

            // Pr√©-remplir le formulaire
            document.getElementById('form-article-id').value = id;
            document.getElementById('form-article-titre').value = article.titre || '';
            document.getElementById('form-article-categorie').value = article.categorie || '';
            document.getElementById('form-article-description').value = article.description || '';
            document.getElementById('form-article-image').value = article.image || '';
            document.getElementById('form-article-video').value = article.video_url || '';
            document.getElementById('form-article-hot').value = article.hot ? 'true' : 'false';

            // Date
            if (article.date_publication) {
                const date = new Date(article.date_publication).toISOString().split('T')[0];
                document.getElementById('form-article-date').value = date;
            }

            // Tags
            if (article.tags) {
                const tagsArray = Array.isArray(article.tags) ? article.tags : [];
                document.getElementById('form-article-tags').value = tagsArray.join(', ');
            }

            // Charger les sections
            renderSections(article.sections || []);

            document.getElementById('modal-submit').onclick = saveArticle;
            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement article:', error);
            showNotification('Erreur lors du chargement de l\'article', 'error');
        }
    }

    async function deleteArticle(id, titre) {
        if (!confirm(`Supprimer l'article "${titre}" ?`)) return;

        try {
            const response = await fetch(`/api/actualites/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadArticles();
                loadDashboardStats();
                showNotification('Article supprim√©', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur suppression article:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // ========================================
    // SECTIONS D'ARTICLE
    // ========================================
    let articleSections = [];

    function renderSections(sections) {
        articleSections = sections;
        const container = document.getElementById('sections-list');
        if (!container) return;

        if (sections.length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Aucune section. Cliquez sur "+ Ajouter section" pour commencer.</p>';
            return;
        }

        container.innerHTML = sections.map((s, index) => `
            <div class="section-item" data-id="${s.id}" style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: var(--tech-green); font-weight: 500;">#${index + 1} - Section</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="action-btn" onclick="moveSectionUp(${index})" ${index === 0 ? 'disabled style="opacity:0.3"' : ''} title="Monter">‚¨ÜÔ∏è</button>
                        <button type="button" class="action-btn" onclick="moveSectionDown(${index})" ${index === sections.length - 1 ? 'disabled style="opacity:0.3"' : ''} title="Descendre">‚¨áÔ∏è</button>
                        <button type="button" class="action-btn delete" onclick="deleteSection('${s.id}')" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </div>
                <input type="text" class="form-input" value="${(s.titre || '').replace(/"/g, '&quot;')}"
                       onchange="updateSectionTitle('${s.id}', this.value)"
                       placeholder="Titre de la section" style="margin-bottom: 0.5rem;">
                <textarea class="form-textarea" rows="4"
                          onchange="updateSectionContent('${s.id}', this.value)"
                          placeholder="Contenu de la section...">${s.contenu || ''}</textarea>
            </div>
        `).join('');
    }

    function addSection() {
        const articleId = document.getElementById('form-article-id')?.value;

        // Cr√©er une nouvelle section locale (temporaire)
        const newSection = {
            id: 'new_' + Date.now(),
            actualite_id: articleId || null,
            titre: '',
            contenu: '',
            ordre: articleSections.length + 1,
            isNew: true
        };

        articleSections.push(newSection);
        renderSections(articleSections);
        showNotification('Section ajout√©e', 'success');
    }

    function updateSectionTitle(id, value) {
        const section = articleSections.find(s => String(s.id) === String(id));
        if (section) section.titre = value;
    }

    function updateSectionContent(id, value) {
        const section = articleSections.find(s => String(s.id) === String(id));
        if (section) section.contenu = value;
    }

    function moveSectionUp(index) {
        if (index <= 0) return;
        [articleSections[index], articleSections[index - 1]] = [articleSections[index - 1], articleSections[index]];
        // Mettre √† jour les ordres
        articleSections.forEach((s, i) => s.ordre = i + 1);
        renderSections(articleSections);
    }

    function moveSectionDown(index) {
        if (index >= articleSections.length - 1) return;
        [articleSections[index], articleSections[index + 1]] = [articleSections[index + 1], articleSections[index]];
        // Mettre √† jour les ordres
        articleSections.forEach((s, i) => s.ordre = i + 1);
        renderSections(articleSections);
    }

    async function deleteSection(id) {
        const isNew = String(id).startsWith('new_');

        if (!isNew) {
            // Supprimer en base
            try {
                const response = await fetch(`/api/fiche-tendance/sections/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (!result.success) {
                    showNotification('Erreur suppression section', 'error');
                    return;
                }
            } catch (error) {
                console.error('Erreur suppression section:', error);
                showNotification('Erreur suppression section', 'error');
                return;
            }
        }

        // Retirer de la liste locale
        articleSections = articleSections.filter(s => String(s.id) !== String(id));
        articleSections.forEach((s, i) => s.ordre = i + 1);
        renderSections(articleSections);
        showNotification('Section supprim√©e', 'success');
    }

    async function saveSections(articleId) {
        // Sauvegarder toutes les sections
        for (const section of articleSections) {
            const isNew = String(section.id).startsWith('new_');
            const data = {
                actualite_id: articleId,
                titre: section.titre || 'Section',
                contenu: section.contenu || '',
                ordre: section.ordre
            };

            try {
                if (isNew) {
                    // Cr√©er nouvelle section
                    await fetch('/api/fiche-tendance/sections', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Mettre √† jour section existante
                    await fetch(`/api/fiche-tendance/sections/${section.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
            } catch (error) {
                console.error('Erreur sauvegarde section:', error);
            }
        }
    }

    // ========================================
    // ANNONCES - FORMULAIRE ET CRUD
    // ========================================
    let currentAnnonceId = null;

    function getAnnonceFormHtml() {
        return `
            <input type="hidden" id="form-annonce-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji) *</label>
                    <input type="text" class="form-input" id="form-annonce-icone" placeholder="üöÄ" value="üöÄ" maxlength="4" style="font-size: 1.5rem; text-align: center;">
                </div>
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <select class="form-select" id="form-annonce-type">
                        <option value="info">‚ÑπÔ∏è Info</option>
                        <option value="nouveau">üÜï Nouveau</option>
                        <option value="promo">üè∑Ô∏è Promo</option>
                        <option value="urgent">üö® Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Active</label>
                    <select class="form-select" id="form-annonce-actif">
                        <option value="true">‚úÖ Oui</option>
                        <option value="false">‚ùå Non</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Titre *</label>
                <input type="text" class="form-input" id="form-annonce-titre" placeholder="Titre de l'annonce" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="form-annonce-description" placeholder="Description de l'annonce..." rows="3"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Lien</label>
                    <input type="text" class="form-input" id="form-annonce-lien" placeholder="/2026/article.html?id=...">
                </div>
                <div class="form-group">
                    <label class="form-label">Texte du bouton</label>
                    <input type="text" class="form-input" id="form-annonce-bouton" placeholder="En savoir plus ‚Üí" value="En savoir plus ‚Üí">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Date de d√©but (optionnel)</label>
                    <input type="datetime-local" class="form-input" id="form-annonce-date-debut">
                    <small style="color: var(--text-muted);">Laisser vide = imm√©diat</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Date de fin (optionnel)</label>
                    <input type="datetime-local" class="form-input" id="form-annonce-date-fin">
                    <small style="color: var(--text-muted);">Laisser vide = permanent</small>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Ordre d'affichage</label>
                <input type="number" class="form-input" id="form-annonce-ordre" placeholder="0" value="0" min="0">
                <small style="color: var(--text-muted);">Plus petit = affich√© en premier</small>
            </div>

            <!-- Pr√©visualisation live -->
            <div class="form-group" style="margin-top: 1.5rem;">
                <label class="form-label">Aper√ßu en direct</label>
                <div id="annonce-preview" class="annonce-preview">
                    <div class="preview-card type-info">
                        <div class="preview-icon">üöÄ</div>
                        <div class="preview-text">
                            <div class="preview-title">Titre de l'annonce</div>
                            <div class="preview-description">Description de l'annonce...</div>
                        </div>
                        <span class="preview-btn">En savoir plus ‚Üí</span>
                    </div>
                </div>
            </div>
        `;
    }

    // Mise √† jour de la pr√©visualisation en temps r√©el
    function initAnnoncePreview() {
        const fields = ['icone', 'titre', 'description', 'type', 'bouton'];
        fields.forEach(field => {
            const el = document.getElementById('form-annonce-' + field);
            if (el) {
                el.addEventListener('input', updateAnnoncePreview);
                el.addEventListener('change', updateAnnoncePreview);
            }
        });
        updateAnnoncePreview();
    }

    function updateAnnoncePreview() {
        const icone = document.getElementById('form-annonce-icone')?.value || 'üöÄ';
        const titre = document.getElementById('form-annonce-titre')?.value || 'Titre de l\'annonce';
        const description = document.getElementById('form-annonce-description')?.value || 'Description de l\'annonce...';
        const type = document.getElementById('form-annonce-type')?.value || 'info';
        const bouton = document.getElementById('form-annonce-bouton')?.value || 'En savoir plus ‚Üí';

        const preview = document.getElementById('annonce-preview');
        if (!preview) return;

        preview.innerHTML = `
            <div class="preview-card type-${type}">
                <div class="preview-icon">${icone}</div>
                <div class="preview-text">
                    <div class="preview-title">${titre || 'Titre de l\'annonce'}</div>
                    <div class="preview-description">${description || 'Description...'}</div>
                </div>
                <span class="preview-btn">${bouton}</span>
            </div>
        `;
    }

    // Templates pr√©d√©finis
    const annonceTemplates = {
        nouveau: {
            icone: 'üÜï',
            titre: 'Nouveau : [Nom du produit] disponible !',
            description: 'D√©couvrez notre dernier arrivage en boutique.',
            type: 'nouveau',
            bouton_texte: 'Voir le produit ‚Üí',
            lien: '/2026/fiche.html?produit='
        },
        promo: {
            icone: 'üè∑Ô∏è',
            titre: 'Promo Flash : -XX% sur [Produit] !',
            description: 'Offre limit√©e, profitez-en vite !',
            type: 'promo',
            bouton_texte: 'En profiter ‚Üí',
            lien: '/2026/produits.html'
        },
        urgent: {
            icone: 'üö®',
            titre: 'Stock limit√© : [Produit] bient√¥t √©puis√©',
            description: 'Plus que quelques unit√©s disponibles.',
            type: 'urgent',
            bouton_texte: 'Commander ‚Üí',
            lien: '/2026/fiche.html?produit='
        },
        info: {
            icone: '‚ÑπÔ∏è',
            titre: 'Information importante',
            description: 'Consultez notre derni√®re actualit√©.',
            type: 'info',
            bouton_texte: 'En savoir plus ‚Üí',
            lien: '/2026/article.html?id='
        }
    };

    function createFromTemplate(templateType) {
        const template = annonceTemplates[templateType];
        if (!template) return;

        // Ouvrir le modal
        const overlay = document.getElementById('modal-overlay');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');

        title.textContent = 'Nouvelle Annonce (Template)';
        body.innerHTML = getAnnonceFormHtml();

        // Pr√©-remplir avec le template
        document.getElementById('form-annonce-icone').value = template.icone;
        document.getElementById('form-annonce-titre').value = template.titre;
        document.getElementById('form-annonce-description').value = template.description;
        document.getElementById('form-annonce-type').value = template.type;
        document.getElementById('form-annonce-bouton').value = template.bouton_texte;
        document.getElementById('form-annonce-lien').value = template.lien;

        document.getElementById('modal-submit').onclick = saveAnnonce;
        document.getElementById('modal-preview').style.display = 'none';
        overlay.classList.add('active');

        setTimeout(initAnnoncePreview, 50);
    }

    async function saveAnnonce() {
        const id = document.getElementById('form-annonce-id')?.value;
        const titre = document.getElementById('form-annonce-titre').value.trim();
        const description = document.getElementById('form-annonce-description').value.trim();
        const icone = document.getElementById('form-annonce-icone').value.trim() || 'üöÄ';
        const type = document.getElementById('form-annonce-type').value;
        const actif = document.getElementById('form-annonce-actif').value === 'true';
        const lien = document.getElementById('form-annonce-lien').value.trim();
        const bouton_texte = document.getElementById('form-annonce-bouton').value.trim() || 'En savoir plus ‚Üí';
        const date_debut = document.getElementById('form-annonce-date-debut').value || null;
        const date_fin = document.getElementById('form-annonce-date-fin').value || null;
        const ordre = parseInt(document.getElementById('form-annonce-ordre').value) || 0;

        if (!titre) {
            showNotification('Le titre est obligatoire', 'error');
            return;
        }

        const data = {
            titre,
            description,
            icone,
            type,
            actif,
            lien,
            bouton_texte,
            date_debut,
            date_fin,
            ordre
        };

        try {
            const url = id ? `/api/announcements/${id}` : '/api/announcements';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || result.announcement) {
                loadAnnonces();
                loadDashboardStats();
                showNotification(id ? 'Annonce modifi√©e!' : 'Annonce cr√©√©e!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde annonce:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function editAnnonce(id) {
        try {
            const response = await fetch(`/api/announcements/${id}`);
            const result = await response.json();

            if (!result.success || !result.announcement) {
                showNotification('Annonce non trouv√©e', 'error');
                return;
            }

            const annonce = result.announcement;
            currentAnnonceId = id;

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier l\'Annonce';
            body.innerHTML = getAnnonceFormHtml();

            // Pr√©-remplir le formulaire
            document.getElementById('form-annonce-id').value = id;
            document.getElementById('form-annonce-titre').value = annonce.titre || '';
            document.getElementById('form-annonce-description').value = annonce.description || '';
            document.getElementById('form-annonce-icone').value = annonce.icone || 'üöÄ';
            document.getElementById('form-annonce-type').value = annonce.type || 'info';
            document.getElementById('form-annonce-actif').value = annonce.actif ? 'true' : 'false';
            document.getElementById('form-annonce-lien').value = annonce.lien || '';
            document.getElementById('form-annonce-bouton').value = annonce.bouton_texte || 'En savoir plus ‚Üí';
            document.getElementById('form-annonce-ordre').value = annonce.ordre || 0;

            // Dates
            if (annonce.date_debut) {
                const dateDebut = new Date(annonce.date_debut).toISOString().slice(0, 16);
                document.getElementById('form-annonce-date-debut').value = dateDebut;
            }
            if (annonce.date_fin) {
                const dateFin = new Date(annonce.date_fin).toISOString().slice(0, 16);
                document.getElementById('form-annonce-date-fin').value = dateFin;
            }

            document.getElementById('modal-submit').onclick = saveAnnonce;
            overlay.classList.add('active');
            setTimeout(initAnnoncePreview, 50); // Initialiser la preview avec les donn√©es
        } catch (error) {
            console.error('Erreur chargement annonce:', error);
            showNotification('Erreur lors du chargement de l\'annonce', 'error');
        }
    }

    async function deleteAnnonce(id, titre) {
        if (!confirm(`Supprimer l'annonce "${titre}" ?`)) return;

        try {
            const response = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadAnnonces();
                loadDashboardStats();
                showNotification('Annonce supprim√©e', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur suppression annonce:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // Toggle rapide actif/inactif
    async function toggleAnnonceActive(id, actif) {
        try {
            const response = await fetch(`/api/announcements/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ actif })
            });
            const result = await response.json();

            if (result.success || result.announcement) {
                showNotification(actif ? 'Annonce activ√©e' : 'Annonce d√©sactiv√©e', 'success');
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
                loadAnnonces(); // Recharger pour r√©tablir l'√©tat
            }
        } catch (error) {
            console.error('Erreur toggle annonce:', error);
            showNotification('Erreur de connexion', 'error');
            loadAnnonces();
        }
    }

    // Dupliquer une annonce
    async function duplicateAnnonce(id) {
        try {
            const response = await fetch(`/api/announcements/${id}`);
            const result = await response.json();

            if (!result.success || !result.announcement) {
                showNotification('Annonce non trouv√©e', 'error');
                return;
            }

            const original = result.announcement;
            const duplicate = {
                titre: original.titre + ' (copie)',
                description: original.description,
                icone: original.icone,
                type: original.type,
                actif: false, // D√©sactiv√©e par d√©faut
                lien: original.lien,
                bouton_texte: original.bouton_texte,
                ordre: (original.ordre || 0) + 1
            };

            const createResponse = await fetch('/api/announcements', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(duplicate)
            });
            const createResult = await createResponse.json();

            if (createResult.success || createResult.announcement) {
                loadAnnonces();
                loadDashboardStats();
                showNotification('Annonce dupliqu√©e !', 'success');
            } else {
                showNotification('Erreur: ' + (createResult.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur duplication annonce:', error);
            showNotification('Erreur lors de la duplication', 'error');
        }
    }

    // Drag & Drop pour r√©ordonner les annonces
    let draggedRow = null;

    function initAnnoncesDragDrop() {
        const tbody = document.getElementById('table-annonces');
        const rows = tbody.querySelectorAll('.draggable-row');

        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragend', handleDragEnd);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('dragenter', handleDragEnter);
            row.addEventListener('dragleave', handleDragLeave);
            row.addEventListener('drop', handleDrop);
        });
    }

    function handleDragStart(e) {
        draggedRow = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.id);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
        e.preventDefault();
        if (this !== draggedRow) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    async function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');

        if (this === draggedRow) return;

        const tbody = document.getElementById('table-annonces');
        const rows = Array.from(tbody.querySelectorAll('.draggable-row'));
        const draggedIndex = rows.indexOf(draggedRow);
        const targetIndex = rows.indexOf(this);

        // R√©organiser visuellement
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedRow, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedRow, this);
        }

        // Sauvegarder le nouvel ordre
        await saveAnnoncesOrder();
    }

    async function saveAnnoncesOrder() {
        const tbody = document.getElementById('table-annonces');
        const rows = tbody.querySelectorAll('.draggable-row');
        const updates = [];

        rows.forEach((row, index) => {
            updates.push({
                id: parseInt(row.dataset.id),
                ordre: index
            });
        });

        try {
            // Mettre √† jour chaque annonce
            for (const update of updates) {
                await fetch(`/api/announcements/${update.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ordre: update.ordre })
                });
            }
            showNotification('Ordre mis √† jour !', 'success');
        } catch (error) {
            console.error('Erreur sauvegarde ordre:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
            loadAnnonces(); // Recharger en cas d'erreur
        }
    }

    // ========================================
    // ACTIONS GROUP√âES ANNONCES
    // ========================================

    function toggleSelectAll(checked) {
        const checkboxes = document.querySelectorAll('.annonce-checkbox');
        checkboxes.forEach(cb => cb.checked = checked);
        updateBulkSelection();
    }

    function updateBulkSelection() {
        const checkboxes = document.querySelectorAll('.annonce-checkbox:checked');
        const count = checkboxes.length;
        const bar = document.getElementById('bulk-actions-bar');
        const countSpan = document.getElementById('selected-count');

        if (count > 0) {
            bar.style.display = 'flex';
            countSpan.textContent = `${count} s√©lectionn√©(s)`;
        } else {
            bar.style.display = 'none';
        }
    }

    function getSelectedIds() {
        const checkboxes = document.querySelectorAll('.annonce-checkbox:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
    }

    function clearSelection() {
        document.getElementById('select-all-annonces').checked = false;
        toggleSelectAll(false);
    }

    async function bulkToggleActive(actif) {
        const ids = getSelectedIds();
        if (ids.length === 0) return;

        const action = actif ? 'activer' : 'd√©sactiver';
        if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} ${ids.length} annonce(s) ?`)) return;

        try {
            for (const id of ids) {
                await fetch(`/api/announcements/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actif })
                });
            }
            loadAnnonces();
            showNotification(`${ids.length} annonce(s) ${actif ? 'activ√©e(s)' : 'd√©sactiv√©e(s)'}`, 'success');
        } catch (error) {
            console.error('Erreur bulk toggle:', error);
            showNotification('Erreur lors de la mise √† jour', 'error');
        }
    }

    async function bulkDelete() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;

        if (!confirm(`Supprimer d√©finitivement ${ids.length} annonce(s) ?`)) return;

        try {
            for (const id of ids) {
                await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
            }
            loadAnnonces();
            loadDashboardStats();
            showNotification(`${ids.length} annonce(s) supprim√©e(s)`, 'success');
        } catch (error) {
            console.error('Erreur bulk delete:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // ========================================
    // CALENDRIER ANNONCES
    // ========================================

    let calendarDate = new Date();
    let calendarAnnonces = [];
    let calendarFilter = 'all'; // 'all', 'scheduled', 'permanent'

    function setCalendarFilter(filter) {
        calendarFilter = filter;

        // Update button states
        document.querySelectorAll('.calendar-filter .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('filter-' + filter).classList.add('active');

        renderCalendar();
    }

    function switchAnnonceView(view) {
        const listView = document.getElementById('annonces-list-view');
        const calendarView = document.getElementById('annonces-calendar-view');
        const listBtn = document.getElementById('view-list-btn');
        const calendarBtn = document.getElementById('view-calendar-btn');

        if (view === 'list') {
            listView.style.display = 'block';
            calendarView.style.display = 'none';
            listBtn.classList.add('active');
            calendarBtn.classList.remove('active');
        } else {
            listView.style.display = 'none';
            calendarView.style.display = 'block';
            listBtn.classList.remove('active');
            calendarBtn.classList.add('active');
            renderCalendar();
        }
    }

    function changeCalendarMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderCalendar();
    }

    async function renderCalendar() {
        // Charger TOUTES les annonces (avec dates) via l'endpoint admin
        try {
            const response = await fetch('/api/announcements/admin/all');
            const data = await response.json();
            calendarAnnonces = data.announcements || [];
            console.log('üìÖ Annonces charg√©es:', calendarAnnonces.map(a => ({
                titre: a.titre,
                date_debut: a.date_debut,
                date_fin: a.date_fin,
                actif: a.actif
            })));
        } catch (error) {
            console.error('Erreur chargement annonces calendrier:', error);
        }

        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();

        // Mettre √† jour le titre
        const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        document.getElementById('calendar-month-title').textContent = `${monthNames[month]} ${year}`;

        // Calculer les jours
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Lundi = 0
        const daysInMonth = lastDay.getDate();

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        // G√©n√©rer le HTML
        let html = '';

        // En-t√™tes jours
        const dayHeaders = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        dayHeaders.forEach(d => {
            html += `<div class="calendar-day-header">${d}</div>`;
        });

        // Jours du mois pr√©c√©dent
        const prevMonth = new Date(year, month, 0);
        const prevDays = prevMonth.getDate();
        for (let i = startDayOfWeek - 1; i >= 0; i--) {
            const day = prevDays - i;
            html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
        }

        // Jours du mois actuel
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = dateStr === todayStr;
            const events = getEventsForDate(dateStr);
            const hasEvents = events.length > 0;

            html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasEvents ? 'has-events' : ''}" data-date="${dateStr}" onclick="showDayDetails('${dateStr}', event)">
                <span class="calendar-day-number">${day}</span>
                <div class="calendar-day-events">
                    ${events.map(e => `<span class="calendar-event-dot type-${e.type}" title="${e.titre}"></span>`).join('')}
                </div>
            </div>`;
        }

        // Jours du mois suivant
        const totalCells = startDayOfWeek + daysInMonth;
        const remaining = 7 - (totalCells % 7);
        if (remaining < 7) {
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${i}</span></div>`;
            }
        }

        document.getElementById('annonces-calendar').innerHTML = html;
    }

    // Popup d√©tails du jour
    function showDayDetails(dateStr, event) {
        const events = getEventsForDate(dateStr);
        if (events.length === 0) return;

        // Formater la date
        const [year, month, day] = dateStr.split('-');
        const dateFormatted = `${day}/${month}/${year}`;

        // Cr√©er ou r√©cup√©rer le popup
        let popup = document.getElementById('calendar-popup');
        if (!popup) {
            popup = document.createElement('div');
            popup.id = 'calendar-popup';
            popup.className = 'calendar-popup';
            document.body.appendChild(popup);

            // Fermer au clic ext√©rieur
            document.addEventListener('click', (e) => {
                if (!popup.contains(e.target) && !e.target.closest('.calendar-day')) {
                    popup.style.display = 'none';
                }
            });
        }

        // Contenu du popup
        popup.innerHTML = `
            <div class="popup-header">
                <strong>üìÖ ${dateFormatted}</strong>
                <span class="popup-close" onclick="document.getElementById('calendar-popup').style.display='none'">‚úï</span>
            </div>
            <div class="popup-content">
                ${events.map(e => {
                    const iconDisplay = convertIconToEmoji(e.icone) || e.icone || 'üì¢';
                    return `
                    <div class="popup-event">
                        <span class="popup-event-icon">${iconDisplay}</span>
                        <div class="popup-event-info">
                            <div class="popup-event-title">${e.titre}</div>
                            <div class="popup-event-meta">
                                <span class="popup-badge type-${e.type}">${e.type}</span>
                                ${e.actif ? '<span class="popup-badge active">Actif</span>' : '<span class="popup-badge inactive">Inactif</span>'}
                            </div>
                        </div>
                        <button class="popup-edit-btn" onclick="editAnnonce(${e.id}); document.getElementById('calendar-popup').style.display='none';">‚úèÔ∏è</button>
                    </div>
                `}).join('')}
            </div>
        `;

        // Positionner le popup pr√®s du clic
        const rect = event.target.closest('.calendar-day').getBoundingClientRect();
        popup.style.display = 'block';
        popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        popup.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
    }

    function getEventsForDate(dateStr) {
        // dateStr format: "2026-02-05"
        const [year, month, day] = dateStr.split('-').map(Number);
        const checkDate = new Date(year, month - 1, day, 12, 0, 0); // Midi pour √©viter timezone issues

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return calendarAnnonces.filter(a => {
            if (a.actif === false) return false;

            const isPermanent = !a.date_debut && !a.date_fin;
            const isScheduled = a.date_debut || a.date_fin;

            // Appliquer le filtre
            if (calendarFilter === 'scheduled' && isPermanent) return false;
            if (calendarFilter === 'permanent' && isScheduled) return false;

            // Pour les permanentes
            if (isPermanent) {
                if (calendarFilter === 'all' && checkDate > today) {
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    if (checkDate > weekFromNow) return false;
                }
                return true;
            }

            // Pour les programm√©es, v√©rifier les dates
            let debutDate = new Date(0);
            let finDate = new Date('2099-12-31');

            if (a.date_debut) {
                const d = new Date(a.date_debut);
                debutDate = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0);
            }
            if (a.date_fin) {
                const f = new Date(a.date_fin);
                finDate = new Date(f.getFullYear(), f.getMonth(), f.getDate(), 23, 59, 59);
            }

            const dayStart = new Date(year, month - 1, day, 0, 0, 0);
            const dayEnd = new Date(year, month - 1, day, 23, 59, 59);

            // Le jour chevauche la p√©riode de l'annonce ?
            return dayEnd >= debutDate && dayStart <= finDate;
        });
    }

    // ========================================
    // TECHNOLOGIES - FORMULAIRE ET CRUD
    // ========================================
    function getTechnologieFormHtml() {
        return `
            <input type="hidden" id="form-tech-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji) *</label>
                    <input type="text" class="form-input" id="form-tech-icone" placeholder="‚ö°" value="‚ö°" maxlength="4" style="font-size: 1.5rem; text-align: center;">
                </div>
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Nom *</label>
                    <input type="text" class="form-input" id="form-tech-nom" placeholder="Ex: Intelligence Artificielle" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="form-tech-description" placeholder="Description de la technologie..." rows="3"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <select class="form-select" id="form-tech-categorie" required>
                        <option value="">-- Choisir --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Taux d'adoption (%)</label>
                    <input type="number" class="form-input" id="form-tech-taux" placeholder="75" min="0" max="100">
                </div>
            </div>
        `;
    }

    async function saveTechnologie() {
        const id = document.getElementById('form-tech-id')?.value;
        const nom = document.getElementById('form-tech-nom').value.trim();
        const description = document.getElementById('form-tech-description').value.trim();
        const icone = document.getElementById('form-tech-icone').value.trim() || '‚ö°';
        const categorie = document.getElementById('form-tech-categorie').value;
        const taux_adoption = parseInt(document.getElementById('form-tech-taux').value) || null;

        if (!nom) {
            showNotification('Le nom est obligatoire', 'error');
            return;
        }
        if (!categorie) {
            showNotification('La cat√©gorie est obligatoire', 'error');
            return;
        }

        const data = { nom, description, icone, taux_adoption, categorie };

        try {
            const url = id ? `/api/technologies/${id}` : '/api/technologies';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || result.technologie) {
                loadTechnologies();
                showNotification(id ? 'Technologie modifi√©e!' : 'Technologie cr√©√©e!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde technologie:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function editTechnologie(id, categorie) {
        try {
            const response = await fetch(`/api/technologies/${categorie}`);
            const techs = await response.json();
            const tech = Array.isArray(techs) ? techs.find(t => t.id === id) : null;

            if (!tech) {
                showNotification('Technologie non trouv√©e', 'error');
                return;
            }

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier la Technologie';
            body.innerHTML = getTechnologieFormHtml();
            await populateFormCategories('form-tech-categorie');

            document.getElementById('form-tech-id').value = id;
            document.getElementById('form-tech-nom').value = tech.nom || '';
            document.getElementById('form-tech-description').value = tech.description || '';
            document.getElementById('form-tech-icone').value = tech.icone || '‚ö°';
            document.getElementById('form-tech-categorie').value = categorie;
            document.getElementById('form-tech-taux').value = tech.taux_adoption || '';

            document.getElementById('modal-submit').onclick = saveTechnologie;
            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement technologie:', error);
            showNotification('Erreur lors du chargement', 'error');
        }
    }

    async function deleteTechnologie(id, nom, categorie) {
        if (!confirm(`Supprimer la technologie "${nom}" ?`)) return;

        try {
            const response = await fetch(`/api/technologies/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadTechnologies();
                showNotification('Technologie supprim√©e', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur suppression technologie:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // ========================================
    // MARCH√â - FORMULAIRE ET CRUD
    // ========================================
    function getMarcheFormHtml() {
        return `
            <input type="hidden" id="form-marche-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji) *</label>
                    <input type="text" class="form-input" id="form-marche-icone" placeholder="üìà" value="üìà" maxlength="10" style="font-size: 1.5rem; text-align: center;">
                    <small style="color: var(--text-muted);">Emoji ou: xbox, playstation, nintendo</small>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Valeur / Titre *</label>
                    <input type="text" class="form-input" id="form-marche-valeur" placeholder="Ex: 45.2 milliards $" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Label / Description *</label>
                <input type="text" class="form-input" id="form-marche-label" placeholder="Ex: March√© mondial des drones" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <select class="form-select" id="form-marche-categorie" required>
                        <option value="">-- Choisir --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tendance *</label>
                    <select class="form-select" id="form-marche-tendance">
                        <option value="up">‚Üë Hausse</option>
                        <option value="stable">‚Üí Stable</option>
                        <option value="down">‚Üì Baisse</option>
                    </select>
                </div>
            </div>
        `;
    }

    async function saveMarche() {
        const id = document.getElementById('form-marche-id')?.value;
        const valeur = document.getElementById('form-marche-valeur').value.trim();
        const label = document.getElementById('form-marche-label').value.trim();
        const icone = document.getElementById('form-marche-icone').value.trim() || 'üìà';
        const categorie = document.getElementById('form-marche-categorie').value;
        const tendance = document.getElementById('form-marche-tendance').value;

        if (!valeur) {
            showNotification('La valeur est obligatoire', 'error');
            return;
        }
        if (!label) {
            showNotification('Le label est obligatoire', 'error');
            return;
        }
        if (!categorie) {
            showNotification('La cat√©gorie est obligatoire', 'error');
            return;
        }

        const data = { valeur, label, icone, tendance, categorie };

        try {
            const url = id ? `/api/marche/${id}` : '/api/marche';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || result.marche) {
                loadMarche();
                showNotification(id ? 'Donn√©e march√© modifi√©e!' : 'Donn√©e march√© cr√©√©e!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde march√©:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function editMarche(id, categorie) {
        try {
            const response = await fetch(`/api/marche/${categorie}`);
            const items = await response.json();
            const item = Array.isArray(items) ? items.find(m => m.id === id) : null;

            if (!item) {
                showNotification('Donn√©e march√© non trouv√©e', 'error');
                return;
            }

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier la Donn√©e March√©';
            body.innerHTML = getMarcheFormHtml();
            await populateFormCategories('form-marche-categorie');

            document.getElementById('form-marche-id').value = id;
            document.getElementById('form-marche-valeur').value = item.valeur || '';
            document.getElementById('form-marche-label').value = item.label || '';
            document.getElementById('form-marche-icone').value = item.icone || 'üìà';
            document.getElementById('form-marche-categorie').value = categorie;
            document.getElementById('form-marche-tendance').value = item.tendance || 'stable';

            document.getElementById('modal-submit').onclick = saveMarche;
            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement march√©:', error);
            showNotification('Erreur lors du chargement', 'error');
        }
    }

    async function deleteMarche(id, label, categorie) {
        if (!confirm(`Supprimer la donn√©e march√© "${label}" ?`)) return;

        try {
            const response = await fetch(`/api/marche/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadMarche();
                showNotification('Donn√©e march√© supprim√©e', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur suppression march√©:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // ========================================
    // PR√âDICTIONS - FORMULAIRE ET CRUD
    // ========================================
    function getPredictionFormHtml() {
        const currentYear = new Date().getFullYear();
        return `
            <input type="hidden" id="form-pred-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji)</label>
                    <input type="text" class="form-input" id="form-pred-icone" placeholder="üîÆ" value="üîÆ" maxlength="10" style="font-size: 1.5rem; text-align: center;">
                </div>
                <div class="form-group">
                    <label class="form-label">Ann√©e</label>
                    <input type="number" class="form-input" id="form-pred-annee" placeholder="${currentYear + 1}" min="2020" max="2050">
                </div>
                <div class="form-group">
                    <label class="form-label">Probabilit√© (%)</label>
                    <input type="number" class="form-input" id="form-pred-probabilite" placeholder="75" min="0" max="100">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Titre / Pr√©diction *</label>
                <input type="text" class="form-input" id="form-pred-titre" placeholder="Ex: L'IA d√©passera les capacit√©s humaines" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="form-pred-description" placeholder="D√©tails de la pr√©diction..." rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Cat√©gorie *</label>
                <select class="form-select" id="form-pred-categorie" required>
                    <option value="">-- Choisir --</option>
                </select>
            </div>
        `;
    }

    async function savePrediction() {
        const id = document.getElementById('form-pred-id')?.value;
        const titre = document.getElementById('form-pred-titre').value.trim();
        const description = document.getElementById('form-pred-description').value.trim();
        const icone = document.getElementById('form-pred-icone').value.trim() || 'üîÆ';
        const categorie = document.getElementById('form-pred-categorie').value;
        const annee = document.getElementById('form-pred-annee').value;
        const probabilite = document.getElementById('form-pred-probabilite').value;

        if (!titre) {
            showNotification('Le titre est obligatoire', 'error');
            return;
        }
        if (!categorie) {
            showNotification('La cat√©gorie est obligatoire', 'error');
            return;
        }

        const data = { titre, description, icone, categorie, annee, probabilite };

        try {
            const url = id ? `/api/predictions/${id}` : '/api/predictions';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || result.prediction) {
                loadPredictions();
                showNotification(id ? 'Pr√©diction modifi√©e!' : 'Pr√©diction cr√©√©e!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde pr√©diction:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function editPrediction(id, categorie) {
        try {
            const response = await fetch(`/api/predictions/${categorie}`);
            const items = await response.json();
            const item = Array.isArray(items) ? items.find(p => p.id === id) : null;

            if (!item) {
                showNotification('Pr√©diction non trouv√©e', 'error');
                return;
            }

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier la Pr√©diction';
            body.innerHTML = getPredictionFormHtml();
            await populateFormCategories('form-pred-categorie');

            document.getElementById('form-pred-id').value = id;
            document.getElementById('form-pred-titre').value = item.titre || '';
            document.getElementById('form-pred-description').value = item.description || '';
            document.getElementById('form-pred-icone').value = item.icone || 'üîÆ';
            document.getElementById('form-pred-categorie').value = categorie;
            document.getElementById('form-pred-annee').value = item.annee || '';
            document.getElementById('form-pred-probabilite').value = item.probabilite || '';

            document.getElementById('modal-submit').onclick = savePrediction;
            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement pr√©diction:', error);
            showNotification('Erreur lors du chargement', 'error');
        }
    }

    async function deletePrediction(id, titre, categorie) {
        if (!confirm(`Supprimer la pr√©diction "${titre}" ?`)) return;

        try {
            const response = await fetch(`/api/predictions/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadPredictions();
                showNotification('Pr√©diction supprim√©e', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur suppression pr√©diction:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // ========================================
    // WIKI - CHARGEMENT ET AFFICHAGE
    // ========================================
    let allWikiPages = [];
    const wikiCategories = [
        { value: 'general', label: 'G√©n√©ral' },
        { value: 'getting-started', label: 'D√©marrage' },
        { value: 'api', label: 'API & Backend' },
        { value: 'frontend', label: 'Frontend' },
        { value: 'tools', label: 'Outils' },
        { value: 'deployment', label: 'D√©ploiement' },
        { value: 'support', label: 'Support' }
    ];

    async function loadWiki() {
        try {
            const response = await fetch('/api/wiki/admin/all');
            const data = await response.json();
            allWikiPages = data.pages || [];
            populateFilterWiki();
            renderWiki(allWikiPages);
        } catch (error) {
            console.error('Erreur chargement wiki:', error);
            document.getElementById('table-wiki').innerHTML = '<tr><td colspan="6" class="empty-state">Erreur de chargement</td></tr>';
        }
    }

    function renderWiki(pages) {
        const tbody = document.getElementById('table-wiki');
        if (pages.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucune page wiki trouv√©e</td></tr>';
            return;
        }

        tbody.innerHTML = pages.map(p => {
            const statusClass = p.actif ? 'badge-success' : 'badge-danger';
            const statusText = p.actif ? 'Actif' : 'Inactif';
            const catLabel = wikiCategories.find(c => c.value === p.categorie)?.label || p.categorie;
            return `
            <tr>
                <td style="font-size: 1.5rem;">${p.icone || 'üìÑ'}</td>
                <td><strong>${p.titre || '-'}</strong></td>
                <td><code style="background: var(--bg-darker); padding: 2px 6px; border-radius: 4px;">${p.slug || '-'}</code></td>
                <td><span class="data-table-badge badge-info">${catLabel}</span></td>
                <td><span class="data-table-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn" title="Voir" onclick="window.open('/2026/wiki.html?page=${p.slug}', '_blank')">üëÅÔ∏è</button>
                    <button class="action-btn edit" title="Modifier" onclick="editWiki(${p.id})">‚úèÔ∏è</button>
                    <button class="action-btn delete" title="Supprimer" onclick="deleteWiki(${p.id}, '${(p.titre || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                </td>
            </tr>
        `}).join('');
    }

    function populateFilterWiki() {
        const filter = document.getElementById('filter-categorie-wiki');
        if (filter) {
            filter.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                wikiCategories.map(c => `<option value="${c.value}">${c.label}</option>`).join('');
        }
    }

    function filterWiki() {
        const search = document.getElementById('search-wiki')?.value.toLowerCase() || '';
        const categorie = document.getElementById('filter-categorie-wiki')?.value || '';
        const filtered = allWikiPages.filter(p => {
            const titre = (p.titre || '').toLowerCase();
            const slug = (p.slug || '').toLowerCase();
            return (!search || titre.includes(search) || slug.includes(search)) &&
                   (!categorie || p.categorie === categorie);
        });
        renderWiki(filtered);
    }

    // ========================================
    // WIKI - FORMULAIRE ET CRUD
    // ========================================
    function getWikiFormHtml() {
        const categoriesOptions = wikiCategories.map(c =>
            `<option value="${c.value}">${c.label}</option>`
        ).join('');

        return `
            <input type="hidden" id="form-wiki-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji)</label>
                    <input type="text" class="form-input" id="form-wiki-icone" placeholder="üìÑ" value="üìÑ" maxlength="4" style="font-size: 1.5rem; text-align: center;">
                </div>
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Titre *</label>
                    <input type="text" class="form-input" id="form-wiki-titre" placeholder="Ex: Guide d'installation" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Slug (URL)</label>
                    <input type="text" class="form-input" id="form-wiki-slug" placeholder="guide-installation (auto-g√©n√©r√© si vide)">
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <select class="form-select" id="form-wiki-categorie" required>
                        ${categoriesOptions}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Description courte</label>
                <input type="text" class="form-input" id="form-wiki-description" placeholder="Description pour la liste des pages">
            </div>
            <div class="form-group">
                <label class="form-label">Contenu (HTML)</label>
                <textarea class="form-textarea" id="form-wiki-contenu" placeholder="<h2>Titre</h2><p>Contenu de la page...</p>" rows="12" style="font-family: monospace;"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ordre</label>
                    <input type="number" class="form-input" id="form-wiki-ordre" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="form-wiki-actif">
                        <option value="true">Actif</option>
                        <option value="false">Inactif</option>
                    </select>
                </div>
            </div>
        `;
    }

    async function saveWiki() {
        const id = document.getElementById('form-wiki-id')?.value;
        const titre = document.getElementById('form-wiki-titre').value.trim();
        const slug = document.getElementById('form-wiki-slug').value.trim();
        const description = document.getElementById('form-wiki-description').value.trim();
        const contenu = document.getElementById('form-wiki-contenu').value;
        const icone = document.getElementById('form-wiki-icone').value.trim() || 'üìÑ';
        const categorie = document.getElementById('form-wiki-categorie').value;
        const ordre = parseInt(document.getElementById('form-wiki-ordre').value) || 0;
        const actif = document.getElementById('form-wiki-actif').value === 'true';

        if (!titre) {
            showNotification('Le titre est obligatoire', 'error');
            return;
        }

        const data = { titre, slug: slug || null, description, contenu, icone, categorie, ordre, actif };

        try {
            const url = id ? `/api/wiki/${id}` : '/api/wiki';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || result.page) {
                loadWiki();
                showNotification(id ? 'Page wiki modifi√©e!' : 'Page wiki cr√©√©e!', 'success');
                closeModal();
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur sauvegarde wiki:', error);
            showNotification('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function editWiki(id) {
        try {
            const response = await fetch(`/api/wiki/${id}`);
            const data = await response.json();
            const page = data.page;

            if (!page) {
                showNotification('Page non trouv√©e', 'error');
                return;
            }

            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Modifier la Page Wiki';
            body.innerHTML = getWikiFormHtml();

            document.getElementById('form-wiki-id').value = id;
            document.getElementById('form-wiki-titre').value = page.titre || '';
            document.getElementById('form-wiki-slug').value = page.slug || '';
            document.getElementById('form-wiki-description').value = page.description || '';
            document.getElementById('form-wiki-contenu').value = page.contenu || '';
            document.getElementById('form-wiki-icone').value = page.icone || 'üìÑ';
            document.getElementById('form-wiki-categorie').value = page.categorie || 'general';
            document.getElementById('form-wiki-ordre').value = page.ordre || 0;
            document.getElementById('form-wiki-actif').value = page.actif ? 'true' : 'false';

            document.getElementById('modal-submit').onclick = saveWiki;
            overlay.classList.add('active');
        } catch (error) {
            console.error('Erreur chargement page wiki:', error);
            showNotification('Erreur lors du chargement', 'error');
        }
    }

    async function deleteWiki(id, titre) {
        if (!confirm(`Supprimer la page "${titre}" ?`)) return;

        try {
            const response = await fetch(`/api/wiki/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadWiki();
                showNotification('Page wiki supprim√©e', 'success');
            } else {
                showNotification('Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erreur suppression wiki:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    // Helper pour peupler les cat√©gories dans les formulaires
    async function populateFormCategories(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;

        try {
            if (allCategories.length === 0) {
                const catRes = await fetch('/api/categories');
                const catData = await catRes.json();
                allCategories = extractData(catData);
            }
            select.innerHTML = '<option value="">-- Choisir --</option>' +
                allCategories.map(c => `<option value="${c.nom}">${c.nom}</option>`).join('');
        } catch (e) {
            console.error('Erreur chargement cat√©gories:', e);
        }
    }

    // Notification toast
    function showNotification(message, type = 'info') {
        const existing = document.querySelector('.toast-notification');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            background: ${type === 'success' ? 'var(--tech-green)' : type === 'error' ? 'var(--tech-red)' : 'var(--tech-blue)'};
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    async function deleteProduit(id, nom) {
        if (!confirm(`Supprimer le produit "${nom}" ?\n\nCette action est irr√©versible.`)) return;

        try {
            const response = await fetch(`/api/produits/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadProduits();
                loadDashboardStats();
                showNotification('Produit supprim√© avec succ√®s!', 'success');
            } else {
                showNotification('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur suppression:', error);
            showNotification('Erreur lors de la suppression', 'error');
        }
    }

    function refreshStats() {
        loadDashboardStats();
    }

    // ========================================
    // PR√âVISUALISATION
    // ========================================
    function previewItem() {
        const type = document.getElementById('modal-preview').dataset.type;

        if (type === 'produit') {
            previewProduit();
        } else if (type === 'article') {
            previewArticle();
        }
    }

    function previewProduit() {
        const nom = document.getElementById('form-produit-nom')?.value || 'Sans titre';
        const titreAffiche = document.getElementById('form-produit-titre-affiche')?.value || nom;
        const categorie = document.getElementById('form-produit-categorie')?.value || 'Non cat√©goris√©';
        const prix = document.getElementById('form-produit-prix')?.value || '-';
        const description = document.getElementById('form-produit-description')?.value || '';

        // Image preview
        let imgHtml = '<div style="width: 200px; height: 200px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 4rem;">üì¶</div>';
        const imgPreview = document.getElementById('image-preview-img');
        if (imgPreview && imgPreview.style.display !== 'none') {
            imgHtml = `<img src="${imgPreview.src}" style="max-width: 200px; max-height: 200px; border-radius: 12px; object-fit: cover;">`;
        }

        const previewHtml = `
            <div style="background: var(--bg-primary); padding: 2rem; border-radius: 12px;">
                <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                    ${imgHtml}
                    <div style="flex: 1;">
                        <span style="color: var(--tech-cyan); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">${categorie}</span>
                        <h1 style="font-size: 1.8rem; margin: 0.5rem 0; color: var(--text-primary);">${titreAffiche}</h1>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">${description || 'Aucune description'}</p>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--tech-cyan);">${prix}</div>
                    </div>
                </div>
                <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center;">
                        Cette pr√©visualisation montre l'aper√ßu du produit tel qu'il appara√Ætra sur la fiche produit.
                    </p>
                </div>
            </div>
        `;

        document.getElementById('preview-body').innerHTML = previewHtml;
        document.getElementById('preview-overlay').classList.add('active');
    }

    function previewArticle() {
        const titre = document.getElementById('form-article-titre')?.value || 'Sans titre';
        const categorie = document.getElementById('form-article-categorie')?.value || 'Non cat√©goris√©';
        const resume = document.getElementById('form-article-resume')?.value || '';
        const imageUrl = document.getElementById('form-article-image')?.value || '';

        // Pr√©visualiser les sections
        let sectionsHtml = '';
        if (articleSections && articleSections.length > 0) {
            sectionsHtml = articleSections.map(section => `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--tech-cyan); margin-bottom: 0.5rem;">${section.titre || 'Section sans titre'}</h3>
                    <p style="color: var(--text-secondary);">${section.contenu || ''}</p>
                </div>
            `).join('');
        } else {
            sectionsHtml = '<p style="color: var(--text-muted); text-align: center;">Aucune section ajout√©e</p>';
        }

        const imgHtml = imageUrl
            ? `<img src="${imageUrl}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; margin-bottom: 1.5rem;">`
            : '';

        const previewHtml = `
            <div style="background: var(--bg-primary); padding: 2rem; border-radius: 12px;">
                ${imgHtml}
                <span style="color: var(--tech-purple); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">${categorie}</span>
                <h1 style="font-size: 2rem; margin: 0.5rem 0 1rem; color: var(--text-primary);">${titre}</h1>
                ${resume ? `<p style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">${resume}</p>` : ''}
                <div style="color: var(--text-primary);">
                    ${sectionsHtml}
                </div>
                <div style="padding-top: 1rem; border-top: 1px solid var(--border-color); margin-top: 1rem;">
                    <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center;">
                        Cette pr√©visualisation montre l'aper√ßu de l'article tel qu'il appara√Ætra sur la page tendances.
                    </p>
                </div>
            </div>
        `;

        document.getElementById('preview-body').innerHTML = previewHtml;
        document.getElementById('preview-overlay').classList.add('active');
    }

    function closePreview() {
        document.getElementById('preview-overlay').classList.remove('active');
    }

    // ========================================
    // LOGS D'ACTIVIT√â
    // ========================================
    let logsPage = 0;
    const logsLimit = 20;

    async function loadActivityLogs() {
        const action = document.getElementById('filter-action-logs')?.value || '';
        const entityType = document.getElementById('filter-entity-logs')?.value || '';

        try {
            const params = new URLSearchParams({
                limit: logsLimit,
                offset: logsPage * logsLimit
            });
            if (action) params.append('action', action);
            if (entityType) params.append('entity_type', entityType);

            const [logsResponse, statsResponse] = await Promise.all([
                fetch(`/api/activity-logs?${params}`),
                fetch('/api/activity-logs/stats')
            ]);

            const logsData = await logsResponse.json();
            const statsData = await statsResponse.json();

            if (logsData.success) {
                renderActivityLogs(logsData.data);

                // Pagination
                const totalPages = Math.ceil(logsData.total / logsLimit);
                document.getElementById('logs-page-info').textContent = `Page ${logsPage + 1} / ${totalPages || 1}`;
                document.getElementById('logs-prev').disabled = logsPage === 0;
                document.getElementById('logs-next').disabled = logsPage >= totalPages - 1;

                // Stats
                document.getElementById('logs-total').textContent = logsData.total;
            }

            if (statsData.success) {
                document.getElementById('logs-24h').textContent = statsData.stats.last24h;
            }

        } catch (error) {
            console.error('Erreur chargement logs:', error);
            document.getElementById('table-logs').innerHTML = '<tr><td colspan="5" class="empty-state">Erreur de chargement</td></tr>';
        }
    }

    function renderActivityLogs(logs) {
        const tbody = document.getElementById('table-logs');

        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Aucune activit√© enregistr√©e</td></tr>';
            return;
        }

        const actionLabels = {
            'create': { label: 'Cr√©ation', class: 'badge-success' },
            'update': { label: 'Modification', class: 'badge-warning' },
            'delete': { label: 'Suppression', class: 'badge-danger' },
            'feature': { label: 'Vedette +', class: 'badge-info' },
            'unfeature': { label: 'Vedette -', class: 'badge-secondary' },
            'export': { label: 'Export', class: 'badge-info' },
            'import': { label: 'Import', class: 'badge-info' }
        };

        const entityLabels = {
            'produit': 'Produit',
            'produits': 'Produits',
            'article': 'Article',
            'categorie': 'Cat√©gorie'
        };

        tbody.innerHTML = logs.map(log => {
            const date = new Date(log.created_at);
            const dateStr = date.toLocaleDateString('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            const actionInfo = actionLabels[log.action] || { label: log.action, class: 'badge-secondary' };
            const entityLabel = entityLabels[log.entity_type] || log.entity_type;

            let detailsHtml = '-';
            if (log.details) {
                try {
                    const details = typeof log.details === 'string' ? JSON.parse(log.details) : log.details;
                    const detailsStr = Object.entries(details)
                        .filter(([k, v]) => v !== null && v !== undefined)
                        .map(([k, v]) => `${k}: ${v}`)
                        .join(', ');
                    if (detailsStr) {
                        detailsHtml = `<span title="${detailsStr}" style="cursor: help;">üìÑ</span>`;
                    }
                } catch (e) {}
            }

            return `
                <tr>
                    <td style="font-size: 0.85rem; color: var(--text-secondary);">${dateStr}</td>
                    <td><span class="data-table-badge ${actionInfo.class}">${actionInfo.label}</span></td>
                    <td>${entityLabel}</td>
                    <td><strong>${log.entity_name || log.entity_id || '-'}</strong></td>
                    <td>${detailsHtml}</td>
                </tr>
            `;
        }).join('');
    }

    async function clearOldLogs() {
        if (!confirm('Supprimer les logs de plus de 30 jours ?')) return;

        try {
            const response = await fetch('/api/activity-logs/clear?days=30', { method: 'DELETE' });
            const data = await response.json();

            if (data.success) {
                showNotification(data.message, 'success');
                loadActivityLogs();
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Erreur nettoyage logs:', error);
            showNotification('Erreur lors du nettoyage', 'error');
        }
    }

    // ========================================
    // INIT
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardStats();

        // Event listeners pour recherche/filtre - Produits & Articles
        document.getElementById('search-produits')?.addEventListener('input', filterProduits);
        document.getElementById('filter-categorie-produits')?.addEventListener('change', filterProduits);
        document.getElementById('search-articles')?.addEventListener('input', filterArticles);
        document.getElementById('filter-categorie-articles')?.addEventListener('change', filterArticles);

        // Event listeners - Technologies, March√©, Pr√©dictions
        document.getElementById('search-technologies')?.addEventListener('input', filterTechnologies);
        document.getElementById('filter-categorie-technologies')?.addEventListener('change', filterTechnologies);
        document.getElementById('search-marche')?.addEventListener('input', filterMarche);
        document.getElementById('filter-categorie-marche')?.addEventListener('change', filterMarche);
        document.getElementById('search-predictions')?.addEventListener('input', filterPredictions);
        document.getElementById('filter-categorie-predictions')?.addEventListener('change', filterPredictions);

        // Event listeners - Wiki
        document.getElementById('search-wiki')?.addEventListener('input', filterWiki);
        document.getElementById('filter-categorie-wiki')?.addEventListener('change', filterWiki);
    });

    // Close modal on overlay click
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'modal-overlay') closeModal();
    });
</script>

</body>
</html>
