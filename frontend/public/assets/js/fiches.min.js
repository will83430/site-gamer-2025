const API_URL=(()=>{const e=window.location.hostname,t=window.location.protocol;return"localhost"===e||"127.0.0.1"===e?"http://localhost:3000/api":`${t}//${e}:3000/api`})();let produitsSelectionnes=[],categorieActuelle="",tousLesProduits=[],statsCache=null;const isMobile=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function getCategorieFromUrl(){const e=new URLSearchParams(window.location.search);return e.get("categorie")||e.get("cat")||""}async function chargerTousLesProduits(){console.log("üîÑ Chargement des produits...");const e=cacheManager.get("produits");if(e)return tousLesProduits=e,void console.log(`‚úÖ ${e.length} produits charg√©s depuis le cache`);try{const e=performance.now(),t=await fetch(`${API_URL}/produits`);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.json(),o=Math.round(performance.now()-e);if(!n.success||!Array.isArray(n.data))throw new Error("Format de donn√©es invalide");tousLesProduits=n.data,cacheManager.set("produits",n.data),console.log(`üåê ${n.data.length} produits charg√©s depuis l'API (${o}ms)`)}catch(e){console.error("‚ùå Erreur chargement produits:",e);const t=localStorage.getItem(cacheManager.generateKey("produits"));if(t)try{const e=JSON.parse(t);return tousLesProduits=e.data,void console.log("üîÑ Utilisation du cache expir√© comme fallback")}catch(e){}tousLesProduits=[],afficherErreurChargement(e.message)}}function afficherProduitsCategorie(e){e.toLowerCase();const t=cacheManager.get("categories",e.toLowerCase());if(t){console.log(`üìÇ Cat√©gorie "${e}" depuis cache`),"function"==typeof afficherProduitsAvecPagination?afficherProduitsAvecPagination(t):afficherProduits(t);const n=document.getElementById("titre-categorie");return void(n&&(n.textContent=formatTitreCategorie(e)))}const n=tousLesProduits.filter(t=>t.categorie&&t.categorie.toLowerCase()===e.toLowerCase());cacheManager.set("categories",n,e.toLowerCase()),"function"==typeof afficherProduitsAvecPagination?afficherProduitsAvecPagination(n):afficherProduits(n);const o=document.getElementById("titre-categorie");o&&(o.textContent=formatTitreCategorie(e))}function afficherToutesCategories(){if(document.getElementById("titre-categorie").textContent="Toutes les cat√©gories",tousLesProduits&&tousLesProduits.length>0){afficherListeCategories([...new Set(tousLesProduits.map(e=>e.categorie).filter(e=>e))])}else afficherListeCategories([])}function afficherProduits(e){const t=document.getElementById("zone-fiches");e&&0!==e.length?(t.innerHTML=(Array.isArray(e)?e:[]).map(e=>{let t="";if(e.image_url)t=e.image_url;else if(e.image){t=`/assets/images/${e.image.replace(/^assets\/images\//,"")}`}else t="/assets/images/placeholder.png";btoa('\n            <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">\n                <rect width="100%" height="100%" fill="#f0f0f0"/>\n                <text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="#999">Chargement...</text>\n            </svg>\n        ');const n=e.lien?e.lien.startsWith("/")?e.lien:`/${e.lien}`:"#";return`\n            <div class="fiche-produit" data-id="${e.id}" \n                 style="position: relative; ${e.top_du_mois?"border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);":""}">\n                \n                ${e.top_du_mois?'\n                    <span class="vedette-badge" style="\n                        background: linear-gradient(45deg, #ff6b6b, #ffd700);\n                        color: white; padding: 4px 8px; border-radius: 12px;\n                        font-size: 12px; font-weight: bold; position: absolute;\n                        top: 10px; right: 10px; z-index: 10;\n                        animation: pulse 2s infinite;\n                        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);\n                    ">üî• TOP</span>\n                ':""}\n\n                <input type="checkbox" class="produit-checkbox" data-id="${e.id}" data-nom="${e.nom}">\n\n                \x3c!-- IMAGE LAZY LOADING --\x3e\n                 <img src="${t}" \n                     alt="${e.nom}" \n                     style="width: 100%; height: 200px; object-fit: cover; background: #f0f0f0;"\n                     onerror="this.onerror=null; this.src='/assets/images/placeholder.png';">\n\n                <div class="overlay-text-produit">${e.titre_affiche||e.nom}</div>\n                <p class="info">${e.description||"Description non disponible"}</p>\n                <p class="info" style="color: #667eea; font-weight: bold;">${e.prix||"Prix non communiqu√©"}</p>\n\n                ${e.fonctionnalites_avancees&&e.fonctionnalites_avancees.length>0?`\n                    <ul style="text-align: left; padding-left: 20px; margin: 10px 0;">\n                        ${e.fonctionnalites_avancees.slice(0,3).map(e=>`<li style="font-size: 0.9em;">${e}</li>`).join("")}\n                    </ul>\n                `:""}\n\n                <a href="${n}" class="btn btn-details">Voir la fiche</a>\n            </div>\n        `}).join(""),setupComparisonCheckboxes()):t.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <p>Aucun produit trouv√© dans cette cat√©gorie</p>\n                <a href="index.html" class="btn">Retour √† l\'accueil</a>\n            </div>\n        '}function afficherListeCategories(e){document.getElementById("zone-fiches").innerHTML=`\n        <div class="categories-grid">\n            ${e.map(e=>`\n                <a href="?categorie=${encodeURIComponent(e)}" class="categorie-card">\n                    <div class="categorie-icon">${getCategorieIcon(e)}</div>\n                    <h3>${formatCategorieName(e)}</h3>\n                    <p>Voir les produits ‚Üí</p>\n                </a>\n            `).join("")}\n        </div>\n    `}function setupEventListeners(){const e=document.getElementById("btn-tendances-categorie");e&&e.addEventListener("click",e=>{if(e.preventDefault(),categorieActuelle){const e=categorieActuelle.toLowerCase().replace(/\s+/g,"-");window.location.href=`tendances-${e}.html`}});const t=document.getElementById("btn-retour");t&&t.addEventListener("click",e=>{e.preventDefault(),categorieActuelle?window.location.href="top-du-mois.html":window.history.length>1?window.history.back():window.location.href="index.html"});const n=document.getElementById("btn-comparer");n&&n.addEventListener("click",comparerProduits)}function setupComparisonCheckboxes(){document.querySelectorAll(".produit-checkbox").forEach(e=>{e.addEventListener("change",e=>{const t=e.target.dataset.id,n=e.target.dataset.nom;e.target.checked?produitsSelectionnes.push({id:t,nom:n}):produitsSelectionnes=produitsSelectionnes.filter(e=>e.id!==t);const o=document.getElementById("btn-comparer");o&&(o.style.display=produitsSelectionnes.length>=2?"block":"none")})})}async function comparerProduits(){if(produitsSelectionnes.length<2)alert("Veuillez s√©lectionner au moins 2 produits √† comparer");else try{const e=document.getElementById("zone-comparaison"),t=document.getElementById("comparaison-content");let n=[];const o=[];if(produitsSelectionnes.forEach(e=>{if(tousLesProduits){const t=tousLesProduits.find(t=>t.id==e.id);t?n.push(t):o.push(e)}else o.push(e)}),o.length>0){const e=await Promise.all(o.map(async e=>{const t=await fetch(`${API_URL}/produits/${e.id}`),n=await t.json();return n.success?n.data:null}));n=[...n,...e.filter(e=>null!==e)]}if(0===n.length)return void alert("Impossible de charger les produits pour la comparaison");t.innerHTML=`\n    <div class="comparaison-grid">\n        ${n.map(e=>{let t=e.image||"";return t?(t.startsWith("/")&&(t=t.substring(1)),t.startsWith("http")||t.startsWith("assets/images/")||(t=`assets/images/${t}`)):t="assets/images/placeholder.png",`\n                <div class="fiche-comparaison">\n                    <img src="${t}" \n                         alt="${e.titre_affiche||e.nom}" \n                         onerror="this.onerror=null;this.src='assets/images/placeholder.png';">\n                    <h4>${e.titre_affiche||e.nom}</h4>\n                    <p class="info"><strong>Prix:</strong> ${e.prix||"N/C"}</p>\n                    <p class="info"><strong>Cat√©gorie:</strong> ${e.categorie||"N/C"}</p>\n                    <p class="info">${e.description||"Description non disponible"}</p>\n                    ${e.fonctionnalites_avancees&&e.fonctionnalites_avancees.length>0?`\n                        <ul>\n                            ${e.fonctionnalites_avancees.slice(0,3).map(e=>`<li>${e}</li>`).join("")}\n                        </ul>\n                    `:""}\n                </div>\n            `}).join("")}\n    </div>\n    <button id="btn-fermer-comparaison" class="btn btn-comparer" onclick="fermerComparaison()">\n        Fermer la comparaison\n    </button>\n`,e.classList.remove("hidden"),e.style.display="block",e.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Erreur lors de la comparaison:",e),alert("Erreur lors de la comparaison des produits")}}function fermerComparaison(){const e=document.getElementById("zone-comparaison");e.classList.add("hidden"),e.style.display="none",document.querySelectorAll(".produit-checkbox").forEach(e=>e.checked=!1),produitsSelectionnes=[];const t=document.getElementById("btn-comparer");t&&(t.style.display="none")}async function afficherDetailsModal(e){try{let t=null;if(tousLesProduits&&(t=tousLesProduits.find(t=>t.id==e)),!t){const n=await fetch(`${API_URL}/produits/${e}`),o=await n.json();o.success&&o.data&&(t=o.data)}if(t){const e=document.createElement("div");e.className="modal-overlay",e.innerHTML=`\n                <div class="modal-content">\n                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>\n                    <h2>${t.nom}</h2>\n                    \n                    ${t.image?`\n    <img src="/assets/images/${t.image}" alt="${t.titre_affiche||t.nom}" style="max-width: 100%; margin: 20px 0;" \n         onerror="this.onerror=null;this.src='/assets/images/placeholder.png';">\n`:""}\n                    \n                    <p><strong>Cat√©gorie:</strong> ${t.categorie}</p>\n                    <p><strong>Prix:</strong> ${t.prix||"Non communiqu√©"}</p>\n                    <p><strong>Description:</strong> ${t.description||"Non disponible"}</p>\n                    \n                    ${t.fonctionnalites_avancees&&t.fonctionnalites_avancees.length>0?`\n                        <h3>Fonctionnalit√©s:</h3>\n                        <ul>\n                            ${t.fonctionnalites_avancees.map(e=>`<li>${e}</li>`).join("")}\n                        </ul>\n                    `:""}\n                    \n                    ${t.donnees_fiche&&t.donnees_fiche.length>0?`\n                        <h3>Informations d√©taill√©es:</h3>\n                        ${t.donnees_fiche.map(e=>`<p>${e}</p>`).join("")}\n                    `:""}\n                </div>\n            `,document.body.appendChild(e)}}catch(e){console.error("Erreur lors du chargement des d√©tails:",e),alert("Impossible de charger les d√©tails du produit")}}function formatCategorieName(e){return{DRONE:"Drones",CONSOLE:"Consoles de Jeux",TABLETTE:"Tablettes",SMARTPHONE:"Smartphones","PC GAMING":"PC Gaming",SERVEUR:"Serveurs","CASQUE AUDIO":"Casques Audio","MONTRE CONNECTEE":"montre-connectee"}[e]||e}function getCategorieIcon(e){return{DRONE:"üöÅ",CONSOLE:"üéÆ",TABLETTE:"üì±",SMARTPHONE:"üì±","PC GAMING":"üíª",SERVEUR:"üñ•Ô∏è","CASQUE AUDIO":"üéß","MONTRE CONNECTEE":"‚åö"}[e]||"üì¶"}function afficherErreur(e){document.getElementById("zone-fiches").innerHTML=`\n        <div class="message-erreur">\n            <p>‚ùå ${e}</p>\n            <a href="index.html" class="btn">Retour √† l'accueil</a>\n        </div>\n    `}async function chargerProduits(e=null){try{let t=`${API_URL}/produits`;e&&(t+=`?categorie=${encodeURIComponent(e)}`);const n=await fetch(t),o=await n.json();o.success&&afficherProduits(o.data,e)}catch(e){console.error("Erreur chargement:",e)}}function initLazyLoading(){if("IntersectionObserver"in window){const e=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const n=e.target;n.src=n.dataset.src,n.classList.remove("lazy"),n.classList.add("loaded"),n.style.opacity="0",n.onload=()=>{n.style.transition="opacity 0.3s",n.style.opacity="1"},t.unobserve(n)}})},{rootMargin:"100px 0px",threshold:.1});document.querySelectorAll("img.lazy").forEach(t=>{e.observe(t)})}else document.querySelectorAll("img.lazy").forEach(e=>{e.src=e.dataset.src,e.classList.remove("lazy")})}document.addEventListener("DOMContentLoaded",async()=>{await chargerTousLesProduits(),categorieActuelle=getCategorieFromUrl(),categorieActuelle?afficherProduitsCategorie(categorieActuelle):afficherToutesCategories(),setupEventListeners()}),document.addEventListener("DOMContentLoaded",()=>{chargerProduits(getCategorieFromUrl())});const ITEMS_PER_PAGE=12;let currentPage=1,totalProduits=[],filteredProduits=[];function afficherProduitsAvecPagination(e,t=!0){t&&(currentPage=1),filteredProduits=Array.isArray(e)?e:[];const n=(currentPage-1)*ITEMS_PER_PAGE,o=n+ITEMS_PER_PAGE;afficherProduits(filteredProduits.slice(n,o)),afficherPagination(filteredProduits.length),t||document.getElementById("zone-fiches").scrollIntoView({behavior:"smooth",block:"start"})}function afficherPagination(e){const t=Math.ceil(e/ITEMS_PER_PAGE);if(t<=1)return void(document.getElementById("pagination-container").innerHTML="");let n='<div class="pagination-container">';currentPage>1&&(n+=`\n            <button class="btn-page" onclick="changerPage(${currentPage-1})">\n                ‚Üê Pr√©c√©dent\n            </button>\n        `);const o=Math.max(1,currentPage-2),a=Math.min(t,currentPage+2);o>1&&(n+='<button class="btn-page" onclick="changerPage(1)">1</button>',o>2&&(n+='<span class="dots">...</span>'));for(let e=o;e<=a;e++)n+=`\n            <button class="btn-page ${e===currentPage?"active":""}" \n                    onclick="changerPage(${e})">\n                ${e}\n            </button>\n        `;a<t&&(a<t-1&&(n+='<span class="dots">...</span>'),n+=`<button class="btn-page" onclick="changerPage(${t})">${t}</button>`),currentPage<t&&(n+=`\n            <button class="btn-page" onclick="changerPage(${currentPage+1})">\n                Suivant ‚Üí\n            </button>\n        `),n+=`\n        <div class="page-info">\n            Page ${currentPage} sur ${t} \n            (${e} produit${e>1?"s":""})\n        </div>\n    `,n+="</div>",document.getElementById("pagination-container").innerHTML=n}function changerPage(e){currentPage=e,afficherProduitsAvecPagination(filteredProduits,!1)}function afficherProduitsCategorie(e){e.toLowerCase();const t=cacheManager.get("categories",e.toLowerCase());if(t){console.log(`üìÇ Cat√©gorie "${e}" depuis cache`),"function"==typeof afficherProduitsAvecPagination?afficherProduitsAvecPagination(t):afficherProduits(t);const n=document.getElementById("titre-categorie");return void(n&&(n.textContent=formatTitreCategorie(e)))}const n=tousLesProduits.filter(t=>t.categorie&&t.categorie.toLowerCase()===e.toLowerCase());cacheManager.set("categories",n,e.toLowerCase()),"function"==typeof afficherProduitsAvecPagination?afficherProduitsAvecPagination(n):afficherProduits(n);const o=document.getElementById("titre-categorie");o&&(o.textContent=formatTitreCategorie(e))}function rechercherProduits(){const e=document.getElementById("search-input").value.toLowerCase().trim();if(!e)return void(categorieActuelle?afficherProduitsCategorie(categorieActuelle):afficherProduitsAvecPagination(tousLesProduits));const t=tousLesProduits.filter(t=>t.nom.toLowerCase().includes(e)||t.description.toLowerCase().includes(e)||t.categorie.toLowerCase().includes(e));afficherProduitsAvecPagination(t),document.getElementById("titre-categorie").textContent=`R√©sultats pour "${e}" (${t.length})`}const searchCache=new Map,SEARCH_CACHE_SIZE=50;function rechercherProduits(){const e=document.getElementById("search-input").value.toLowerCase().trim(),t=`search-${e}`;if(!e)return void(categorieActuelle?afficherProduitsCategorie(categorieActuelle):afficherProduitsAvecPagination(tousLesProduits));if(searchCache.has(t)){const n=searchCache.get(t);return console.log(`üîç Recherche "${e}" depuis cache m√©moire (${n.length} r√©sultats)`),void afficherResultatsRecherche(e,n)}const n=cacheManager.get("search",e);if(n){if(console.log(`üîç Recherche "${e}" depuis cache localStorage`),searchCache.size>=SEARCH_CACHE_SIZE){const e=searchCache.keys().next().value;searchCache.delete(e)}return searchCache.set(t,n),void afficherResultatsRecherche(e,n)}const o=performance.now(),a=tousLesProduits.filter(t=>t.nom.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e)||t.categorie&&t.categorie.toLowerCase().includes(e)||t.titre_affiche&&t.titre_affiche.toLowerCase().includes(e)),i=Math.round(performance.now()-o);if(console.log(`üîç Recherche "${e}" effectu√©e (${i}ms, ${a.length} r√©sultats)`),cacheManager.set("search",a,e),searchCache.size>=SEARCH_CACHE_SIZE){const e=searchCache.keys().next().value;searchCache.delete(e)}searchCache.set(t,a),afficherResultatsRecherche(e,a)}function afficherResultatsRecherche(e,t){afficherProduitsAvecPagination(t),document.getElementById("titre-categorie").textContent=`R√©sultats pour "${e}" (${t.length})`}function afficherStatsCache(){const e=cacheManager.getStats();console.group("üìä Statistiques du Cache"),console.log(`üíæ Taille totale: ${e.totalSize} KB`),console.log(`üì¶ Entr√©es: ${e.entriesCount}`),console.log(`üìä Quota utilis√©: ${e.quotaUsed}%`),console.log("üè∑Ô∏è Par type:",e.typeStats),console.groupEnd(),document.getElementById("cache-stats")&&(document.getElementById("cache-stats").innerHTML=`\n            <div class="cache-stats">\n                <h4>üìä Cache Stats</h4>\n                <p>üíæ ${e.totalSize} KB utilis√©s</p>\n                <p>üì¶ ${e.entriesCount} entr√©es</p>\n                <p>üìä ${e.quotaUsed}% du quota</p>\n                <button onclick="cacheManager.clearAll(); location.reload();">\n                    üóëÔ∏è Vider le cache\n                </button>\n            </div>\n        `)}function forceRefresh(){console.log("üîÑ Force refresh - invalidation du cache..."),cacheManager.invalidate("produits"),cacheManager.invalidate("categories"),cacheManager.invalidate("search"),searchCache.clear(),location.reload()}async function prechargerDonnees(){const e=["smartphones","pc-gaming","casques-audio"];for(const t of e)if(!cacheManager.get("categories",t)){const e=tousLesProduits.filter(e=>e.categorie.toLowerCase()===t);e.length>0&&(cacheManager.set("categories",e,t),console.log(`üéØ Pr√©cache: ${t} (${e.length} produits)`))}}function formatTitreCategorie(e){return e?e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):"Tous les produits"}document.addEventListener("DOMContentLoaded",async()=>{console.log("üöÄ Initialisation avec cache intelligent..."),await chargerTousLesProduits(),categorieActuelle=getCategorieFromUrl(),categorieActuelle?afficherProduitsCategorie(categorieActuelle):afficherToutesCategories(),setupEventListeners(),setTimeout(prechargerDonnees,1e3),setTimeout(()=>{"localhost"===window.location.hostname&&afficherStatsCache()},2e3)});