const API_URL=(()=>{const hostname=window.location.hostname;const protocol=window.location.protocol;const port="3000";if(hostname==="localhost"||hostname==="127.0.0.1"){return"http://localhost:3000/api"}return`${protocol}//${hostname}:${port}/api`})();let produitsSelectionnes=[];let categorieActuelle="";let tousLesProduits=null;let statsCache=null;const isMobile=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);document.addEventListener("DOMContentLoaded",async()=>{await chargerTousLesProduits();const urlParams=new URLSearchParams(window.location.search);categorieActuelle=urlParams.get("categorie")||"";if(categorieActuelle){afficherProduitsCategorie(categorieActuelle)}else{afficherToutesCategories()}setupEventListeners()});async function chargerTousLesProduits(){if(tousLesProduits!==null){return tousLesProduits}try{const controller=new AbortController;const timeoutId=setTimeout(()=>controller.abort(),15e3);const response=await fetch(`${API_URL}/produits`,{signal:controller.signal});clearTimeout(timeoutId);const data=await response.json();if(data.success){tousLesProduits=data.data;return tousLesProduits}else{throw new Error(data.error||"Erreur lors du chargement")}}catch(error){if(error.name==="AbortError"){console.error("⏰ Timeout - chargement trop long");afficherErreur("Connexion trop lente. Réessayez en WiFi.")}else{console.error("❌ Erreur lors du chargement des produits:",error);afficherErreur("Impossible de charger les produits depuis la base de données")}tousLesProduits=[];return[]}}function afficherProduitsCategorie(categorie){const titreElement=document.getElementById("titre-categorie");const descElement=document.getElementById("desc-cat");titreElement.textContent=formatCategorieName(categorie);const descriptions={DRONE:"Découvrez notre gamme de drones professionnels et de loisir",CONSOLE:"Les dernières consoles de jeux vidéo",TABLETTE:"Tablettes tactiles pour tous les usages",SMARTPHONE:"Smartphones dernière génération","PC GAMING":"PC gaming haute performance",SERVEUR:"Serveurs professionnels et solutions d'hébergement","CASQUE AUDIO":"Casques audio haute qualité","MONTRE CONNECTEE":"montre-connectee et trackers d'activité"};descElement.textContent=descriptions[categorie]||`Produits de la catégorie ${categorie}`;if(tousLesProduits&&tousLesProduits.length>0){let produitsFiltres=tousLesProduits.filter(p=>p.categorie===categorie);if(isMobile&&produitsFiltres.length>10){produitsFiltres=produitsFiltres.slice(0,10)}afficherProduits(produitsFiltres)}else{afficherProduits([])}}function afficherToutesCategories(){const titreElement=document.getElementById("titre-categorie");titreElement.textContent="Toutes les catégories";if(tousLesProduits&&tousLesProduits.length>0){const categories=[...new Set(tousLesProduits.map(p=>p.categorie).filter(c=>c))];afficherListeCategories(categories)}else{afficherListeCategories([])}}function afficherProduits(produits){const zonefiches=document.getElementById("zone-fiches");if(!produits||produits.length===0){zonefiches.innerHTML=`\n            <div style="text-align: center; padding: 40px;">\n                <p>Aucun produit trouvé dans cette catégorie</p>\n                <a href="index.html" class="btn">Retour à l'accueil</a>\n            </div>\n        `;return}zonefiches.innerHTML=(Array.isArray(produits)?produits:[]).map(produit=>{let imageUrl=produit.image||"";if(imageUrl){if(imageUrl.startsWith("/")){imageUrl=imageUrl.substring(1)}if(!imageUrl.startsWith("http")&&!imageUrl.startsWith("assets/images/")){imageUrl=`assets/images/${imageUrl}`}}else{imageUrl="assets/images/placeholder.png"}let ficheUrl="#";if(produit.lien){if(produit.lien.startsWith("http")){ficheUrl=produit.lien}else{const baseUrl=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://localhost:3000":`${window.location.protocol}//${window.location.hostname}:3000`;ficheUrl=`${baseUrl}/${produit.lien.replace(/^\/+/,"")}`}}return`\n            <div class="fiche-produit" data-id="${produit.id}" style="position: relative;">\n                ${produit.top_du_mois?'<span class="vedette-badge" style="position: absolute; top: 10px; right: 10px; background: #ffd700; color: #333; z-index: 10;">⭐ TOP</span>':""}\n\n                <input type="checkbox" class="produit-checkbox" data-id="${produit.id}" data-nom="${produit.nom}">\n\n                <img src="${imageUrl}" alt="${produit.nom}" \n                     onerror="this.onerror=null; this.src='assets/images/placeholder.png';">\n\n<div class="overlay-text-produit">${produit.titre_affiche||produit.nom}</div>\n                <p class="info">${produit.description||"Description non disponible"}</p>\n\n                <p class="info" style="color: #667eea; font-weight: bold;">\n                    ${produit.prix||"Prix non communiqué"}\n                </p>\n\n                ${produit.fonctionnalites_avancees&&produit.fonctionnalites_avancees.length>0?`\n                    <ul style="text-align: left; padding-left: 20px; margin: 10px 0;">\n                        ${produit.fonctionnalites_avancees.slice(0,3).map(f=>`<li style="font-size: 0.9em;">✓ ${f}</li>`).join("")}\n                    </ul>\n                `:""}\n\n                ${ficheUrl!=="#"?`\n    <a href="${ficheUrl}" class="btn btn-details">\n        Voir la fiche\n    </a>\n`:`\n    <button class="btn btn-details" onclick="afficherDetailsModal(${produit.id})">\n        Voir la fiche\n    </button>\n                `}\n            </div>\n        `}).join("");setupComparisonCheckboxes()}function afficherListeCategories(categories){const zonefiches=document.getElementById("zone-fiches");zonefiches.innerHTML=`\n        <div class="categories-grid">\n            ${categories.map(cat=>`\n                <a href="?categorie=${encodeURIComponent(cat)}" class="categorie-card">\n                    <div class="categorie-icon">${getCategorieIcon(cat)}</div>\n                    <h3>${formatCategorieName(cat)}</h3>\n                    <p>Voir les produits →</p>\n                </a>\n            `).join("")}\n        </div>\n    `}function setupEventListeners(){const btnRetour=document.getElementById("btn-retour");if(btnRetour){btnRetour.addEventListener("click",e=>{e.preventDefault();if(categorieActuelle){window.location.href="top-du-mois.html"}else if(window.history.length>1){window.history.back()}else{window.location.href="index.html"}})}const btnComparer=document.getElementById("btn-comparer");if(btnComparer){btnComparer.addEventListener("click",comparerProduits)}}function setupComparisonCheckboxes(){const checkboxes=document.querySelectorAll(".produit-checkbox");checkboxes.forEach(checkbox=>{checkbox.addEventListener("change",e=>{const produitId=e.target.dataset.id;const produitNom=e.target.dataset.nom;if(e.target.checked){produitsSelectionnes.push({id:produitId,nom:produitNom})}else{produitsSelectionnes=produitsSelectionnes.filter(p=>p.id!==produitId)}const btnComparer=document.getElementById("btn-comparer");if(btnComparer){btnComparer.style.display=produitsSelectionnes.length>=2?"block":"none"}})})}async function comparerProduits(){if(produitsSelectionnes.length<2){alert("Veuillez sélectionner au moins 2 produits à comparer");return}try{const zoneComparaison=document.getElementById("zone-comparaison");const comparaisonContent=document.getElementById("comparaison-content");let produitsDetails=[];const produitsNonTrouves=[];produitsSelectionnes.forEach(p=>{if(tousLesProduits){const produitCache=tousLesProduits.find(prod=>prod.id==p.id);if(produitCache){produitsDetails.push(produitCache)}else{produitsNonTrouves.push(p)}}else{produitsNonTrouves.push(p)}});if(produitsNonTrouves.length>0){const detailsManquants=await Promise.all(produitsNonTrouves.map(async p=>{const response=await fetch(`${API_URL}/produits/${p.id}`);const data=await response.json();return data.success?data.data:null}));produitsDetails=[...produitsDetails,...detailsManquants.filter(p=>p!==null)]}if(produitsDetails.length===0){alert("Impossible de charger les produits pour la comparaison");return}comparaisonContent.innerHTML=`\n    <div class="comparaison-grid">\n        ${produitsDetails.map(p=>{let imageUrl=p.image||"";if(imageUrl){if(imageUrl.startsWith("/")){imageUrl=imageUrl.substring(1)}if(!imageUrl.startsWith("http")&&!imageUrl.startsWith("assets/images/")){imageUrl=`assets/images/${imageUrl}`}}else{imageUrl="assets/images/placeholder.png"}return`\n                <div class="fiche-comparaison">\n                    <img src="${imageUrl}" \n                         alt="${p.titre_affiche||p.nom}" \n                         onerror="this.onerror=null;this.src='assets/images/placeholder.png';">\n                    <h4>${p.titre_affiche||p.nom}</h4>\n                    <p class="info"><strong>Prix:</strong> ${p.prix||"N/C"}</p>\n                    <p class="info"><strong>Catégorie:</strong> ${p.categorie||"N/C"}</p>\n                    <p class="info">${p.description||"Description non disponible"}</p>\n                    ${p.top_du_mois?`\n    <div class="vedette-badge" style="\n        position: absolute;\n        top: 10px;\n        left: 10px; /* Changé de right à left */\n        background: #ffd700;\n        color: #333;\n        padding: 5px 10px;\n        border-radius: 15px;\n        font-weight: bold;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n        z-index: 10;\n    ">\n        ⭐ Top du mois\n    </div>\n`:""}\n                    ${p.fonctionnalites_avancees&&p.fonctionnalites_avancees.length>0?`\n                        <ul>\n                            ${p.fonctionnalites_avancees.slice(0,5).map(f=>`<li>${f}</li>`).join("")}\n                        </ul>\n                    `:""}\n                </div>\n            `}).join("")}\n    </div>\n    <button id="btn-fermer-comparaison" class="btn btn-comparer" onclick="fermerComparaison()">\n        Fermer la comparaison\n    </button>\n`;zoneComparaison.classList.remove("hidden");zoneComparaison.scrollIntoView({behavior:"smooth"})}catch(error){console.error("Erreur lors de la comparaison:",error);alert("Erreur lors de la comparaison des produits")}}function fermerComparaison(){const zoneComparaison=document.getElementById("zone-comparaison");zoneComparaison.classList.add("hidden");document.querySelectorAll(".produit-checkbox").forEach(cb=>cb.checked=false);produitsSelectionnes=[];const btnComparer=document.getElementById("btn-comparer");if(btnComparer){btnComparer.style.display="none"}}async function afficherDetailsModal(produitId){try{let produit=null;if(tousLesProduits){produit=tousLesProduits.find(p=>p.id==produitId)}if(!produit){const response=await fetch(`${API_URL}/produits/${produitId}`);const data=await response.json();if(data.success&&data.data){produit=data.data}}if(produit){const modal=document.createElement("div");modal.className="modal-overlay";modal.innerHTML=`\n                <div class="modal-content">\n                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>\n                    <h2>${produit.nom}</h2>\n                    \n                    ${produit.image?`\n    <img src="/assets/images/${produit.image}" alt="${produit.titre_affiche||produit.nom}" style="max-width: 100%; margin: 20px 0;" \n         onerror="this.onerror=null;this.src='/assets/images/placeholder.png';">\n`:""}\n                    \n                    <p><strong>Catégorie:</strong> ${produit.categorie}</p>\n                    <p><strong>Prix:</strong> ${produit.prix||"Non communiqué"}</p>\n                    <p><strong>Description:</strong> ${produit.description||"Non disponible"}</p>\n                    \n                    ${produit.fonctionnalites_avancees&&produit.fonctionnalites_avancees.length>0?`\n                        <h3>Fonctionnalités:</h3>\n                        <ul>\n                            ${produit.fonctionnalites_avancees.map(f=>`<li>${f}</li>`).join("")}\n                        </ul>\n                    `:""}\n                    \n                    ${produit.donnees_fiche&&produit.donnees_fiche.length>0?`\n                        <h3>Informations détaillées:</h3>\n                        ${produit.donnees_fiche.map(info=>`<p>${info}</p>`).join("")}\n                    `:""}\n                </div>\n            `;document.body.appendChild(modal)}}catch(error){console.error("Erreur lors du chargement des détails:",error);alert("Impossible de charger les détails du produit")}}function formatCategorieName(categorie){const noms={DRONE:"Drones",CONSOLE:"Consoles de Jeux",TABLETTE:"Tablettes",SMARTPHONE:"Smartphones","PC GAMING":"PC Gaming",SERVEUR:"Serveurs","CASQUE AUDIO":"Casques Audio","MONTRE CONNECTEE":"montre-connectee"};return noms[categorie]||categorie}function getCategorieIcon(categorie){const icons={DRONE:"🚁",CONSOLE:"🎮",TABLETTE:"📱",SMARTPHONE:"📱","PC GAMING":"💻",SERVEUR:"🖥️","CASQUE AUDIO":"🎧","MONTRE CONNECTEE":"⌚"};return icons[categorie]||"📦"}function afficherErreur(message){const zonefiches=document.getElementById("zone-fiches");zonefiches.innerHTML=`\n        <div class="message-erreur">\n            <p>❌ ${message}</p>\n            <a href="index.html" class="btn">Retour à l'accueil</a>\n        </div>\n    `}