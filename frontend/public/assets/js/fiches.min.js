// assets/js/fiches.js - Connexion √† la base de donn√©es PostgreSQL

// D√©tection automatique de l'IP pour mobile
const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:3000/api'
  : `http://${window.location.hostname}:3000/api`;

// Variables globales
let produitsSelectionnes = [];
let categorieActuelle = '';
let tousLesProduits = null; // Cache pour tous les produits
let statsCache = null; // Cache pour les stats

const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', async () => {
    // Event delegation pour les boutons de fermeture
    document.addEventListener('click', (e) => {
        if (e.target.id === 'btn-fermer-comparaison' || e.target.dataset.action === 'fermer') {
            e.preventDefault();
            fermerComparaison();
        }
    });
    
    // Charger une seule fois tous les produits au d√©marrage
    await chargerTousLesProduits();
    
    // R√©cup√©rer la cat√©gorie depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    categorieActuelle = urlParams.get('categorie') || '';
    
    if (categorieActuelle) {
        afficherProduitsCategorie(categorieActuelle);
    } else {
        afficherToutesCategories();
    }
    
    // Configurer les boutons
    setupEventListeners();
});

// Charger TOUS les produits UNE SEULE FOIS et les mettre en cache
async function chargerTousLesProduits() {
    console.log('üîÑ Chargement des produits...');
    const cachedProduits = cacheManager.get('produits');
    if (cachedProduits) {
        tousLesProduits = cachedProduits;
        console.log(`‚úÖ ${cachedProduits.length} produits charg√©s depuis le cache`);
        return;
    }
    try {
        const startTime = performance.now();
        const response = await fetch(`${API_URL}/produits`);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data = await response.json();
        const loadTime = Math.round(performance.now() - startTime);
        if (data.success && Array.isArray(data.data)) {
            tousLesProduits = data.data;
            cacheManager.set('produits', data.data);
            console.log(`üåê ${data.data.length} produits charg√©s depuis l'API (${loadTime}ms)`);
        } else {
            throw new Error('Format de donn√©es invalide');
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement produits:', error);
        tousLesProduits = [];
    }
}

// Afficher les produits d'une cat√©gorie (depuis le cache)
function afficherProduitsCategorie(categorie) {
    let categorieCache = categorie.toLowerCase();
    
    if (categorieCache.includes('-')) {
        categorieCache = categorieCache.replace(/-/g, ' ');
    }
    
    console.log('üîç Recherche cache pour:', categorieCache);
    
    const cachedCategory = cacheManager.get('categories', categorieCache);
    
    if (cachedCategory && Array.isArray(cachedCategory) && cachedCategory.length > 0) {
        console.log('‚úÖ CACHE HIT pour cat√©gorie:', categorie, '- Produits:', cachedCategory.length);
        
        // AFFICHAGE DEPUIS LE CACHE
        if (typeof afficherProduitsAvecPagination === 'function') {
            afficherProduitsAvecPagination(cachedCategory);
        } else {
            afficherProduits(cachedCategory);
        }
        
        // Mettre √† jour le titre
        const titreElement = document.getElementById('titre-categorie');
        if (titreElement) {
            titreElement.textContent = formatTitreCategorie(categorie);
        }
        
        return; // ‚Üê IMPORTANT: Sortir de la fonction ici !
    }
    
    console.log('‚ùå CACHE MISS pour cat√©gorie:', categorieCache);
    
    // CHARGEMENT NORMAL (premi√®re fois)
    const produitsFilters = tousLesProduits.filter(p => 
        p.categorie && p.categorie.toLowerCase() === categorieCache
    );
    
    console.log('üíæ Sauvegarde en cache:', categorieCache, '- Produits:', produitsFilters.length);
    cacheManager.set('categories', produitsFilters, categorieCache);
    
    if (typeof afficherProduitsAvecPagination === 'function') {
        afficherProduitsAvecPagination(produitsFilters);
    } else {
        afficherProduits(produitsFilters);
    }
    
    const titreElement = document.getElementById('titre-categorie');
    if (titreElement) {
        titreElement.textContent = formatTitreCategorie(categorie);
    }
}

// Afficher toutes les cat√©gories disponibles (depuis le cache)
function afficherToutesCategories() {
    const titreElement = document.getElementById('titre-categorie');
    titreElement.textContent = 'Toutes les cat√©gories';
    
    if (tousLesProduits && tousLesProduits.length > 0) {
        // Extraire les cat√©gories depuis le cache
        const categories = [...new Set(tousLesProduits.map(p => p.categorie).filter(c => c))];
        afficherListeCategories(categories);
    } else {
        afficherListeCategories([]);
    }
}

// Afficher les produits dans la grille
// Remplacez TOUTE la fonction afficherProduits dans fiches.js par ceci :

function afficherProduits(produits) {
    const zonefiches = document.getElementById('zone-fiches');
    
    if (!produits || produits.length === 0) {
        zonefiches.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <p>Aucun produit trouv√© dans cette cat√©gorie</p>
                <a href="index.html" class="btn">Retour √† l'accueil</a>
            </div>
        `;
        return;
    }
    
    zonefiches.innerHTML = (Array.isArray(produits) ? produits : []).map(produit => {
        // ‚úÖ CORRECTION ICI - G√©rer le double chemin
       let imageUrl = produit.image || '';
if (imageUrl) {
    if (imageUrl.startsWith('/')) {
        imageUrl = imageUrl.substring(1);
    }
    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('assets/images/')) {
        imageUrl = `assets/images/${imageUrl}`;
    }
} else {
    imageUrl = 'assets/images/placeholder.png';
}
        let ficheUrl = '#';
if (produit.lien) {
    if (produit.lien.startsWith('http')) {
        ficheUrl = produit.lien;
    } else {
        // Construire l'URL compl√®te selon l'environnement
        const baseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000'
            : `${window.location.protocol}//${window.location.hostname}:3000`;
        ficheUrl = `${baseUrl}/${produit.lien.replace(/^\/+/, '')}`;
    }
}

        return `
            <div class="fiche-produit" data-id="${produit.id}" style="position: relative; ${produit.top_du_mois ? 'border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);' : ''}">
                ${produit.top_du_mois ? '<span class="vedette-badge" style="background: linear-gradient(45deg, #ff6b6b, #ffd700); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; position: absolute; top: 10px; right: 10px; z-index: 10; animation: pulse 2s infinite; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);">‚≠ê TOP</span>' : ''}

                <input type="checkbox" class="produit-checkbox" data-id="${produit.id}" data-nom="${produit.nom}">

                <img src="${imageUrl}" alt="${produit.nom}" 
                     onerror="this.onerror=null; this.src='assets/images/placeholder.png';">

<div class="overlay-text-produit">${produit.titre_affiche || produit.nom}</div>
                <p class="info">${produit.description || 'Description non disponible'}</p>

                <p class="info" style="color: #667eea; font-weight: bold;">
                    ${produit.prix || 'Prix non communiqu√©'}
                </p>

                ${produit.fonctionnalites_avancees && produit.fonctionnalites_avancees.length > 0 ? `
                    <ul style="text-align: left; padding-left: 20px; margin: 10px 0;">
                        ${produit.fonctionnalites_avancees.slice(0, 3).map(f => `<li style="font-size: 0.9em;">‚úì ${f}</li>`).join('')}
                    </ul>
                ` : ''}

                ${ficheUrl !== '#' ? `
    <a href="${ficheUrl}" class="btn btn-details">
        Voir la fiche
    </a>
` : `
    <button class="btn btn-details" onclick="afficherDetailsModal(${produit.id})">
        Voir la fiche
    </button>
                `}
            </div>
        `;
    }).join('');

    // Ajouter les √©couteurs pour les checkboxes de comparaison
    setupComparisonCheckboxes();
}

// Afficher la liste des cat√©gories
function afficherListeCategories(categories) {
    const zonefiches = document.getElementById('zone-fiches');
    
    zonefiches.innerHTML = `
        <div class="categories-grid">
            ${categories.map(cat => `
                <a href="?categorie=${encodeURIComponent(cat)}" class="categorie-card">
                    <div class="categorie-icon">${getCategorieIcon(cat)}</div>
                    <h3>${formatCategorieName(cat)}</h3>
                    <p>Voir les produits ‚Üí</p>
                </a>
            `).join('')}
        </div>
    `;
}

// Configurer les √©couteurs d'√©v√©nements
function setupEventListeners() {
    // Bouton retour am√©lior√©
    const btnRetour = document.getElementById('btn-retour');
    if (btnRetour) {
        btnRetour.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Si on est sur une cat√©gorie, retourner √† l'accueil
            if (categorieActuelle) {
                window.location.href = 'top-du-mois.html';
            } 
            // Sinon, utiliser l'historique du navigateur
            else if (window.history.length > 1) {
                window.history.back();
            } 
            // En dernier recours, aller √† l'accueil
            else {
                window.location.href = 'index.html';
            }
        });
    }
    
    // Bouton comparer
    const btnComparer = document.getElementById('btn-comparer');
    if (btnComparer) {
        btnComparer.addEventListener('click', comparerProduits);
    }
}

// Configurer les checkboxes de comparaison
function setupComparisonCheckboxes() {
    const checkboxes = document.querySelectorAll('.produit-checkbox');
    
    // ‚úÖ Nettoyer les anciens listeners
    checkboxes.forEach(checkbox => {
        checkbox.replaceWith(checkbox.cloneNode(true));
    });
    
    // ‚úÖ R√©attacher les nouveaux listeners
    const newCheckboxes = document.querySelectorAll('.produit-checkbox');
    newCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const produitId = e.target.dataset.id;
            const produitNom = e.target.dataset.nom;
            
            if (e.target.checked) {
                // V√©rifier qu'il n'est pas d√©j√† s√©lectionn√©
                if (!produitsSelectionnes.find(p => p.id === produitId)) {
                    produitsSelectionnes.push({ id: produitId, nom: produitNom });
                }
            } else {
                produitsSelectionnes = produitsSelectionnes.filter(p => p.id !== produitId);
            }
            
            // Afficher/masquer le bouton de comparaison
            const btnComparer = document.getElementById('btn-comparer');
            if (btnComparer) {
                btnComparer.style.display = produitsSelectionnes.length >= 2 ? 'block' : 'none';
            }
            
            console.log('üîÑ Produits s√©lectionn√©s:', produitsSelectionnes.length);
        });
    });
}

// Comparer les produits s√©lectionn√©s (utilise le cache)
async function comparerProduits() {
    if (produitsSelectionnes.length < 2) {
        alert('Veuillez s√©lectionner au moins 2 produits √† comparer');
        return;
    }
    
    try {
        const zoneComparaison = document.getElementById('zone-comparaison');
        const comparaisonContent = document.getElementById('comparaison-content');
        
        // D'abord chercher dans le cache
        let produitsDetails = [];
        const produitsNonTrouves = [];
        
        produitsSelectionnes.forEach(p => {
            if (tousLesProduits) {
                const produitCache = tousLesProduits.find(prod => prod.id == p.id);
                if (produitCache) {
                    produitsDetails.push(produitCache);
                } else {
                    produitsNonTrouves.push(p);
                }
            } else {
                produitsNonTrouves.push(p);
            }
        });
        
        // Si certains produits ne sont pas dans le cache, faire UNE SEULE requ√™te pour les r√©cup√©rer
        if (produitsNonTrouves.length > 0) {
            const detailsManquants = await Promise.all(
                produitsNonTrouves.map(async p => {
                    const response = await fetch(`${API_URL}/produits/${p.id}`);
                    const data = await response.json();
                    return data.success ? data.data : null;
                })
            );
            produitsDetails = [...produitsDetails, ...detailsManquants.filter(p => p !== null)];
        }
        
        if (produitsDetails.length === 0) {
            alert('Impossible de charger les produits pour la comparaison');
            return;
        }
        
        // Cr√©er les cartes de comparaison avec le M√äME STYLE que la grille principale
        comparaisonContent.innerHTML = `
    <div class="comparaison-grid">
        ${produitsDetails.map(p => {
            // Gestion du chemin d'image comme dans afficherProduits()
            let imageUrl = p.image || '';
            if (imageUrl) {
                if (imageUrl.startsWith('/')) {
                    imageUrl = imageUrl.substring(1);
                }
                if (!imageUrl.startsWith('http') && !imageUrl.startsWith('assets/images/')) {
                    imageUrl = `assets/images/${imageUrl}`;
                }
            } else {
                imageUrl = 'assets/images/placeholder.png';
            }
            
            return `
                <div class="fiche-comparaison" style="position: relative; ${p.top_du_mois ? 'border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);' : ''}">
                    ${p.top_du_mois ? '<span class="vedette-badge" style="background: linear-gradient(45deg, #ff6b6b, #ffd700); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; position: absolute; top: 10px; right: 10px; z-index: 10; animation: pulse 2s infinite; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);">‚≠ê TOP</span>' : ''}

                    <img src="${imageUrl}" 
                         alt="${p.titre_affiche || p.nom}" 
                         style="width: 240px !important; height: 240px !important; object-fit: contain !important; margin: 10px auto !important; display: block !important; border-radius: 8px !important; background: #fff !important; box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;"
                         onerror="this.onerror=null;this.src='assets/images/placeholder.png';">

                    <div class="overlay-text-produit">${p.titre_affiche || p.nom}</div>
                    
                    <p class="info"><strong>Prix:</strong> ${p.prix || 'Prix non communiqu√©'}</p>
                    <p class="info"><strong>Cat√©gorie:</strong> ${p.categorie || 'N/C'}</p>
                    <p class="info">${p.description || 'Description non disponible'}</p>
                    
                    ${p.fonctionnalites_avancees && p.fonctionnalites_avancees.length > 0 ? `
                        <ul style="text-align: left; padding-left: 20px; margin: 10px 0;">
                            ${p.fonctionnalites_avancees.slice(0, 3).map(f => `<li style="font-size: 1.1em;">‚úì ${f}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
            `;
        }).join('')}
    </div>
    <button id="btn-fermer-comparaison" class="btn btn-comparer">
        Fermer la comparaison
    </button>
`;
        
        // Afficher la zone de comparaison
        zoneComparaison.classList.remove('hidden');
        zoneComparaison.style.display = 'block';
        
        // Attacher l'event listener avec setTimeout pour √™tre s√ªr que le DOM est pr√™t
setTimeout(() => {
    const btnFermer = document.getElementById('btn-fermer-comparaison');
    if (btnFermer) {
        btnFermer.onclick = fermerComparaison;
    }
}, 100);
        
        // Scroller vers la comparaison
        zoneComparaison.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Erreur lors de la comparaison:', error);
        alert('Erreur lors de la comparaison des produits');
    }
}

// Fermer la comparaison
function fermerComparaison() {
    console.log('üîÑ Fermeture de la comparaison...');
    
    const zoneComparaison = document.getElementById('zone-comparaison');
    if (zoneComparaison) {
        zoneComparaison.style.display = 'none';
        zoneComparaison.classList.add('hidden');
    }
    
    // Vider le contenu
    const comparaisonContent = document.getElementById('comparaison-content');
    if (comparaisonContent) {
        comparaisonContent.innerHTML = '';
    }
    
    // D√©cocher toutes les checkboxes
    document.querySelectorAll('.produit-checkbox').forEach(cb => {
        cb.checked = false;
    });
    
    // Vider la s√©lection
    produitsSelectionnes = [];
    
    // Masquer le bouton de comparaison
    const btnComparer = document.getElementById('btn-comparer');
    if (btnComparer) {
        btnComparer.style.display = 'none';
    }
    
    // ‚úÖ NOUVEAU : R√©initialiser les event listeners des checkboxes
    setupComparisonCheckboxes();
    
    console.log('‚úÖ Comparaison ferm√©e et checkboxes r√©initialis√©es');
}

// Afficher les d√©tails dans une modal (utilise le cache pour √©viter une requ√™te)
async function afficherDetailsModal(produitId) {
    try {
        // D'abord chercher dans le cache
        let produit = null;
        if (tousLesProduits) {
            produit = tousLesProduits.find(p => p.id == produitId);
        }
        
        // Si pas trouv√© dans le cache, faire UNE requ√™te
        if (!produit) {
            const response = await fetch(`${API_URL}/produits/${produitId}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                produit = data.data;
            }
        }
        
        if (produit) {
            // Cr√©er une modal simple
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    <h2>${produit.nom}</h2>
                    
                    ${produit.image ? `
    <img src="/assets/images/${produit.image}" alt="${produit.titre_affiche || produit.nom}" style="max-width: 100%; margin: 20px 0;" 
         onerror="this.onerror=null;this.src='/assets/images/placeholder.png';">
` : ''}
                    
                    <p><strong>Cat√©gorie:</strong> ${produit.categorie}</p>
                    <p><strong>Prix:</strong> ${produit.prix || 'Non communiqu√©'}</p>
                    <p><strong>Description:</strong> ${produit.description || 'Non disponible'}</p>
                    
                    ${produit.fonctionnalites_avancees && produit.fonctionnalites_avancees.length > 0 ? `
                        <h3>Fonctionnalit√©s:</h3>
                        <ul>
                            ${produit.fonctionnalites_avancees.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    ${produit.donnees_fiche && produit.donnees_fiche.length > 0 ? `
                        <h3>Informations d√©taill√©es:</h3>
                        ${produit.donnees_fiche.map(info => `<p>${info}</p>`).join('')}
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
    } catch (error) {
        console.error('Erreur lors du chargement des d√©tails:', error);
        alert('Impossible de charger les d√©tails du produit');
    }
}

// Fonctions utilitaires
function formatCategorieName(categorie) {
    const noms = {
        'DRONE': 'Drones',
        'CONSOLE': 'Consoles de Jeux',
        'TABLETTE': 'Tablettes',
        'SMARTPHONE': 'Smartphones',
        'PC GAMING': 'PC Gaming',
        'SERVEUR': 'Serveurs',
        'CASQUE AUDIO': 'Casques Audio',
        'MONTRE CONNECTEE': 'montre_connectee'
    };
    return noms[categorie] || categorie;
}

function getCategorieIcon(categorie) {
    const icons = {
        'DRONE': 'üöÅ',
        'CONSOLE': 'üéÆ',
        'TABLETTE': 'üì±',
        'SMARTPHONE': 'üì±',
        'PC GAMING': 'üíª',
        'SERVEUR': 'üñ•Ô∏è',
        'CASQUE AUDIO': 'üéß',
        'MONTRE CONNECTEE': '‚åö'
    };
    return icons[categorie] || 'üì¶';
}

function afficherErreur(message) {
    const zonefiches = document.getElementById('zone-fiches');
    zonefiches.innerHTML = `
        <div class="message-erreur">
            <p>‚ùå ${message}</p>
            <a href="index.html" class="btn">Retour √† l'accueil</a>
        </div>
    `;
}
// Fonction principale de chargement des produits
async function chargerProduits(categorie = null) {
    try {
        let url = `${API_URL}/produits`;
        if (categorie) url += `?categorie=${encodeURIComponent(categorie)}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            afficherProduits(data.data, categorie);
        }
    } catch (error) {
        console.error('Erreur chargement:', error);
    }
}

function formatTitreCategorie(categorie) {
    if (!categorie) return 'Tous les produits';
    return categorie.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}