const API_URL=(()=>{const hostname=window.location.hostname;const protocol=window.location.protocol;const port="3000";if(hostname==="localhost"||hostname==="127.0.0.1"){return"http://localhost:3000/api"}return`${protocol}//${hostname}:${port}/api`})();let produitsSelectionnes=[];let categorieActuelle="";let tousLesProduits=[];let statsCache=null;const isMobile=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function getCategorieFromUrl(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get("categorie")||urlParams.get("cat")||""}document.addEventListener("DOMContentLoaded",async()=>{await chargerTousLesProduits();categorieActuelle=getCategorieFromUrl();if(categorieActuelle){afficherProduitsCategorie(categorieActuelle)}else{afficherToutesCategories()}setupEventListeners()});async function chargerTousLesProduits(){console.log("üîÑ Chargement des produits...");const cachedProduits=cacheManager.get("produits");if(cachedProduits){tousLesProduits=cachedProduits;console.log(`‚úÖ ${cachedProduits.length} produits charg√©s depuis le cache`);return}try{const startTime=performance.now();const response=await fetch(`${API_URL}/produits`);if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}const data=await response.json();const loadTime=Math.round(performance.now()-startTime);if(data.success&&Array.isArray(data.data)){tousLesProduits=data.data;cacheManager.set("produits",data.data);console.log(`üåê ${data.data.length} produits charg√©s depuis l'API (${loadTime}ms)`)}else{throw new Error("Format de donn√©es invalide")}}catch(error){console.error("‚ùå Erreur chargement produits:",error);const expiredCache=localStorage.getItem(cacheManager.generateKey("produits"));if(expiredCache){try{const fallbackData=JSON.parse(expiredCache);tousLesProduits=fallbackData.data;console.log("üîÑ Utilisation du cache expir√© comme fallback");return}catch(e){}}tousLesProduits=[];afficherErreurChargement(error.message)}}function afficherProduitsCategorie(categorie){const cacheKey=`categorie-${categorie.toLowerCase()}`;const cachedCategory=cacheManager.get("categories",categorie.toLowerCase());if(cachedCategory){console.log(`üìÇ Cat√©gorie "${categorie}" depuis cache`);if(typeof afficherProduitsAvecPagination==="function"){afficherProduitsAvecPagination(cachedCategory)}else{afficherProduits(cachedCategory)}const titreElement=document.getElementById("titre-categorie");if(titreElement){titreElement.textContent=formatTitreCategorie(categorie)}return}const produitsFilters=tousLesProduits.filter(p=>p.categorie&&p.categorie.toLowerCase()===categorie.toLowerCase());cacheManager.set("categories",produitsFilters,categorie.toLowerCase());if(typeof afficherProduitsAvecPagination==="function"){afficherProduitsAvecPagination(produitsFilters)}else{afficherProduits(produitsFilters)}const titreElement=document.getElementById("titre-categorie");if(titreElement){titreElement.textContent=formatTitreCategorie(categorie)}}function afficherToutesCategories(){const titreElement=document.getElementById("titre-categorie");titreElement.textContent="Toutes les cat√©gories";if(tousLesProduits&&tousLesProduits.length>0){const categories=[...new Set(tousLesProduits.map(p=>p.categorie).filter(c=>c))];afficherListeCategories(categories)}else{afficherListeCategories([])}}function afficherProduits(produits){const zonefiches=document.getElementById("zone-fiches");if(!produits||produits.length===0){zonefiches.innerHTML=`\n            <div style="text-align: center; padding: 40px;">\n                <p>Aucun produit trouv√© dans cette cat√©gorie</p>\n                <a href="index.html" class="btn">Retour √† l'accueil</a>\n            </div>\n        `;return}zonefiches.innerHTML=(Array.isArray(produits)?produits:[]).map(produit=>{let imageUrl="";if(produit.image_url){imageUrl=produit.image_url}else if(produit.image){const clean=produit.image.replace(/^assets\/images\//,"");imageUrl=`/assets/images/${clean}`}else{imageUrl="/assets/images/placeholder.png"}const placeholderUrl="data:image/svg+xml;base64,"+btoa(`\n            <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">\n                <rect width="100%" height="100%" fill="#f0f0f0"/>\n                <text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="#999">Chargement...</text>\n            </svg>\n        `);const productLink=produit.lien?produit.lien.startsWith("/")?produit.lien:`/${produit.lien}`:"#";return`\n            <div class="fiche-produit" data-id="${produit.id}" \n                 style="position: relative; ${produit.top_du_mois?"border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);":""}">\n                \n                ${produit.top_du_mois?`\n                    <span class="vedette-badge" style="\n                        background: linear-gradient(45deg, #ff6b6b, #ffd700);\n                        color: white; padding: 4px 8px; border-radius: 12px;\n                        font-size: 12px; font-weight: bold; position: absolute;\n                        top: 10px; right: 10px; z-index: 10;\n                        animation: pulse 2s infinite;\n                        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);\n                    ">üî• TOP</span>\n                `:""}\n\n                <input type="checkbox" class="produit-checkbox" data-id="${produit.id}" data-nom="${produit.nom}">\n\n                \x3c!-- IMAGE LAZY LOADING --\x3e\n                 <img src="${imageUrl}" \n                     alt="${produit.nom}" \n                     style="width: 100%; height: 200px; object-fit: cover; background: #f0f0f0;"\n                     onerror="this.onerror=null; this.src='/assets/images/placeholder.png';">\n\n                <div class="overlay-text-produit">${produit.titre_affiche||produit.nom}</div>\n                <p class="info">${produit.description||"Description non disponible"}</p>\n                <p class="info" style="color: #667eea; font-weight: bold;">${produit.prix||"Prix non communiqu√©"}</p>\n\n                ${produit.fonctionnalites_avancees&&produit.fonctionnalites_avancees.length>0?`\n                    <ul style="text-align: left; padding-left: 20px; margin: 10px 0;">\n                        ${produit.fonctionnalites_avancees.slice(0,3).map(f=>`<li style="font-size: 0.9em;">‚úì ${f}</li>`).join("")}\n                    </ul>\n                `:""}\n\n                <a href="${productLink}" class="btn btn-details">Voir la fiche</a>\n            </div>\n        `}).join("");setupComparisonCheckboxes()}function afficherListeCategories(categories){const zonefiches=document.getElementById("zone-fiches");zonefiches.innerHTML=`\n        <div class="categories-grid">\n            ${categories.map(cat=>`\n                <a href="?categorie=${encodeURIComponent(cat)}" class="categorie-card">\n                    <div class="categorie-icon">${getCategorieIcon(cat)}</div>\n                    <h3>${formatCategorieName(cat)}</h3>\n                    <p>Voir les produits ‚Üí</p>\n                </a>\n            `).join("")}\n        </div>\n    `}function setupEventListeners(){const btnTendances=document.getElementById("btn-tendances-categorie");if(btnTendances){btnTendances.addEventListener("click",e=>{e.preventDefault();if(categorieActuelle){const urlCategorie=categorieActuelle.toLowerCase().replace(/\s+/g,"-");window.location.href=`tendances-${urlCategorie}.html`}})}const btnRetour=document.getElementById("btn-retour");if(btnRetour){btnRetour.addEventListener("click",e=>{e.preventDefault();if(categorieActuelle){window.location.href="top-du-mois.html"}else if(window.history.length>1){window.history.back()}else{window.location.href="index.html"}})}const btnComparer=document.getElementById("btn-comparer");if(btnComparer){btnComparer.addEventListener("click",comparerProduits)}}function setupComparisonCheckboxes(){const checkboxes=document.querySelectorAll(".produit-checkbox");checkboxes.forEach(checkbox=>{checkbox.addEventListener("change",e=>{const produitId=e.target.dataset.id;const produitNom=e.target.dataset.nom;if(e.target.checked){produitsSelectionnes.push({id:produitId,nom:produitNom})}else{produitsSelectionnes=produitsSelectionnes.filter(p=>p.id!==produitId)}const btnComparer=document.getElementById("btn-comparer");if(btnComparer){btnComparer.style.display=produitsSelectionnes.length>=2?"block":"none"}})})}async function comparerProduits(){if(produitsSelectionnes.length<2){alert("Veuillez s√©lectionner au moins 2 produits √† comparer");return}try{const zoneComparaison=document.getElementById("zone-comparaison");const comparaisonContent=document.getElementById("comparaison-content");let produitsDetails=[];const produitsNonTrouves=[];produitsSelectionnes.forEach(p=>{if(tousLesProduits){const produitCache=tousLesProduits.find(prod=>prod.id==p.id);if(produitCache){produitsDetails.push(produitCache)}else{produitsNonTrouves.push(p)}}else{produitsNonTrouves.push(p)}});if(produitsNonTrouves.length>0){const detailsManquants=await Promise.all(produitsNonTrouves.map(async p=>{const response=await fetch(`${API_URL}/produits/${p.id}`);const data=await response.json();return data.success?data.data:null}));produitsDetails=[...produitsDetails,...detailsManquants.filter(p=>p!==null)]}if(produitsDetails.length===0){alert("Impossible de charger les produits pour la comparaison");return}comparaisonContent.innerHTML=`\n    <div class="comparaison-grid">\n        ${produitsDetails.map(p=>{let imageUrl=p.image||"";if(imageUrl){if(imageUrl.startsWith("/")){imageUrl=imageUrl.substring(1)}if(!imageUrl.startsWith("http")&&!imageUrl.startsWith("assets/images/")){imageUrl=`assets/images/${imageUrl}`}}else{imageUrl="assets/images/placeholder.png"}return`\n                <div class="fiche-comparaison">\n                    <img src="${imageUrl}" \n                         alt="${p.titre_affiche||p.nom}" \n                         onerror="this.onerror=null;this.src='assets/images/placeholder.png';">\n                    <h4>${p.titre_affiche||p.nom}</h4>\n                    <p class="info"><strong>Prix:</strong> ${p.prix||"N/C"}</p>\n                    <p class="info"><strong>Cat√©gorie:</strong> ${p.categorie||"N/C"}</p>\n                    <p class="info">${p.description||"Description non disponible"}</p>\n                    ${p.top_du_mois?`\n    <div class="vedette-badge" style="\n        position: absolute;\n        top: 10px;\n        left: 10px; /* Chang√© de right √† left */\n        background: #c9c5aeff;\n        color: #333;\n        padding: 5px 10px;\n        border-radius: 15px;\n        font-weight: bold;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n        z-index: 10;\n    ">\n        ‚≠ê Top du mois\n    </div>\n`:""}\n                    ${p.fonctionnalites_avancees&&p.fonctionnalites_avancees.length>0?`\n                        <ul>\n                            ${p.fonctionnalites_avancees.slice(0,3).map(f=>`<li>${f}</li>`).join("")}\n                        </ul>\n                    `:""}\n                </div>\n            `}).join("")}\n    </div>\n    <button id="btn-fermer-comparaison" class="btn btn-comparer" onclick="fermerComparaison()">\n        Fermer la comparaison\n    </button>\n`;zoneComparaison.classList.remove("hidden");zoneComparaison.style.display="block";zoneComparaison.scrollIntoView({behavior:"smooth"})}catch(error){console.error("Erreur lors de la comparaison:",error);alert("Erreur lors de la comparaison des produits")}}function fermerComparaison(){const zoneComparaison=document.getElementById("zone-comparaison");zoneComparaison.classList.add("hidden");zoneComparaison.style.display="none";document.querySelectorAll(".produit-checkbox").forEach(cb=>cb.checked=false);produitsSelectionnes=[];const btnComparer=document.getElementById("btn-comparer");if(btnComparer){btnComparer.style.display="none"}}async function afficherDetailsModal(produitId){try{let produit=null;if(tousLesProduits){produit=tousLesProduits.find(p=>p.id==produitId)}if(!produit){const response=await fetch(`${API_URL}/produits/${produitId}`);const data=await response.json();if(data.success&&data.data){produit=data.data}}if(produit){const modal=document.createElement("div");modal.className="modal-overlay";modal.innerHTML=`\n                <div class="modal-content">\n                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>\n                    <h2>${produit.nom}</h2>\n                    \n                    ${produit.image?`\n    <img src="/assets/images/${produit.image}" alt="${produit.titre_affiche||produit.nom}" style="max-width: 100%; margin: 20px 0;" \n         onerror="this.onerror=null;this.src='/assets/images/placeholder.png';">\n`:""}\n                    \n                    <p><strong>Cat√©gorie:</strong> ${produit.categorie}</p>\n                    <p><strong>Prix:</strong> ${produit.prix||"Non communiqu√©"}</p>\n                    <p><strong>Description:</strong> ${produit.description||"Non disponible"}</p>\n                    \n                    ${produit.fonctionnalites_avancees&&produit.fonctionnalites_avancees.length>0?`\n                        <h3>Fonctionnalit√©s:</h3>\n                        <ul>\n                            ${produit.fonctionnalites_avancees.map(f=>`<li>${f}</li>`).join("")}\n                        </ul>\n                    `:""}\n                    \n                    ${produit.donnees_fiche&&produit.donnees_fiche.length>0?`\n                        <h3>Informations d√©taill√©es:</h3>\n                        ${produit.donnees_fiche.map(info=>`<p>${info}</p>`).join("")}\n                    `:""}\n                </div>\n            `;document.body.appendChild(modal)}}catch(error){console.error("Erreur lors du chargement des d√©tails:",error);alert("Impossible de charger les d√©tails du produit")}}function formatCategorieName(categorie){const noms={DRONE:"Drones",CONSOLE:"Consoles de Jeux",TABLETTE:"Tablettes",SMARTPHONE:"Smartphones","PC GAMING":"PC Gaming",SERVEUR:"Serveurs","CASQUE AUDIO":"Casques Audio","MONTRE CONNECTEE":"montre-connectee"};return noms[categorie]||categorie}function getCategorieIcon(categorie){const icons={DRONE:"üöÅ",CONSOLE:"üéÆ",TABLETTE:"üì±",SMARTPHONE:"üì±","PC GAMING":"üíª",SERVEUR:"üñ•Ô∏è","CASQUE AUDIO":"üéß","MONTRE CONNECTEE":"‚åö"};return icons[categorie]||"üì¶"}function afficherErreur(message){const zonefiches=document.getElementById("zone-fiches");zonefiches.innerHTML=`\n        <div class="message-erreur">\n            <p>‚ùå ${message}</p>\n            <a href="index.html" class="btn">Retour √† l'accueil</a>\n        </div>\n    `}async function chargerProduits(categorie=null){try{let url=`${API_URL}/produits`;if(categorie)url+=`?categorie=${encodeURIComponent(categorie)}`;const response=await fetch(url);const data=await response.json();if(data.success){afficherProduits(data.data,categorie)}}catch(error){console.error("Erreur chargement:",error)}}document.addEventListener("DOMContentLoaded",()=>{const categorie=getCategorieFromUrl();chargerProduits(categorie)});function initLazyLoading(){if("IntersectionObserver"in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.classList.remove("lazy");img.classList.add("loaded");img.style.opacity="0";img.onload=()=>{img.style.transition="opacity 0.3s";img.style.opacity="1"};observer.unobserve(img)}})},{rootMargin:"100px 0px",threshold:.1});document.querySelectorAll("img.lazy").forEach(img=>{imageObserver.observe(img)})}else{document.querySelectorAll("img.lazy").forEach(img=>{img.src=img.dataset.src;img.classList.remove("lazy")})}}const ITEMS_PER_PAGE=12;let currentPage=1;let totalProduits=[];let filteredProduits=[];function afficherProduitsAvecPagination(produits,resetPage=true){if(resetPage)currentPage=1;filteredProduits=Array.isArray(produits)?produits:[];const start=(currentPage-1)*ITEMS_PER_PAGE;const end=start+ITEMS_PER_PAGE;const produitsPage=filteredProduits.slice(start,end);afficherProduits(produitsPage);afficherPagination(filteredProduits.length);if(!resetPage){document.getElementById("zone-fiches").scrollIntoView({behavior:"smooth",block:"start"})}}function afficherPagination(totalItems){const totalPages=Math.ceil(totalItems/ITEMS_PER_PAGE);if(totalPages<=1){document.getElementById("pagination-container").innerHTML="";return}let paginationHTML='<div class="pagination-container">';if(currentPage>1){paginationHTML+=`\n            <button class="btn-page" onclick="changerPage(${currentPage-1})">\n                ‚Üê Pr√©c√©dent\n            </button>\n        `}const startPage=Math.max(1,currentPage-2);const endPage=Math.min(totalPages,currentPage+2);if(startPage>1){paginationHTML+=`<button class="btn-page" onclick="changerPage(1)">1</button>`;if(startPage>2){paginationHTML+='<span class="dots">...</span>'}}for(let i=startPage;i<=endPage;i++){paginationHTML+=`\n            <button class="btn-page ${i===currentPage?"active":""}" \n                    onclick="changerPage(${i})">\n                ${i}\n            </button>\n        `}if(endPage<totalPages){if(endPage<totalPages-1){paginationHTML+='<span class="dots">...</span>'}paginationHTML+=`<button class="btn-page" onclick="changerPage(${totalPages})">${totalPages}</button>`}if(currentPage<totalPages){paginationHTML+=`\n            <button class="btn-page" onclick="changerPage(${currentPage+1})">\n                Suivant ‚Üí\n            </button>\n        `}paginationHTML+=`\n        <div class="page-info">\n            Page ${currentPage} sur ${totalPages} \n            (${totalItems} produit${totalItems>1?"s":""})\n        </div>\n    `;paginationHTML+="</div>";document.getElementById("pagination-container").innerHTML=paginationHTML}function changerPage(page){currentPage=page;afficherProduitsAvecPagination(filteredProduits,false)}function afficherProduitsCategorie(categorie){const cacheKey=`categorie-${categorie.toLowerCase()}`;const cachedCategory=cacheManager.get("categories",categorie.toLowerCase());if(cachedCategory){console.log(`üìÇ Cat√©gorie "${categorie}" depuis cache`);if(typeof afficherProduitsAvecPagination==="function"){afficherProduitsAvecPagination(cachedCategory)}else{afficherProduits(cachedCategory)}const titreElement=document.getElementById("titre-categorie");if(titreElement){titreElement.textContent=formatTitreCategorie(categorie)}return}const produitsFilters=tousLesProduits.filter(p=>p.categorie&&p.categorie.toLowerCase()===categorie.toLowerCase());cacheManager.set("categories",produitsFilters,categorie.toLowerCase());if(typeof afficherProduitsAvecPagination==="function"){afficherProduitsAvecPagination(produitsFilters)}else{afficherProduits(produitsFilters)}const titreElement=document.getElementById("titre-categorie");if(titreElement){titreElement.textContent=formatTitreCategorie(categorie)}}function rechercherProduits(){const terme=document.getElementById("search-input").value.toLowerCase().trim();if(!terme){if(categorieActuelle){afficherProduitsCategorie(categorieActuelle)}else{afficherProduitsAvecPagination(tousLesProduits)}return}const resultats=tousLesProduits.filter(produit=>produit.nom.toLowerCase().includes(terme)||produit.description.toLowerCase().includes(terme)||produit.categorie.toLowerCase().includes(terme));afficherProduitsAvecPagination(resultats);document.getElementById("titre-categorie").textContent=`R√©sultats pour "${terme}" (${resultats.length})`}const searchCache=new Map;const SEARCH_CACHE_SIZE=50;function rechercherProduits(){const terme=document.getElementById("search-input").value.toLowerCase().trim();const cacheKey=`search-${terme}`;if(!terme){if(categorieActuelle){afficherProduitsCategorie(categorieActuelle)}else{afficherProduitsAvecPagination(tousLesProduits)}return}if(searchCache.has(cacheKey)){const cachedResults=searchCache.get(cacheKey);console.log(`üîç Recherche "${terme}" depuis cache m√©moire (${cachedResults.length} r√©sultats)`);afficherResultatsRecherche(terme,cachedResults);return}const cachedSearch=cacheManager.get("search",terme);if(cachedSearch){console.log(`üîç Recherche "${terme}" depuis cache localStorage`);if(searchCache.size>=SEARCH_CACHE_SIZE){const firstKey=searchCache.keys().next().value;searchCache.delete(firstKey)}searchCache.set(cacheKey,cachedSearch);afficherResultatsRecherche(terme,cachedSearch);return}const startTime=performance.now();const resultats=tousLesProduits.filter(produit=>produit.nom.toLowerCase().includes(terme)||produit.description&&produit.description.toLowerCase().includes(terme)||produit.categorie&&produit.categorie.toLowerCase().includes(terme)||produit.titre_affiche&&produit.titre_affiche.toLowerCase().includes(terme));const searchTime=Math.round(performance.now()-startTime);console.log(`üîç Recherche "${terme}" effectu√©e (${searchTime}ms, ${resultats.length} r√©sultats)`);cacheManager.set("search",resultats,terme);if(searchCache.size>=SEARCH_CACHE_SIZE){const firstKey=searchCache.keys().next().value;searchCache.delete(firstKey)}searchCache.set(cacheKey,resultats);afficherResultatsRecherche(terme,resultats)}function afficherResultatsRecherche(terme,resultats){afficherProduitsAvecPagination(resultats);document.getElementById("titre-categorie").textContent=`R√©sultats pour "${terme}" (${resultats.length})`}function afficherStatsCache(){const stats=cacheManager.getStats();console.group("üìä Statistiques du Cache");console.log(`üíæ Taille totale: ${stats.totalSize} KB`);console.log(`üì¶ Entr√©es: ${stats.entriesCount}`);console.log(`üìä Quota utilis√©: ${stats.quotaUsed}%`);console.log("üè∑Ô∏è Par type:",stats.typeStats);console.groupEnd();if(document.getElementById("cache-stats")){document.getElementById("cache-stats").innerHTML=`\n            <div class="cache-stats">\n                <h4>üìä Cache Stats</h4>\n                <p>üíæ ${stats.totalSize} KB utilis√©s</p>\n                <p>üì¶ ${stats.entriesCount} entr√©es</p>\n                <p>üìä ${stats.quotaUsed}% du quota</p>\n                <button onclick="cacheManager.clearAll(); location.reload();">\n                    üóëÔ∏è Vider le cache\n                </button>\n            </div>\n        `}}function forceRefresh(){console.log("üîÑ Force refresh - invalidation du cache...");cacheManager.invalidate("produits");cacheManager.invalidate("categories");cacheManager.invalidate("search");searchCache.clear();location.reload()}async function prechargerDonnees(){const categoriesPopulaires=["smartphones","pc-gaming","casques-audio"];for(const cat of categoriesPopulaires){if(!cacheManager.get("categories",cat)){const produits=tousLesProduits.filter(p=>p.categorie.toLowerCase()===cat);if(produits.length>0){cacheManager.set("categories",produits,cat);console.log(`üéØ Pr√©cache: ${cat} (${produits.length} produits)`)}}}}document.addEventListener("DOMContentLoaded",async()=>{console.log("üöÄ Initialisation avec cache intelligent...");await chargerTousLesProduits();categorieActuelle=getCategorieFromUrl();if(categorieActuelle){afficherProduitsCategorie(categorieActuelle)}else{afficherToutesCategories()}setupEventListeners();setTimeout(prechargerDonnees,1e3);setTimeout(()=>{if(window.location.hostname==="localhost"){afficherStatsCache()}},2e3)});function formatTitreCategorie(categorie){if(!categorie)return"Tous les produits";return categorie.split("-").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(" ")}