const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:3000/api'
  : `http://${window.location.hostname}:3000/api`;

async function chargerDonneesProduit() {
    const nomProduit = window.location.pathname
        .split("/")
        .pop()
        .replace(".html", "");

    try {
        const response = await fetch(`${API_URL}/produits`);
        const data = await response.json();

        if (data.success && data.data) {
            const produit = data.data.find(
                (p) => p.nom && p.nom.toLowerCase() === nomProduit.toLowerCase()
            );

            if (produit) {
                afficherDonneesProduit(produit);
            } else {
                console.warn(`‚ö†Ô∏è Produit "${nomProduit}" non trouv√© dans la base`);
                afficherErreurProduit(`Produit "${nomProduit}" non trouv√©`);
            }
        } else {
            console.error("‚ùå Erreur API:", data.message);
            afficherErreurProduit("Erreur de chargement des donn√©es");
        }
    } catch (error) {
        console.error("‚ùå Erreur connexion:", error);
        afficherErreurProduit("Erreur de connexion √† la base de donn√©es");
    }
}

function afficherDonneesProduit(produit) {
    // Badge Top du mois
    if (produit.top_du_mois) {
        const badge = document.getElementById("badge-top-mois");
        if (badge) {
            badge.innerHTML = `
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); 
                            padding: 10px; margin-bottom: 20px; text-align: center; 
                            border-radius: 8px; font-weight: bold;">
                    ‚≠ê Ce produit est en vedette ce mois-ci !
                </div>
            `;
        }
    }

    // Description
    const description = document.querySelector(".description");
    if (description && produit.description) {
        description.textContent = produit.description;
    }

    // Image - NETTOY√â ET SIMPLIFI√â
    afficherImage(produit);

    // Contenu d√©taill√©
    afficherContenuDetaille(produit);

    // Prix
    afficherPrix(produit);
}

function afficherImage(produit) {
    const img = document.querySelector(".gallery img, .img-centree");
    if (img && produit.image) {
        // Nettoyer le nom de l'image (supprimer tout chemin existant)
        let imageName = produit.image;
        if (imageName.includes('/')) {
            imageName = imageName.split('/').pop();
        }

        // Construire le chemin correct
        const finalUrl = `/assets/images/${imageName}`;
        
        img.src = finalUrl;
        img.alt = produit.nom || 'Image produit';
        img.onerror = () => (img.src = "/assets/images/placeholder.png");
        
        console.log("üñºÔ∏è Image affich√©e :", finalUrl);
    }
}

function afficherContenuDetaille(produit) {
    const contentDiv = document.getElementById("product-content");
    if (!contentDiv || !produit.donnees_fiche || produit.donnees_fiche.length === 0) {
        return;
    }

    let html = "";
    produit.donnees_fiche.forEach((contenu) => {
        if (contenu && contenu.trim().length > 0) {
            let titre, texte;
            const contenuNettoye = contenu.replace(/\\n/g, "\n");

            if (contenuNettoye.includes("\n")) {
                const parties = contenuNettoye.split("\n");
                titre = parties[0];
                texte = parties.slice(1).join("\n").trim();
            } else {
                titre = "üìù Description";
                texte = contenu.trim();
            }

            if (texte.length > 0) {
                html += `
                    <div style="margin: 20px 0; text-align: center;">
                        <h3 style="color: white; margin-bottom: 10px; font-weight: bold;">${titre}</h3>
                        <p>${texte.replace(/\n/g, "<br>")}</p>
                    </div>
                `;
            }
        }
    });

    contentDiv.innerHTML = html || "<p>Informations d√©taill√©es √† venir...</p>";
}

function afficherPrix(produit) {
    if (produit.prix && !produit.donnees_fiche?.some((d) => d.includes("‚Ç¨"))) {
        const contentDiv = document.getElementById("product-content");
        if (contentDiv) {
            contentDiv.innerHTML = 
                `<p><strong>üí∞ Prix :</strong> ${produit.prix}</p>` + 
                contentDiv.innerHTML;
        }
    }
}

function afficherErreurProduit(message) {
    const contentDiv = document.getElementById("product-content");
    if (contentDiv) {
        contentDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
                <p>‚ùå ${message}</p>
                <p>V√©rifiez que :</p>
                <ul style="text-align: left; margin: 10px 0;">
                    <li>Le serveur Node.js est lanc√© (node server.js)</li>
                    <li>PostgreSQL est d√©marr√©</li>
                    <li>Le produit existe dans la base de donn√©es</li>
                </ul>
            </div>
        `;
    }
}

// Initialisation
document.addEventListener("DOMContentLoaded", chargerDonneesProduit);