// 1. TEMPLATE DE FICHE DYNAMIQUE
// Cr√©ez un fichier template : fiches/template-fiche.html

const ficheTemplate = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{{nom}} - Fiche Produit</title>
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope&family=Montserrat&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="entete">
        <img src="../../assets/images/gaming.png" alt="Gaming">
        <a href="javascript:history.back()">‚Üê Retour</a>
    </div>

    <h1>{{nom}}</h1>

    <div id="badge-top-mois">
        {{#if top_du_mois}}
        <div style="background:#ffde59;padding:8px;margin-bottom:10px;text-align:center;border-radius:8px;">
            ‚≠ê Ce produit est en vedette ce mois-ci !
        </div>
        {{/if}}
    </div>

    <p class="description">{{description}}</p>

    <div class="gallery">
        <img src="../../{{image_clean}}" alt="{{nom}}" class="img-centree" onerror="this.src='../../assets/images/placeholder.png'">
    </div>

    <!-- Donn√©es dynamiques depuis PostgreSQL -->
    <div id="product-content">
        {{#each donnees_fiche}}
        <p>{{this}}</p>
        {{/each}}
    </div>

    <script>
        // Auto-refresh des donn√©es depuis PostgreSQL
        async function loadProductData() {
            try {
                const productName = '{{nom}}';
                const response = await fetch('../../api/produits/by-name/' + encodeURIComponent(productName));
                const data = await response.json();
                
                if (data.success && data.data) {
                    updatePageWithData(data.data);
                }
            } catch (error) {
                console.log('Mode statique - donn√©es int√©gr√©es utilis√©es');
            }
        }

        function updatePageWithData(product) {
            // Mettre √† jour dynamiquement si les donn√©es ont chang√©
            if (product.description) {
                document.querySelector('.description').textContent = product.description;
            }
            
            // Mettre √† jour les donn√©es de fiche
            if (product.donnees_fiche) {
                const content = document.getElementById('product-content');
                content.innerHTML = product.donnees_fiche.map(info => 
                    '<p>' + info.replace(/\\n/g, '<br>') + '</p>'
                ).join('');
            }
        }

        // Charger au d√©marrage
        document.addEventListener('DOMContentLoaded', loadProductData);
    </script>
</body>
</html>`;

// 2. G√âN√âRATEUR DE FICHES DANS L'ADMIN
// Ajoutez cette fonction dans admin.html

async function generateFicheHTML(productId) {
    try {
        const response = await fetch(\`\${API_URL}/produits/\${productId}\`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error('Produit non trouv√©');
        }
        
        const product = data.data;
        
        // Nettoyer le chemin d'image
        let imageClean = product.image_data || product.image || '';
        if (imageClean.startsWith('/')) {
            imageClean = imageClean.substring(1);
        }
        
        // Remplacer les variables dans le template
        let html = ficheTemplate
            .replace(/{{nom}}/g, product.nom)
            .replace(/{{description}}/g, product.description || '')
            .replace(/{{image_clean}}/g, imageClean)
            .replace(/{{prix}}/g, product.prix || '');
        
        // G√©rer le badge top du mois
        if (product.top_du_mois) {
            html = html.replace(/{{#if top_du_mois}}([\\s\\S]*?){{\/if}}/g, '$1');
        } else {
            html = html.replace(/{{#if top_du_mois}}[\\s\\S]*?{{\/if}}/g, '');
        }
        
        // G√©rer les donn√©es de fiche
        if (product.donnees_fiche && product.donnees_fiche.length > 0) {
            const ficheContent = product.donnees_fiche.map(info => 
                \`<p>\${info.replace(/\\\\n/g, '<br>')}</p>\`
            ).join('\\n        ');
            html = html.replace(/{{#each donnees_fiche}}[\\s\\S]*?{{\/each}}/g, ficheContent);
        } else {
            html = html.replace(/{{#each donnees_fiche}}[\\s\\S]*?{{\/each}}/g, '<p>Informations d√©taill√©es √† venir...</p>');
        }
        
        return html;
        
    } catch (error) {
        console.error('Erreur g√©n√©ration fiche:', error);
        throw error;
    }
}

// 3. BOUTON DE G√âN√âRATION DANS L'INTERFACE
// Ajoutez ce bouton dans le formulaire d'√©dition de admin.html

function addGenerateButton() {
    return \`
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <h3 style="color: #667eea;">üîÑ G√©n√©ration automatique</h3>
        <p style="color: #666; margin-bottom: 15px;">
            G√©n√©rez automatiquement la fiche HTML avec les donn√©es actuelles
        </p>
        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn btn-info" onclick="previewFiche()">
                üëÅÔ∏è Aper√ßu de la fiche
            </button>
            <button type="button" class="btn btn-success" onclick="downloadFiche()">
                üíæ T√©l√©charger la fiche HTML
            </button>
        </div>
    </div>
    \`;
}

// 4. FONCTIONS POUR G√âN√âRER ET T√âL√âCHARGER
async function previewFiche() {
    if (!currentEditingId) {
        alert('Veuillez d\\'abord s√©lectionner un produit');
        return;
    }
    
    try {
        const html = await generateFicheHTML(currentEditingId);
        
        // Ouvrir dans une nouvelle fen√™tre pour aper√ßu
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();
        
    } catch (error) {
        alert('Erreur lors de la g√©n√©ration: ' + error.message);
    }
}

async function downloadFiche() {
    if (!currentEditingId) {
        alert('Veuillez d\\'abord s√©lectionner un produit');
        return;
    }
    
    try {
        const html = await generateFicheHTML(currentEditingId);
        const product = allProducts.find(p => p.id == currentEditingId);
        
        // Cr√©er un nom de fichier propre
        const fileName = product.nom.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '') + '.html';
        
        // T√©l√©charger le fichier
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
        
        showMessage(\`‚úÖ Fiche "\${fileName}" t√©l√©charg√©e!\`, 'success');
        
    } catch (error) {
        alert('Erreur lors du t√©l√©chargement: ' + error.message);
    }
}