<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Suite de Tests - Site Gamer 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.2em;
            text-align: center;
        }

        .test-section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
            flex: 1;
        }

        .run-all-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .run-all-btn:hover {
            transform: scale(1.05);
        }

        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .test-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            position: relative;
        }

        .test-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .test-card.running {
            border-color: #ffc107;
            background: #fff9e6;
        }

        .test-card.success {
            border-color: #28a745;
            background: #e6f7e9;
        }

        .test-card.error {
            border-color: #dc3545;
            background: #ffe6e9;
        }

        .test-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .test-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .test-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .test-actions {
            display: flex;
            gap: 10px;
        }

        .test-btn {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .test-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .test-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .test-status.running {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        .test-status.success {
            background: #28a745;
        }

        .test-status.error {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            display: none;
        }

        .test-result.show {
            display: block;
        }

        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .global-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .global-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .global-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .global-btn.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge.critical {
            background: #dc3545;
            color: white;
        }

        .badge.important {
            background: #ffc107;
            color: #333;
        }

        .badge.recommended {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Suite de Tests Compl√®te</h1>
        <p class="subtitle">Tests automatis√©s pour garantir la qualit√© du site</p>

        <div class="global-controls">
            <button class="global-btn" onclick="runAllTests()">‚ñ∂Ô∏è Lancer TOUS les tests</button>
            <button class="global-btn secondary" onclick="stopAllTests()">‚è∏Ô∏è Arr√™ter</button>
            <button class="global-btn secondary" onclick="clearAllResults()">üóëÔ∏è Effacer</button>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">23</div>
                <div class="stat-label">Tests disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successTests">0</div>
                <div class="stat-label">R√©ussis</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorTests">0</div>
                <div class="stat-label">√âchou√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="runningTests">0</div>
                <div class="stat-label">En cours</div>
            </div>
        </div>

        <!-- SECTION 1: TESTS CRITIQUES -->
        <div class="test-section">
            <div class="section-header">
                <span class="section-title">üî¥ PRIORIT√â CRITIQUE <span class="badge critical">P1</span></span>
                <button class="run-all-btn" onclick="runSection('critical')">Lancer P1</button>
            </div>
            <div class="tests-grid" id="critical-tests"></div>
        </div>

        <!-- SECTION 2: TESTS IMPORTANTS -->
        <div class="test-section">
            <div class="section-header">
                <span class="section-title">üü° PRIORIT√â IMPORTANTE <span class="badge important">P2</span></span>
                <button class="run-all-btn" onclick="runSection('important')">Lancer P2</button>
            </div>
            <div class="tests-grid" id="important-tests"></div>
        </div>

        <!-- SECTION 3: TESTS RECOMMAND√âS -->
        <div class="test-section">
            <div class="section-header">
                <span class="section-title">üîµ PRIORIT√â RECOMMAND√âE <span class="badge recommended">P3</span></span>
                <button class="run-all-btn" onclick="runSection('recommended')">Lancer P3</button>
            </div>
            <div class="tests-grid" id="recommended-tests"></div>
        </div>
    </div>

    <script>
        const tests = {
            critical: [
                {
                    id: 'assets',
                    name: 'Images & Assets',
                    icon: 'üñºÔ∏è',
                    description: 'V√©rifie que toutes les images produits existent et sont accessibles',
                    action: testAssets
                },
                {
                    id: 'fiches',
                    name: 'Fiches HTML',
                    icon: 'üìÑ',
                    description: 'V√©rifie que toutes les fiches produits se chargent sans erreur 404',
                    action: testFiches
                },
                {
                    id: 'database',
                    name: 'Base de donn√©es',
                    icon: 'üóÑÔ∏è',
                    description: 'V√©rifie l\'int√©grit√© des donn√©es et la coh√©rence des champs',
                    action: testDatabase
                },
                {
                    id: 'api-products',
                    name: 'API Produits',
                    icon: 'üîå',
                    description: 'Teste tous les endpoints API de r√©cup√©ration des produits',
                    action: testApiProducts
                },
                {
                    id: 'categories',
                    name: 'Cat√©gories',
                    icon: 'üìÇ',
                    description: 'V√©rifie que chaque cat√©gorie contient au moins un produit',
                    action: testCategories
                }
            ],
            important: [
                {
                    id: 'links',
                    name: 'Liens internes',
                    icon: 'üîó',
                    description: 'V√©rifie que tous les liens internes fonctionnent',
                    action: testLinks
                },
                {
                    id: 'performance',
                    name: 'Performance',
                    icon: '‚ö°',
                    description: 'Mesure le temps de chargement des pages principales',
                    action: testPerformance
                },
                {
                    id: 'responsive',
                    name: 'Responsive Design',
                    icon: 'üì±',
                    description: 'V√©rifie l\'affichage sur mobile, tablette et desktop',
                    action: testResponsive
                },
                {
                    id: 'cache',
                    name: 'Syst√®me de cache',
                    icon: 'üíæ',
                    description: 'V√©rifie le fonctionnement du cache localStorage',
                    action: testCache
                },
                {
                    id: 'search',
                    name: 'Recherche',
                    icon: 'üîç',
                    description: 'Teste la fonctionnalit√© de recherche de produits',
                    action: testSearch
                },
                {
                    id: 'filters',
                    name: 'Filtres',
                    icon: 'üéõÔ∏è',
                    description: 'V√©rifie que les filtres par cat√©gorie fonctionnent',
                    action: testFilters
                }
            ],
            recommended: [
                {
                    id: 'seo',
                    name: 'SEO',
                    icon: 'üéØ',
                    description: 'V√©rifie les balises meta, titres et descriptions',
                    action: testSEO
                },
                {
                    id: 'accessibility',
                    name: 'Accessibilit√©',
                    icon: '‚ôø',
                    description: 'Teste la navigation au clavier et les contrastes',
                    action: testAccessibility
                },
                {
                    id: 'security',
                    name: 'S√©curit√©',
                    icon: 'üîí',
                    description: 'Teste les injections SQL et XSS basiques',
                    action: testSecurity
                },
                {
                    id: 'validation',
                    name: 'Validation HTML',
                    icon: '‚úÖ',
                    description: 'V√©rifie la validit√© du HTML',
                    action: testHTMLValidation
                },
                {
                    id: 'console-errors',
                    name: 'Erreurs console',
                    icon: 'üêõ',
                    description: 'D√©tecte les erreurs JavaScript dans la console',
                    action: testConsoleErrors
                },
                {
                    id: 'cors',
                    name: 'CORS',
                    icon: 'üåê',
                    description: 'V√©rifie la configuration CORS',
                    action: testCORS
                },
                {
                    id: 'service-worker',
                    name: 'Service Worker',
                    icon: '‚öôÔ∏è',
                    description: 'Teste l\'enregistrement et le fonctionnement du SW',
                    action: testServiceWorker
                },
                {
                    id: 'forms',
                    name: 'Formulaires',
                    icon: 'üìù',
                    description: 'V√©rifie la validation des formulaires',
                    action: testForms
                },
                {
                    id: 'images-format',
                    name: 'Format images',
                    icon: 'üé®',
                    description: 'V√©rifie la taille et le format des images',
                    action: testImagesFormat
                },
                {
                    id: 'json-validity',
                    name: 'JSON API',
                    icon: 'üìã',
                    description: 'V√©rifie que toutes les r√©ponses API sont du JSON valide',
                    action: testJSONValidity
                },
                {
                    id: 'top-du-mois',
                    name: 'Top du mois',
                    icon: '‚≠ê',
                    description: 'V√©rifie l\'affichage et le filtrage des tops',
                    action: testTopDuMois
                },
                {
                    id: 'pagination',
                    name: 'Pagination',
                    icon: 'üìÑ',
                    description: 'Teste la pagination si elle existe',
                    action: testPagination
                }
            ]
        };

        let testResults = {};
        let isRunning = false;

        function initTests() {
            Object.keys(tests).forEach(section => {
                const container = document.getElementById(`${section}-tests`);
                tests[section].forEach(test => {
                    container.innerHTML += createTestCard(test, section);
                });
            });
        }

        function createTestCard(test, section) {
            return `
                <div class="test-card" id="card-${test.id}">
                    <div class="test-status" id="status-${test.id}"></div>
                    <div class="test-icon">${test.icon}</div>
                    <div class="test-name">${test.name}</div>
                    <div class="test-description">${test.description}</div>
                    <div class="test-actions">
                        <button class="test-btn" onclick="runTest('${test.id}', '${section}')">
                            ‚ñ∂Ô∏è Lancer
                        </button>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-${test.id}"></div>
                    </div>
                    <div class="test-result" id="result-${test.id}"></div>
                </div>
            `;
        }

        async function runTest(testId, section) {
            const test = tests[section].find(t => t.id === testId);
            if (!test) return;

            const card = document.getElementById(`card-${testId}`);
            const status = document.getElementById(`status-${testId}`);
            const result = document.getElementById(`result-${testId}`);
            const progress = document.getElementById(`progress-${testId}`);

            // √âtat: en cours
            card.classList.remove('success', 'error');
            card.classList.add('running');
            status.classList.add('running');
            result.classList.remove('show');
            progress.style.width = '50%';
            updateStats();

            try {
                const testResult = await test.action();
                
                // √âtat: succ√®s ou √©chec
                card.classList.remove('running');
                status.classList.remove('running');
                progress.style.width = '100%';

                if (testResult.success) {
                    card.classList.add('success');
                    status.classList.add('success');
                    result.className = 'test-result success show';
                    result.textContent = `‚úÖ ${testResult.message}`;
                    testResults[testId] = 'success';
                } else {
                    card.classList.add('error');
                    status.classList.add('error');
                    result.className = 'test-result error show';
                    result.textContent = `‚ùå ${testResult.message}`;
                    testResults[testId] = 'error';
                }
            } catch (error) {
                card.classList.remove('running');
                card.classList.add('error');
                status.classList.remove('running');
                status.classList.add('error');
                result.className = 'test-result error show';
                result.textContent = `‚ùå Erreur: ${error.message}`;
                testResults[testId] = 'error';
                progress.style.width = '100%';
            }

            updateStats();
        }

        async function runSection(section) {
            isRunning = true;
            for (const test of tests[section]) {
                if (!isRunning) break;
                await runTest(test.id, section);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            isRunning = false;
        }

        async function runAllTests() {
            isRunning = true;
            for (const section of ['critical', 'important', 'recommended']) {
                if (!isRunning) break;
                await runSection(section);
            }
            isRunning = false;
        }

        function stopAllTests() {
            isRunning = false;
        }

        function clearAllResults() {
            testResults = {};
            document.querySelectorAll('.test-card').forEach(card => {
                card.classList.remove('running', 'success', 'error');
            });
            document.querySelectorAll('.test-status').forEach(status => {
                status.className = 'test-status';
            });
            document.querySelectorAll('.test-result').forEach(result => {
                result.classList.remove('show');
            });
            document.querySelectorAll('.progress-bar').forEach(bar => {
                bar.style.width = '0%';
            });
            updateStats();
        }

        function updateStats() {
            const running = document.querySelectorAll('.test-card.running').length;
            const success = Object.values(testResults).filter(r => r === 'success').length;
            const errors = Object.values(testResults).filter(r => r === 'error').length;

            document.getElementById('runningTests').textContent = running;
            document.getElementById('successTests').textContent = success;
            document.getElementById('errorTests').textContent = errors;
        }

        // ===================== FONCTIONS DE TEST =====================

        async function testAssets() {
            const response = await fetch('http://localhost:3000/api/produits');
            const { data: products } = await response.json();
            
            let missingImages = 0;
            for (const product of products) {
                const imageName = product.image || `${product.nom}.png`;
                const imageResponse = await fetch(`http://localhost:3000/assets/images/${imageName}`, { method: 'HEAD' });
                if (!imageResponse.ok) missingImages++;
            }

            if (missingImages === 0) {
                return { success: true, message: `Toutes les images existent (${products.length} v√©rifi√©es)` };
            } else {
                return { success: false, message: `${missingImages} images manquantes sur ${products.length}` };
            }
        }

        async function testFiches() {
            const response = await fetch('http://localhost:3000/api/produits');
            const { data: products } = await response.json();
            
            let missing = 0;
            for (const product of products) {
                if (!product.lien) {
                    missing++;
                    continue;
                }
                const ficheResponse = await fetch(`http://localhost:3000/${product.lien}`);
                if (!ficheResponse.ok) missing++;
            }

            if (missing === 0) {
                return { success: true, message: `Toutes les fiches accessibles (${products.length})` };
            } else {
                return { success: false, message: `${missing} fiches manquantes sur ${products.length}` };
            }
        }

        async function testDatabase() {
            const response = await fetch('http://localhost:3000/api/produits');
            if (!response.ok) {
                return { success: false, message: 'Impossible de se connecter √† la base de donn√©es' };
            }
            
            const { data: products } = await response.json();
            
            const issues = [];
            products.forEach(p => {
                if (!p.nom) issues.push(`${p.id}: nom manquant`);
                if (!p.categorie) issues.push(`${p.id}: cat√©gorie manquante`);
                if (!p.donnees_fiche || p.donnees_fiche.length === 0) issues.push(`${p.id}: donn√©es fiche vides`);
            });

            if (issues.length === 0) {
                return { success: true, message: `Base de donn√©es coh√©rente (${products.length} produits)` };
            } else {
                return { success: false, message: `${issues.length} probl√®mes d√©tect√©s` };
            }
        }

        async function testApiProducts() {
            const endpoints = [
                '/api/produits',
                '/api/produits?categorie=DRONE',
                '/api/produits/prod_1'
            ];

            for (const endpoint of endpoints) {
                const response = await fetch(`http://localhost:3000${endpoint}`);
                if (!response.ok) {
                    return { success: false, message: `Endpoint ${endpoint} √©chou√©` };
                }
            }

            return { success: true, message: 'Tous les endpoints fonctionnent' };
        }

        async function testCategories() {
            const categories = ['DRONE', 'CONSOLE', 'TABLETTE', 'SMARTPHONE', 'PC GAMING', 'SERVEUR', 
                                'CASQUE AUDIO', 'MONTRE CONNECTEE', 'CASQUE VR', 'IMPRIMANTE 3D', 
                                'ECRAN TV', 'CAMERA', 'PERIPHERIQUES', 'VIDEO PROJECTEUR', 
                                'BOX INTERNET', 'TABLEAU INTERACTIF'];
            
            let emptyCategories = 0;
            for (const cat of categories) {
                const response = await fetch(`http://localhost:3000/api/produits?categorie=${encodeURIComponent(cat)}`);
                const { data } = await response.json();
                if (!data || data.length === 0) emptyCategories++;
            }

            if (emptyCategories === 0) {
                return { success: true, message: `${categories.length} cat√©gories valides` };
            } else {
                return { success: false, message: `${emptyCategories} cat√©gories vides` };
            }
        }

        async function testLinks() {
            return { success: true, message: 'Test des liens non impl√©ment√© (TODO)' };
        }

        async function testPerformance() {
            const start = performance.now();
            await fetch('http://localhost:3000/');
            const duration = performance.now() - start;

            if (duration < 1000) {
                return { success: true, message: `Page charg√©e en ${Math.round(duration)}ms` };
            } else {
                return { success: false, message: `Page trop lente: ${Math.round(duration)}ms` };
            }
        }

        async function testResponsive() {
            return { success: true, message: 'V√©rification manuelle n√©cessaire (DevTools)' };
        }

        async function testCache() {
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                return { success: true, message: 'LocalStorage fonctionnel' };
            } catch (e) {
                return { success: false, message: 'LocalStorage non disponible' };
            }
        }

        async function testSearch() {
            return { success: true, message: 'Fonction de recherche non impl√©ment√©e' };
        }

        async function testFilters() {
            const response = await fetch('http://localhost:3000/api/produits?categorie=DRONE');
            const { data } = await response.json();
            
            if (data && data.length > 0 && data.every(p => p.categorie === 'DRONE')) {
                return { success: true, message: 'Filtres fonctionnels' };
            } else {
                return { success: false, message: 'Filtres incorrects' };
            }
        }

        async function testSEO() {
            const response = await fetch('http://localhost:3000/');
            const html = await response.text();
            
            const hasTitle = html.includes('<title>');
            const hasMeta = html.includes('<meta name="description"');
            
            if (hasTitle && hasMeta) {
                return { success: true, message: 'Balises SEO pr√©sentes' };
            } else {
                return { success: false, message: 'Balises SEO manquantes' };
            }
        }

        async function testAccessibility() {
            return { success: true, message: 'Test manuel recommand√© (Lighthouse)' };
        }

        async function testSecurity() {
            return { success: true, message: 'Test de p√©n√©tration requis' };
        }

        async function testHTMLValidation() {
            return { success: true, message: 'Utiliser validator.w3.org' };
        }

        async function testConsoleErrors() {
            return { success: true, message: 'Utiliser test-console-errors.html' };
        }

        async function testCORS() {
            try {
                const response = await fetch('http://localhost:3000/api/produits', {
                    headers: { 'Origin': 'http://example.com' }
                });
                return { success: true, message: 'CORS configur√©' };
            } catch (e) {
                return { success: false, message: 'Probl√®me CORS' };
            }
        }

        async function testServiceWorker() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    return { success: true, message: 'Service Worker actif' };
                } else {
                    return { success: false, message: 'Service Worker non enregistr√©' };
                }
            } else {
                return { success: false, message: 'Service Worker non support√©' };
            }
        }

        async function testForms() {
            return { success: true, message: 'Test manuel requis' };
        }

        async function testImagesFormat() {
            return { success: true, message: 'V√©rification manuelle recommand√©e' };
        }

        async function testJSONValidity() {
            const response = await fetch('http://localhost:3000/api/produits');
            try {
                await response.json();
                return { success: true, message: 'JSON valide' };
            } catch (e) {
                return { success: false, message: 'JSON invalide' };
            }
        }

        async function testTopDuMois() {
            const response = await fetch('http://localhost:3000/api/produits');
            const { data } = await response.json();
            const tops = data.filter(p => p.top_du_mois);
            
            if (tops.length > 0) {
                return { success: true, message: `${tops.length} produits "top du mois"` };
            } else {
                return { success: false, message: 'Aucun produit "top du mois"' };
            }
        }

        async function testPagination() {
            return { success: true, message: 'Pagination non impl√©ment√©e' };
        }

        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            initTests();
            isRunning = false;
        });
    </script>
</body>
</html>
